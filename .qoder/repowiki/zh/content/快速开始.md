# 快速开始

<cite>
**本文档中引用的文件**  
- [cli.ts](file://packages/create-weapp-vite/src/cli.ts)
- [createProject.ts](file://@weapp-core/init/src/createProject.ts)
- [viteConfig.ts](file://@weapp-core/init/src/viteConfig.ts)
- [weapp-vite.js](file://packages/weapp-vite/bin/weapp-vite.js)
- [cli.ts](file://packages/weapp-vite/src/cli.ts)
- [projectConfig.ts](file://@weapp-core/init/src/projectConfig.ts)
- [packageJson.ts](file://@weapp-core/init/src/packageJson.ts)
- [config.ts](file://packages/weapp-vite/src/config.ts)
- [serve.ts](file://packages/weapp-vite/src/cli/commands/serve.ts)
- [build.ts](file://packages/weapp-vite/src/cli/commands/build.ts)
- [enums.ts](file://@weapp-core/init/src/enums.ts)
- [constants.ts](file://packages/weapp-vite/src/constants.ts)
- [fs.ts](file://@weapp-core/init/src/utils/fs.ts)
- [state.ts](file://@weapp-core/init/src/state.ts)
</cite>

## 目录
1. [项目初始化](#项目初始化)
2. [开发模式启动流程](#开发模式启动流程)
3. [生产环境构建流程](#生产环境构建流程)
4. [配置文件加载机制](#配置文件加载机制)
5. [完整工作流示例](#完整工作流示例)
6. [viteConfig.ts 默认配置生成逻辑](#viteconfigts-默认配置生成逻辑)

## 项目初始化

`pnpm create weapp-vite` 命令是 weapp-vite 项目的初始化入口，其工作原理基于 `@weapp-core/init` 包中的 `createProject.ts` 实现。该命令通过 `create-weapp-vite` 包的 CLI 接口调用 `createProject` 函数来创建新项目。

初始化过程首先通过 `@inquirer/prompts` 提供交互式界面，让用户选择目标目录和模板类型。支持的模板包括默认模板、Tailwindcss 集成模板、Vant 模板和 TDesign 模板。这些模板定义在 `enums.ts` 文件中的 `TemplateName` 枚举中。

`createProject` 函数的核心逻辑是将选定模板目录（位于 `@weapp-core/init/templates/` 下）复制到目标目录。在复制完成后，系统会读取模板中的 `package.json` 文件，并根据当前 `weapp-vite` 的版本号更新依赖版本。如果模板中没有 `package.json`，则会创建一个包含基本配置的默认文件。

项目创建过程中还会处理 `.gitignore` 文件的规范化，确保使用 `.gitignore` 而非 `gitignore` 作为文件名。同时，`updateGitIgnore` 函数会自动更新 git 忽略规则，确保构建产物被正确忽略。

**Section sources**
- [cli.ts](file://packages/create-weapp-vite/src/cli.ts#L1-L58)
- [createProject.ts](file://@weapp-core/init/src/createProject.ts#L1-L91)
- [enums.ts](file://@weapp-core/init/src/enums.ts#L1-L7)

## 开发模式启动流程

开发模式通过执行 `weapp-vite dev` 命令启动，其执行流程由 `packages/weapp-vite/src/cli.ts` 中的 CLI 配置和 `serve.ts` 命令处理器共同控制。

命令行解析使用 `cac` 库实现，支持多种选项如 `--config` 指定配置文件、`--base` 设置基础路径、`--logLevel` 控制日志级别等。`registerServeCommand` 函数注册了 `dev` 命令，负责启动开发服务器。

启动流程首先检查运行时环境，确保 Node.js 版本满足要求（最低 20.19.0）。然后创建 Vite 开发服务器实例，加载项目配置。配置加载遵循优先级顺序：命令行参数 > 配置文件 > 默认值。

开发服务器启动后，会监听源代码文件的变化，支持热更新功能。服务器会将源代码转换为小程序可识别的格式，并在指定端口提供服务，方便开发者在微信开发者工具中预览。

**Section sources**
- [cli.ts](file://packages/weapp-vite/src/cli.ts#L1-L50)
- [serve.ts](file://packages/weapp-vite/src/cli/commands/serve.ts)
- [constants.ts](file://packages/weapp-vite/src/constants.ts#L1-L30)

## 生产环境构建流程

生产环境构建通过 `weapp-vite build` 命令执行，其逻辑实现在 `build.ts` 文件中。构建流程是项目从源代码到可发布产物的转换过程。

`registerBuildCommand` 函数注册了构建命令，支持配置输出目录、基础路径等选项。构建过程首先解析项目配置，然后初始化构建上下文。系统会读取 `project.config.json` 文件，如果不存在则创建默认配置。

构建流程包括代码转换、资源优化、依赖打包等多个阶段。`createOrUpdateProjectConfig` 函数确保项目配置文件的完整性，自动添加必要的设置如 `packNpmManually` 和 `packNpmRelationList`。构建产物会被输出到指定目录（默认为 `dist/`），并生成符合小程序要求的文件结构。

构建过程中还会处理 TypeScript 编译、CSS 预处理、JSON 文件处理等任务，确保最终产物的正确性和性能。

**Section sources**
- [build.ts](file://packages/weapp-vite/src/cli/commands/build.ts)
- [projectConfig.ts](file://@weapp-core/init/src/projectConfig.ts#L1-L128)
- [constants.ts](file://packages/weapp-vite/src/constants.ts#L1-L30)

## 配置文件加载机制

weapp-vite 的配置系统基于 Vite 的配置机制扩展而来，通过 `config.ts` 文件中的 `defineConfig` 函数提供类型支持。配置文件可以是 `vite.config.ts`、`vite.config.js` 等多种格式。

配置加载遵循以下优先级：命令行参数 > 配置文件 > 默认配置。系统支持多种配置文件扩展名，包括 `json`、`jsonc`、`ts`、`js` 等。`configExtensions` 常量定义了支持的配置文件格式。

`readJsonIfExists` 工具函数用于安全地读取 JSON 配置文件，当文件不存在时返回 null 而非抛出错误。`writeJsonFile` 函数则用于写入配置文件，支持格式化输出。

项目配置（`project.config.json`）和包配置（`package.json`）的创建与更新由专门的函数处理。`createOrUpdateProjectConfig` 和 `createOrUpdatePackageJson` 函数提供了统一的接口来管理这些配置文件，确保配置的一致性和完整性。

**Section sources**
- [config.ts](file://packages/weapp-vite/src/config.ts#L1-L29)
- [projectConfig.ts](file://@weapp-core/init/src/projectConfig.ts#L1-L128)
- [packageJson.ts](file://@weapp-core/init/src/packageJson.ts#L1-L104)
- [fs.ts](file://@weapp-core/init/src/utils/fs.ts#L1-L60)

## 完整工作流示例

从项目创建到运行的完整工作流如下：

1. 执行 `pnpm create weapp-vite my-app` 创建新项目
2. 选择模板类型（默认、Tailwindcss、Vant 或 TDesign）
3. 进入项目目录 `cd my-app`
4. 安装依赖 `pnpm install`
5. 启动开发服务器 `pnpm dev`
6. 在微信开发者工具中打开项目
7. 开发完成后执行 `pnpm build` 构建生产版本

此工作流展示了 weapp-vite 从初始化到开发再到构建的完整生命周期。每个步骤都有相应的命令和配置支持，确保开发体验的流畅性。

**Section sources**
- [cli.ts](file://packages/create-weapp-vite/src/cli.ts#L1-L58)
- [createProject.ts](file://@weapp-core/init/src/createProject.ts#L1-L91)
- [cli.ts](file://packages/weapp-vite/src/cli.ts#L1-L50)

## viteConfig.ts 默认配置生成逻辑

`viteConfig.ts` 文件中的 `getDefaultViteConfig` 函数负责生成默认的 Vite 配置。该函数返回一个模板字符串，包含基本的配置结构。

默认配置使用 `defineConfig` 函数包裹，确保类型安全。配置对象包含 `weapp` 字段，用于指定 weapp-vite 特有的选项。这个配置结构与 Vite 的标准配置兼容，同时扩展了小程序特有的功能。

配置生成逻辑简单而有效，提供了一个清晰的起点。开发者可以直接在此基础上添加自定义配置，如路径别名、插件配置、构建选项等。这种设计既保证了开箱即用的便利性，又保留了足够的灵活性。

**Section sources**
- [viteConfig.ts](file://@weapp-core/init/src/viteConfig.ts#L1-L11)
- [config.ts](file://packages/weapp-vite/src/config.ts#L1-L29)
- [state.ts](file://@weapp-core/init/src/state.ts#L1-L15)