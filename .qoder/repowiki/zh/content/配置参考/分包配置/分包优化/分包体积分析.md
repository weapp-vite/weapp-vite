# 分包体积分析

<cite>
**本文档引用文件**  
- [analyze.ts](file://packages/weapp-vite/src/cli/commands/analyze.ts)
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts)
- [dashboard.ts](file://packages/weapp-vite/src/cli/analyze/dashboard.ts)
- [useTreemapData.ts](file://packages/weapp-vite/analyze-dashboard/useTreemapData.ts)
- [App.vue](file://packages/weapp-vite/analyze-dashboard/App.vue)
- [mock-data.ts](file://packages/weapp-vite/analyze-dashboard/mock-data.ts)
- [build-analyze-dashboard.mjs](file://packages/weapp-vite/scripts/build-analyze-dashboard.mjs)
</cite>

## 目录
1. [功能概述](#功能概述)
2. [使用analyze命令](#使用analyze命令)
3. [treemap可视化界面](#treemap可视化界面)
4. [识别体积过大的子包和冗余依赖](#识别体积过大的子包和冗余依赖)
5. [实际案例演示](#实际案例演示)

## 功能概述

weapp-vite提供的分包体积分析功能旨在帮助开发者深入了解小程序的包体结构，通过可视化方式展示主包、分包与源码模块之间的映射关系。该功能能够识别跨包复用的源码模块，帮助优化分包结构，减少包体积。

分包分析功能的核心是通过构建过程收集包体信息，包括主包、分包、独立分包以及共享虚拟包的文件和模块信息。分析结果以JSON格式呈现，并通过treemap可视化界面展示，便于开发者直观地查看包体结构和模块分布。

**Section sources**
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L1-L601)
- [analyze.ts](file://packages/weapp-vite/src/cli/commands/analyze.ts#L1-L136)

## 使用analyze命令

analyze命令是weapp-vite提供的分包分析工具，用于生成分包依赖图和体积报告。该命令通过收集构建过程中的包体信息，生成详细的分析结果。

### 基本用法

```bash
weapp-vite analyze
```

该命令会分析当前项目，生成分包依赖图和体积报告，并启动一个本地服务器展示treemap可视化界面。

### 命令行参数

analyze命令支持以下参数：

- `--json`：输出JSON格式的分析结果到标准输出
- `--output <file>`：将分析结果写入指定文件（JSON格式）
- `-p, --platform <platform>`：指定目标平台（weapp | h5），目前仅支持小程序平台
- `[root]`：指定项目根目录，默认为当前目录

### 操作步骤

1. 确保项目已正确配置分包信息
2. 在项目根目录执行`weapp-vite analyze`命令
3. 等待分析完成，查看命令行输出的分析摘要
4. 浏览器会自动打开treemap可视化界面，或根据提示访问本地服务器地址

### 分析结果解读

分析结果包含以下主要信息：

- **包体数量**：主包、分包、独立分包和共享虚拟包的总数
- **源码模块**：项目中所有源码模块的总数
- **跨包复用**：被多个包引用的源码模块数量
- **分包配置**：各分包的根目录、别名和独立构建状态

当存在跨包复用的源码模块时，分析结果会列出前10个复用最多的模块，其余模块可通过`--json`参数查看完整列表。

**Section sources**
- [analyze.ts](file://packages/weapp-vite/src/cli/commands/analyze.ts#L76-L136)
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L52-L56)

## treemap可视化界面

treemap可视化界面是分包体积分析功能的核心展示方式，通过矩形树图直观地展示包体结构和模块分布。

### 界面布局

treemap界面包含以下主要区域：

- **头部信息**：显示包体数量、源码模块数、跨包复用数和总字节数
- **treemap图表**：以不同颜色和大小的矩形展示各个包和模块
- **详细信息面板**：显示选中模块的详细信息

### 颜色编码

treemap使用不同的颜色区分不同类型的包：

- **主包**：深蓝色
- **分包**：深绿色
- **独立分包**：深橙色
- **共享虚拟包**：深紫色

### 交互功能

treemap支持以下交互功能：

- **悬停**：悬停在矩形上显示模块的详细信息，包括源文件路径、大小和所属包
- **点击**：点击矩形可以钻取到更详细的层级
- **缩放**：支持缩放查看特定区域的细节
- **搜索**：支持按模块名称搜索

### 数据展示

treemap以层级结构展示数据：

1. **第一层**：各个包（主包、分包、独立分包、共享虚拟包）
2. **第二层**：包内的文件（JS模块、资源文件）
3. **第三层**：文件内的源码模块

矩形的大小代表模块的体积，颜色代表模块的类型，位置代表模块的层级关系。

**Section sources**
- [App.vue](file://packages/weapp-vite/analyze-dashboard/App.vue#L1-L102)
- [useTreemapData.ts](file://packages/weapp-vite/analyze-dashboard/useTreemapData.ts#L1-L265)
- [mock-data.ts](file://packages/weapp-vite/analyze-dashboard/mock-data.ts#L1-L294)

## 识别体积过大的子包和冗余依赖

分包体积分析功能提供了多种方式帮助开发者识别体积过大的子包和冗余依赖。

### 识别体积过大的子包

通过treemap可视化界面，可以直观地识别体积过大的子包：

1. **观察矩形大小**：体积较大的子包在treemap中占据较大的面积
2. **查看包体摘要**：分析结果会显示每个包的模块数量、资源数量和覆盖的源码模块数量
3. **比较包体大小**：通过比较不同包的大小，识别异常大的包

### 识别冗余依赖

分包分析功能可以识别以下类型的冗余依赖：

- **跨包复用的源码模块**：被多个包引用的源码模块
- **重复的第三方库**：在多个包中重复引入的第三方库
- **未使用的依赖**：在包中引入但未使用的模块

分析结果会列出跨包复用的源码模块，包括模块的源文件路径、类型和在各个包中的引用情况。对于重复的第三方库，可以通过比较不同包中引入的库版本和大小来识别。

### 优化建议

根据分析结果，可以采取以下优化措施：

- **提取公共模块**：将跨包复用的源码模块提取到共享虚拟包中
- **按需引入**：对于第三方库，采用按需引入的方式减少包体积
- **代码分割**：对体积过大的子包进行进一步的代码分割
- **移除未使用依赖**：清理项目中未使用的依赖

**Section sources**
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L1-L601)
- [analyze.ts](file://packages/weapp-vite/src/cli/commands/analyze.ts#L14-L74)

## 实际案例演示

以下是一个实际案例，演示如何根据分包分析结果优化分包结构，减少包体积。

### 案例背景

假设有一个小程序项目，包含主包和两个分包（shop和profile）。经过初步开发，发现主包体积较大，且shop和profile分包中存在重复的代码。

### 分析过程

1. 执行`weapp-vite analyze`命令，生成分析结果
2. 查看treemap可视化界面，发现主包、shop分包和profile分包都引用了`common-header`组件和`request`工具函数
3. 分析结果显示，`common-header`组件和`request`工具函数被三个包复用

### 优化方案

根据分析结果，采取以下优化措施：

1. **创建共享虚拟包**：将`common-header`组件和`request`工具函数提取到共享虚拟包中
2. **修改分包配置**：在`app.json`中配置共享虚拟包
3. **更新代码引用**：修改各包中的代码，从共享虚拟包中引入`common-header`组件和`request`工具函数

### 优化效果

优化后，重新执行分包分析，发现：

- 主包体积减少了约30%
- shop分包和profile分包体积分别减少了约25%
- 跨包复用的源码模块数量从3个减少到1个（共享虚拟包本身）

通过分包体积分析功能，成功识别并解决了包体冗余问题，显著减少了小程序的包体积。

**Section sources**
- [mock-data.ts](file://packages/weapp-vite/analyze-dashboard/mock-data.ts#L1-L294)
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L539-L601)
- [dashboard.ts](file://packages/weapp-vite/src/cli/analyze/dashboard.ts#L88-L173)