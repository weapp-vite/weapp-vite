# 分包配置

<cite>
**本文档中引用的文件**  
- [app.json](file://apps/subpackage-shared-chunks/src/app.json)
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts)
- [app.json](file://apps/wevu-runtime-demo/src/app.json)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
- [subpackages.md](file://docs/subpackages.md)
- [subpackages.md](file://website/config/subpackages.md)
- [json.ts](file://@weapp-core/schematics/scripts/json.ts)
- [weappConfig.ts](file://packages/weapp-vite/src/utils/weappConfig.ts)
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts)
- [core.ts](file://packages/weapp-vite/src/plugins/core.ts)
</cite>

## 目录
1. [引言](#引言)
2. [分包配置结构](#分包配置结构)
3. [主包与子包定义](#主包与子包定义)
4. [subpackages 配置项详解](#subpackages-配置项详解)
5. [资源分配策略](#资源分配策略)
6. [加载优化配置](#加载优化配置)
7. [实际案例分析](#实际案例分析)
8. [构建输出与性能影响](#构建输出与性能影响)
9. [性能优化建议](#性能优化建议)
10. [最佳实践总结](#最佳实践总结)

## 引言

在大型微信小程序项目中，合理使用分包功能是提升首屏加载速度和控制包体大小的关键策略。weapp-vite 提供了强大的分包支持，允许开发者通过灵活的配置实现高效的分包架构。本文档将详细介绍 weapp-vite 对小程序分包功能的支持，包括分包配置的结构和语法、资源分配策略、加载优化配置以及性能优化建议，帮助开发者设计出高效的分包架构。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L1-L151)

## 分包配置结构

weapp-vite 的分包配置主要通过 `app.json` 文件中的 `subpackages` 字段和 `vite.config.ts` 中的 `weapp.subPackages` 配置项来实现。`app.json` 文件定义了小程序的基本分包结构，而 `vite.config.ts` 则提供了更高级的编译选项，如依赖裁剪、样式共享等。

分包配置的核心是 `subpackages` 数组，每个元素代表一个分包，包含 `root`、`pages`、`independent` 等关键属性。`root` 指定分包的根目录，`pages` 定义分包内的页面路径，`independent` 标记是否为独立分包。

**Section sources**
- [json.ts](file://@weapp-core/schematics/scripts/json.ts#L84-L92)
- [subpackages.md](file://website/config/subpackages.md#L1-L112)

## 主包与子包定义

主包是小程序启动时默认加载的部分，应尽量保持最小化，只包含必要的页面和基座逻辑。子包则用于承载具体的业务模块，通过按需加载的方式减少初始加载时间。

在 `app.json` 中，主包的页面通过 `pages` 字段定义，而子包通过 `subpackages` 字段定义。每个子包都有一个独立的根目录（`root`），该目录下的页面路径相对于此根目录。

```json
{
  "pages": [
    "pages/index/index"
  ],
  "subpackages": [
    {
      "root": "packages/order",
      "name": "订单中心",
      "pages": ["index", "detail"]
    }
  ]
}
```

**Section sources**
- [app.json](file://apps/subpackage-shared-chunks/src/app.json#L1-L40)
- [subpackages.md](file://docs/subpackages.md#L27-L66)

## subpackages 配置项详解

### root

`root` 属性指定分包的根目录，所有页面路径都相对于此目录。建议以业务边界命名分包根目录，如 `packages/order`、`packages/profile`，便于团队协作和权限划分。

### pages

`pages` 属性定义分包内的页面路径数组。文件名不需要写后缀，框架会自动寻找对应的 `.json`、`.js`、`.wxml`、`.wxss` 四个文件进行处理。

### independent

`independent` 属性标记分包是否为独立分包。独立分包运行在独立上下文中，无法直接访问主包的全局数据，但可以拥有自己的 `node_modules` 依赖，适合需要自定义 TabBar 或插件能力的模块。

### name

`name` 属性为分包提供一个可读的名称，主要用于开发者工具中的显示。

### entry

`entry` 属性指定分包的入口文件，通常用于独立分包的初始化逻辑。

**Section sources**
- [json.ts](file://@weapp-core/schematics/scripts/json.ts#L84-L92)
- [public/app.json](file://website/public/app.json#L210-L263)

## 资源分配策略

weapp-vite 通过 `weapp.subPackages` 配置项提供了精细的资源分配策略。开发者可以为每个分包单独配置依赖、样式和自动导入组件。

### 依赖裁剪

通过 `dependencies` 字段，可以精确控制分包需要的 `miniprogram_npm` 依赖，避免主包依赖泄漏到分包中。支持字符串和正则表达式匹配。

```ts
subPackages: {
  'packages/order': {
    dependencies: ['crypto-es'],
  }
}
```

### 样式共享

`styles` 字段支持复用共享样式文件，并按需限定注入范围。支持 `.wxss`、`.css`、`.scss/.sass`、`.less`、`.styl(us)` 等格式，构建后会转换为目标平台样式后缀。

```ts
subPackages: {
  'packages/order': {
    styles: [
      'styles/theme.scss',
      {
        source: '../shared/styles/components.scss',
        scope: 'components',
        include: ['components/**'],
      },
    ],
  }
}
```

### 自动导入组件

`autoImportComponents` 字段允许为分包单独配置组件自动导入策略，避免与主包策略冲突。

**Section sources**
- [subpackages.md](file://website/config/subpackages.md#L7-L112)
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L1-L83)

## 加载优化配置

### 分包预下载

通过 `preloadRule` 配置项，可以在特定页面加载时预下载其他分包，提升用户体验。预下载规则包括触发页、目标分包、网络条件和超时时间。

```json
"preloadRule": {
  "pages/index/index": {
    "packages": ["packages/profile"],
    "network": "all",
    "timeout": 2000
  }
}
```

### 分包异步化

启用 `lazyCodeLoading: "requiredComponents"` 可以实现分包的异步化加载，避免一次性加载所有自定义组件代码，降低首包体积和首次渲染开销。

### 动态引入

在代码中使用 `import()` 动态引入模块时，构建器会生成独立 chunk，结合 `chunks.sharedStrategy` 可避免重复落地。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L24-L25)
- [app.json](file://apps/subpackage-shared-chunks/src/app.json#L24-L30)

## 实际案例分析

### 案例一：电商小程序

一个典型的电商小程序可能包含首页、商品详情、购物车、订单中心和个人中心等模块。可以将这些模块拆分为不同的分包：

- 主包：包含首页和基础组件
- 商品分包：包含商品详情和搜索功能
- 购物车分包：包含购物车和结算功能
- 订单分包：作为独立分包，包含订单管理和支付功能
- 个人中心分包：包含用户信息和设置功能

```json
{
  "pages": ["pages/index/index"],
  "subpackages": [
    {
      "root": "packages/product",
      "name": "商品",
      "pages": ["detail", "search"]
    },
    {
      "root": "packages/cart",
      "name": "购物车",
      "pages": ["index", "checkout"]
    },
    {
      "root": "packages/order",
      "name": "订单中心",
      "pages": ["index", "detail"],
      "independent": true
    },
    {
      "root": "packages/profile",
      "name": "个人中心",
      "pages": ["index", "settings"]
    }
  ],
  "preloadRule": {
    "pages/index/index": {
      "packages": ["packages/profile"],
      "network": "all",
      "timeout": 2000
    }
  }
}
```

### 案例二：内容型小程序

对于内容型小程序，如新闻或博客，可以按内容类别拆分分包：

- 主包：包含首页和导航
- 新闻分包：包含新闻列表和详情
- 视频分包：包含视频播放和推荐
- 用户分包：包含用户评论和收藏

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L27-L66)
- [app.json](file://apps/subpackage-shared-chunks/src/app.json#L1-L40)

## 构建输出与性能影响

分包配置直接影响构建输出和运行时性能。合理的分包策略可以显著减少主包体积，提升首屏加载速度。weapp-vite 提供了 `analyze` 命令，可以生成分包报告，帮助开发者定位共享依赖和重复模块。

```json
"scripts": {
  "analyze": "weapp-vite analyze"
}
```

执行 `pnpm run analyze` 后，可以查看每个分包的产物结构和共享模块，优化资源分配。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L139-L142)
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L60-L63)

## 性能优化建议

1. **保持主包最小化**：只保留必要页面和基座逻辑，其余业务模块放入分包。
2. **评估独立性**：需要自定义 TabBar 或插件能力的模块优先考虑独立分包。
3. **同步规划代码共享**：公共工具、样式、国际化资源放在主包或公共目录，由构建器负责复制或抽取。
4. **配合运营节奏预下载**：首屏后立即可能访问的分包通过 `preloadRule` 预加载。
5. **利用异步化能力**：启用 `lazyCodeLoading` 与按需注册组件，让非首屏模块按需拉取。
6. **监控包体积**：定期检查微信开发者工具的包体积面板，确保主包 < 2MB、单个分包 < 2MB，所有分包合计 < 20MB。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L18-L25)
- [subpackages.md](file://docs/subpackages.md#L137-L142)

## 最佳实践总结

合理规划分包并结合 weapp-vite 的构建能力，可以在保证首屏体验的同时降低维护成本。关键实践包括：

- 以业务边界拆分分包，便于团队协作。
- 使用独立分包处理高敏业务，如支付。
- 通过 `preloadRule` 预加载高频访问的分包。
- 利用 `weapp.subPackages` 进行精细的资源管理和样式共享。
- 定期使用 `analyze` 命令分析产物，优化分包结构。

遇到复杂场景时，优先使用 CLI 分析产物，再针对性调整 `app.json` 与 `vite.config.ts` 配置。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L144-L150)
- [subpackages.md](file://website/config/subpackages.md#L109-L112)