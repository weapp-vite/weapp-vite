# 独立分包

<cite>
**本文档中引用的文件**  
- [subpackages.md](file://docs/subpackages.md)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
- [app.json](file://packages/weapp-vite/test/fixtures/independent-subpackage/src/app.json)
- [independent-subpackage.ts](file://apps/vite-native/subpackage-demos/independent-subpackage.ts)
- [buildPlugin.ts](file://packages/weapp-vite/src/runtime/buildPlugin.ts)
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts)
- [independent-subpackage.test.ts](file://packages/weapp-vite/test/independent-subpackage.test.ts)
</cite>

## 目录
1. [引言](#引言)
2. [独立分包的概念与适用场景](#独立分包的概念与适用场景)
3. [配置方法与independent配置项详解](#配置方法与independent配置项详解)
4. [对小程序启动流程和资源加载的影响](#对小程序启动流程和资源加载的影响)
5. [配置示例与功能实现](#配置示例与功能实现)
6. [构建优化策略与性能考量](#构建优化策略与性能考量)
7. [总结](#总结)

## 引言

本文档全面介绍weapp-vite对独立分包的支持和配置方法。通过分析项目中的相关文档和代码，详细说明如何通过配置文件将某个子包设置为独立分包，并解释其对小程序启动流程和资源加载的影响。同时，提供配置示例，展示独立分包如何实现从任意页面直接启动，以及如何在独立分包中包含必要的公共资源。最后，讨论独立分包的构建优化策略和性能考量。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L1-L151)

## 独立分包的概念与适用场景

独立分包是微信小程序的一种特殊分包类型，它拥有独立的运行上下文，不依赖于主包的全局数据和依赖。这种设计使得独立分包可以独立运行，甚至可以从任意页面直接启动，而不需要先加载主包。独立分包适用于需要自定义TabBar、插件能力或明显跨团队交付的模块。

独立分包的主要特点包括：
- **独立运行上下文**：独立分包无法直接访问主包的全局数据。
- **独立依赖管理**：每个独立分包都有自己的`miniprogram_npm`依赖，防止主包依赖泄漏到独立分包。
- **灵活的启动方式**：支持从任意页面直接启动，提升用户体验。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L119-L124)

## 配置方法与independent配置项详解

在weapp-vite中，可以通过`app.json`文件和`vite.config.ts`文件来配置独立分包。具体步骤如下：

1. **在`app.json`中定义分包**：使用`subPackages`字段定义分包，并设置`independent: true`以标记该分包为独立分包。
2. **在`vite.config.ts`中进行高级配置**：通过`weapp.subPackages`字段为每个分包追加独立编译、依赖裁剪、样式共享等高级能力。

例如，在`app.json`中定义一个独立分包：
```json
{
  "subPackages": [
    {
      "root": "packages/order",
      "name": "订单中心",
      "pages": ["index", "detail"],
      "independent": true
    }
  ]
}
```

在`vite.config.ts`中进一步配置该分包：
```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packages/order': {
        independent: true,
        dependencies: [/^@order\//, 'dayjs'],
        inlineConfig: {
          define: { 'import.meta.env.ORDER_SCOPE': 'true' },
        },
        styles: [
          'styles/theme.scss',
          {
            source: '../shared/styles/components.scss',
            scope: 'components',
            include: ['components/**'],
          },
        ],
      },
    },
  },
})
```

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L77-L108)
- [vite.config.ts](file://apps/vite-native/vite.config.ts#L89-L100)

## 对小程序启动流程和资源加载的影响

独立分包的引入对小程序的启动流程和资源加载产生了显著影响：

1. **启动流程**：由于独立分包拥有独立的运行上下文，用户可以直接从任意页面启动小程序，而无需先加载主包。这大大提升了启动速度和用户体验。
2. **资源加载**：独立分包的资源加载更加高效，因为每个分包只加载自身所需的资源，避免了主包资源的冗余加载。此外，通过`preloadRule`预加载关键分包，可以进一步优化资源加载性能。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L117-L135)

## 配置示例与功能实现

以下是一个完整的配置示例，展示了如何在weapp-vite中实现独立分包的功能：

### 从任意页面直接启动

通过设置`independent: true`，独立分包可以从任意页面直接启动。例如，在`app.json`中定义一个独立分包：
```json
{
  "subPackages": [
    {
      "root": "packageB",
      "name": "独立分包",
      "pages": ["pages/dead-end/index"],
      "independent": true
    }
  ]
}
```

### 包含必要的公共资源

在独立分包中包含必要的公共资源，可以通过`styles`字段注入公共主题文件。例如，在`vite.config.ts`中配置：
```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packageB': {
        styles: [
          'styles/common.wxss',
          {
            source: 'styles/pages.css',
            scope: 'pages',
          },
        ],
      },
    },
  },
})
```

**Section sources**
- [app.json](file://packages/weapp-vite/test/fixtures/independent-subpackage/src/app.json#L5-L13)
- [independent-subpackage.ts](file://apps/vite-native/subpackage-demos/independent-subpackage.ts#L1-L3)

## 构建优化策略与性能考量

为了优化独立分包的构建过程和性能，weapp-vite提供了多种策略：

1. **依赖裁剪**：通过`dependencies`字段精确控制`miniprogram_npm`产物，防止主包依赖泄漏到独立分包。
2. **样式共享**：通过`styles`字段注入公共样式文件，并按需限定注入范围。
3. **分包预加载**：在`app.json`的`preloadRule`中声明触发页、目标分包、网络条件与超时时间，提前拉取关键分包。
4. **分包异步化**：启用`lazyCodeLoading: "requiredComponents"`，避免一次性加载所有自定义组件代码，降低首包体积与首次渲染开销。

这些策略共同作用，确保了独立分包在保持高性能的同时，也具备良好的可维护性和扩展性。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L139-L143)
- [buildPlugin.ts](file://packages/weapp-vite/src/runtime/buildPlugin.ts#L59-L105)
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L539-L600)

## 总结

weapp-vite通过`weapp.subPackages`提供了灵活的分包编译选项，涵盖了独立分包、依赖裁剪、样式共享等常见需求。合理规划分包并结合weapp-vite的构建能力，可以在保证首屏体验的同时降低维护成本。遇到复杂场景时，优先使用CLI分析产物，再针对性调整`app.json`与`vite.config.ts`配置。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L149-L151)