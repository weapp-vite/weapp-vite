# 路径映射配置

<cite>
**本文档引用文件**  
- [alias.ts](file://packages/weapp-vite/src/runtime/config/internal/alias.ts)
- [config.ts](file://packages/weapp-vite/src/types/config.ts)
- [loadConfig.ts](file://packages/weapp-vite/src/runtime/config/internal/loadConfig.ts)
- [alias.md](file://website/guide/alias.md)
- [json.md](file://website/config/json.md)
- [js.md](file://website/config/js.md)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
</cite>

## 目录
1. [简介](#简介)
2. [路径映射功能概述](#路径映射功能概述)
3. [JS/TS 路径映射](#jsts-路径映射)
4. [JSON/JSONC 路径映射](#jsonjsonc-路径映射)
5. [配置格式与模式匹配](#配置格式与模式匹配)
6. [基础路径设置](#基础路径设置)
7. [构建工具与IDE集成](#构建工具与ide集成)
8. [兼容性问题与解决方案](#兼容性问题与解决方案)
9. [最佳实践](#最佳实践)
10. [总结](#总结)

## 简介

路径映射配置是weapp-vite中用于简化模块引用的重要功能。通过路径映射，开发者可以避免复杂的相对路径引用，提高代码的可读性和维护性。本文档将全面介绍weapp-vite中路径映射的配置方法、使用场景和最佳实践。

**Section sources**
- [alias.md](file://website/guide/alias.md#alias)

## 路径映射功能概述

weapp-vite同时支持JS/TS别名和JSON/JSONC别名，允许在不同语言中使用一致的路径前缀。这一功能特别适用于大型项目，可以统一业务组件和工具方法的导入路径，避免深层级的`../../`引用。

路径映射的主要优势包括：
- 统一业务组件、工具方法的导入路径，避免深层级的`../../`。
- 让JSON配置和TypeScript源码共享同一套别名，减少路径维护成本。
- 按团队约定快速切换不同的路径前缀（如`@components/*`、`@shared/*`）。

设置完成后，Vite Dev Server与小程序产物都会自动进行路径转换，无需在不同环境下手动调整。

**Section sources**
- [alias.md](file://website/guide/alias.md#适用场景)

## JS/TS 路径映射

在weapp-vite项目中，JS/TS路径映射通过`tsconfig.json`或`jsconfig.json`中的`baseUrl`和`paths`配置实现。项目默认启用了`vite-tsconfig-paths`插件，因此只需在配置文件中设置相应的路径映射即可。

### 配置方法

在`tsconfig.json`中配置`baseUrl`和`paths`：

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  }
}
```

配置完成后，可以在代码中使用别名：

```ts
import utils from '@/utils'
```

### 高级配置

对于更复杂的项目结构，可以通过`weapp.tsconfigPaths`配置项进行微调：

```ts
import { defineConfig } from 'weapp-vite/config'
import type { PluginOptions } from 'vite-tsconfig-paths'

const tsconfigOptions: PluginOptions = {
  projects: ['./tsconfig.base.json'],
  extensions: ['.ts', '.js'],
  exclude: ['**/__tests__/**'],
}

export default defineConfig({
  weapp: {
    tsconfigPaths: tsconfigOptions,
  },
})
```

**Section sources**
- [alias.md](file://website/guide/alias.md#jsts-别名)
- [js.md](file://website/config/js.md#weapp-tsconfigpaths)

## JSON/JSONC 路径映射

weapp-vite对JSON配置文件进行了增强，支持在JSON/JSONC中使用别名映射。这对于组织大型项目中的组件引用特别有用。

### 配置方法

在`vite.config.ts`中配置`weapp.jsonAlias.entries`：

```ts
import type { UserConfig } from 'weapp-vite/config'
import path from 'node:path'

export default <UserConfig>{
  weapp: {
    jsonAlias: {
      entries: [
        {
          find: '@',
          replacement: path.resolve(__dirname, 'components'),
        },
      ],
    },
  },
}
```

### 使用示例

配置完成后，可以在JSON文件中直接使用别名：

```json
{
  "usingComponents": {
    "navigation-bar": "@/navigation-bar/navigation-bar",
    "ice-avatar": "@/avatar/avatar"
  }
}
```

构建时会自动转换为相对路径：

```json
{
  "usingComponents": {
    "navigation-bar": "../../components/navigation-bar/navigation-bar",
    "ice-avatar": "../../components/avatar/avatar"
  }
}
```

**Section sources**
- [alias.md](file://website/guide/alias.md#json-别名)
- [json.md](file://website/config/json.md#weapp-jsonalias)

## 配置格式与模式匹配

路径映射支持多种配置格式和模式匹配规则，可以满足不同场景的需求。

### 配置格式

路径映射支持两种配置格式：
1. 对象格式：`{ [find: string]: string }`
2. 数组格式：`readonly Alias[]`

```ts
// 对象格式
entries: {
  '@': path.resolve(__dirname, 'components'),
  '@shared': path.resolve(__dirname, 'shared')
}

// 数组格式
entries: [
  {
    find: '@',
    replacement: path.resolve(__dirname, 'components')
  },
  {
    find: '@shared',
    replacement: path.resolve(__dirname, 'shared')
  }
]
```

### 模式匹配

路径映射支持字符串和正则表达式匹配，可以实现更灵活的路径转换。

```ts
entries: [
  { 
    find: '@/components/', 
    replacement: path.resolve(__dirname, 'src/components/') 
  },
  { 
    find: /^@icons\//, 
    replacement: path.resolve(__dirname, 'src/assets/icons/') 
  }
]
```

正则表达式匹配允许使用捕获组，实现更复杂的路径转换逻辑。

**Section sources**
- [config.ts](file://packages/weapp-vite/src/types/config.ts#AliasOptions)
- [json.md](file://website/config/json.md#weapp-jsonalias)

## 基础路径设置

基础路径设置是路径映射的核心，决定了别名的解析方式和范围。

### srcRoot 配置

`weapp.srcRoot`用于指定项目源码的根目录，默认值为'.'。当`app.json`不在仓库根目录时，可以通过此配置指定源码目录。

```ts
export default defineConfig({
  weapp: {
    srcRoot: './miniprogram',
  },
})
```

### 绝对路径与相对路径

路径映射中的`replacement`建议使用绝对路径，以避免因工作目录变化导致解析失败。

```ts
// 推荐：使用绝对路径
replacement: path.resolve(__dirname, 'components')

// 不推荐：使用相对路径
replacement: './components'
```

### 多配置文件支持

对于Monorepo或多入口项目，可以通过`weapp.tsconfigPaths.projects`指定多个`tsconfig`文件：

```ts
weapp: {
  tsconfigPaths: {
    projects: ['./tsconfig.base.json', './packages/shared/tsconfig.json']
  }
}
```

**Section sources**
- [paths.md](file://website/config/paths.md#weapp-srcroot)
- [js.md](file://website/config/js.md#weapp-tsconfigpaths)

## 构建工具与IDE集成

路径映射需要与构建工具和IDE良好集成，以确保开发体验的一致性。

### Vite集成

weapp-vite内置了`vite-tsconfig-paths`插件，自动处理TS路径映射。构建时会根据`tsconfig.json`中的`paths`配置生成相应的别名映射。

```ts
// 自动启用 vite-tsconfig-paths
config.plugins.push(tsconfigPaths(config.weapp?.tsconfigPaths))
```

### IDE支持

大多数现代IDE（如VS Code）都支持TS路径映射，能够正确解析别名路径并提供智能提示。对于JSON中的别名，IDE可能会显示路径不存在的警告，但这不会影响构建结果。

### 构建流程

在构建流程中，路径映射会在以下阶段发挥作用：
1. 开发服务器启动时解析别名
2. 模块解析阶段转换路径
3. 产物生成阶段输出正确的相对路径

```ts
// 在loadConfig中处理别名
const aliasEntries = getAliasEntries(config.weapp?.jsonAlias)
```

**Section sources**
- [loadConfig.ts](file://packages/weapp-vite/src/runtime/config/internal/loadConfig.ts#L225)
- [js.md](file://website/config/js.md#与-vite-resolvealias-的关系)

## 兼容性问题与解决方案

在使用路径映射时可能会遇到一些兼容性问题，以下是常见问题及解决方案。

### 别名未生效

**问题**：修改`tsconfig`后别名未生效。

**解决方案**：重启`pnpm dev`进程，因为Rolldown需要重新读取`paths`配置。

### JSON中路径警告

**问题**：开发者工具提示JSON中路径不存在。

**解决方案**：这是正常现象，因为开发者工具不理解别名。编译产物仍会替换为真实路径。若想在IDE内消除警告，可借助自定义类型定义或在`usingComponents`上方写注释标记。

### 多tsconfig支持

**问题**：需要在Monorepo中使用多个`tsconfig`。

**解决方案**：在`vite.config.ts`中配置`weapp.tsconfigPaths.projects`指定额外的配置文件。

```ts
weapp: {
  tsconfigPaths: {
    projects: ['./tsconfig.base.json'],
  },
}
```

### 正则别名配置

**问题**：如何配置正则别名。

**解决方案**：使用RegExp对象进行匹配：

```ts
entries: [
  { 
    find: /^@icons\//, 
    replacement: path.resolve(__dirname, 'src/assets/icons/') 
  }
]
```

**Section sources**
- [alias.md](file://website/guide/alias.md#常见问题排查)
- [json.md](file://website/config/json.md#常见问题)

## 最佳实践

### 统一团队约定

建议团队统一路径前缀约定，如：
- `@/`：项目根目录
- `@components/`：业务组件
- `@shared/`：共享代码
- `@utils/`：工具函数

### 使用绝对路径

在`replacement`中始终使用绝对路径，避免相对路径带来的不确定性。

```ts
// 推荐
replacement: path.resolve(__dirname, 'components')

// 避免
replacement: './components'
```

### 合理组织配置

对于复杂项目，建议将路径映射配置集中管理：

```ts
// paths.config.ts
export const pathAliases = {
  '@': path.resolve(__dirname, 'src'),
  '@components': path.resolve(__dirname, 'src/components'),
  '@shared': path.resolve(__dirname, 'src/shared'),
  '@utils': path.resolve(__dirname, 'src/utils'),
}
```

### 逐步迁移

对于现有项目，建议逐步迁移路径引用，避免一次性修改导致大量冲突。

### 文档化

将路径映射约定文档化，方便新成员快速上手。

**Section sources**
- [alias.md](file://website/guide/alias.md#适用场景)
- [json.md](file://website/config/json.md#weapp-jsonalias)

## 总结

路径映射是weapp-vite中提升开发效率的重要功能。通过合理的配置和使用，可以显著改善大型项目中的模块引用体验。关键要点包括：

1. **统一配置**：JS/TS和JSON使用一致的路径前缀
2. **合理规划**：根据项目结构设计合理的路径映射方案
3. **团队协作**：建立统一的路径命名约定
4. **工具集成**：确保构建工具和IDE正确支持路径映射
5. **持续优化**：根据项目发展不断调整和优化路径映射配置

通过遵循这些最佳实践，可以充分发挥路径映射的优势，提高代码质量和开发效率。