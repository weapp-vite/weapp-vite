# 文件类型处理

<cite>
**本文档中引用的文件**  
- [jsonPlugin.ts](file://packages/weapp-vite/src/runtime/jsonPlugin.ts)
- [file.ts](file://packages/weapp-vite/src/utils/file.ts)
- [constants.ts](file://packages/weapp-vite/src/constants.ts)
- [loadEntry.ts](file://packages/weapp-vite/src/plugins/hooks/useLoadEntry/loadEntry.ts)
- [tsconfigJson.ts](file://@weapp-core/init/src/tsconfigJson.ts)
- [tsconfig.node.json](file://templates/weapp-vite-template/tsconfig.node.json)
- [tsconfig.app.json](file://@weapp-core/init/templates/default/tsconfig.app.json)
</cite>

## 目录
1. [简介](#简介)
2. [JS文件处理机制](#js文件处理机制)
3. [JSON文件处理机制](#json文件处理机制)
4. [文件类型配置与自定义](#文件类型配置与自定义)
5. [常见问题与解决方案](#常见问题与解决方案)
6. [最佳实践建议](#最佳实践建议)

## 简介

weapp-vite 是一个专为微信小程序开发优化的构建工具，它提供了对多种文件类型的智能处理机制。本文档详细介绍了 weapp-vite 对 js、json 等基础文件类型的处理方式，包括编译、转换、优化等核心功能。通过深入分析源码实现，我们将揭示如何通过配置来自定义不同文件类型的处理行为，帮助开发者提升开发效率和运行性能。

weapp-vite 的文件处理系统基于 Vite 构建，但针对小程序的特殊需求进行了深度定制。它不仅支持标准的 JavaScript 和 JSON 文件，还扩展了对 TypeScript、JSON with Comments（jsonc）、以及动态 JSON（json.ts/json.js）等格式的支持。系统通过插件机制实现了灵活的文件处理流程，允许开发者根据项目需求进行定制化配置。

**Section sources**
- [jsonPlugin.ts](file://packages/weapp-vite/src/runtime/jsonPlugin.ts#L1-L122)
- [file.ts](file://packages/weapp-vite/src/utils/file.ts#L44-L102)

## JS文件处理机制

weapp-vite 对 JS 文件的处理机制基于 Vite 的核心能力，并针对小程序环境进行了优化。系统支持标准的 JavaScript (.js) 和 TypeScript (.ts) 文件，并通过配置实现了语法支持、模块处理和兼容性配置。

### 语法支持与模块处理

weapp-vite 通过内置的编译器上下文和插件系统处理 JS 文件。在 `constants.ts` 文件中定义了支持的 JS 文件扩展名：

```typescript
export const jsExtensions = ['ts', 'js']
```

系统通过 `findJsEntry` 函数查找 JS 文件入口，该函数会尝试匹配所有支持的扩展名：

```typescript
export async function findJsEntry(filepath: string): Promise<{
  predictions: string[]
  path?: string
}> {
  const predictions = jsExtensions.map((ext) => {
    return changeFileExtension(filepath, ext)
  })
  for (const p of predictions) {
    if (await fs.exists(p)) {
      return {
        path: p,
        predictions,
      }
    }
  }
  return {
    predictions,
  }
}
```

### 兼容性配置

weapp-vite 通过 TypeScript 配置文件实现 JS 文件的兼容性配置。在项目初始化时，系统会生成 `tsconfig.app.json` 文件，其中包含了针对小程序环境的编译选项：

```json
{
  "compilerOptions": {
    "target": "ES2023",
    "lib": ["ES2023", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowJs": true,
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "isolatedModules": true,
    "strict": true
  }
}
```

这些配置确保了 JS 文件能够被正确编译和处理，同时保持与小程序运行环境的兼容性。

**Section sources**
- [constants.ts](file://packages/weapp-vite/src/constants.ts#L7-L8)
- [file.ts](file://packages/weapp-vite/src/utils/file.ts#L44-L62)
- [tsconfigJson.ts](file://@weapp-core/init/src/tsconfigJson.ts#L31-L70)

## JSON文件处理机制

weapp-vite 对 JSON 文件的处理机制是其核心特性之一，提供了强大的解析、加载和类型检查功能。系统不仅支持标准 JSON 格式，还扩展了对 JSON with Comments（jsonc）和动态 JSON（json.ts/json.js）的支持。

### JSON加载与解析

weapp-vite 通过 `JsonService` 类实现 JSON 文件的加载和解析。该服务提供了 `read` 和 `resolve` 方法，用于读取和解析 JSON 文件：

```typescript
export interface JsonService {
  read: (filepath: string) => Promise<any>
  resolve: (entry: JsonResolvableEntry) => string | undefined
  cache: FileCache<any>
}
```

`read` 方法实现了智能解析逻辑，能够处理不同类型的 JSON 文件：

```typescript
async function read(filepath: string) {
  // 检查缓存
  const invalid = await cache.isInvalidate(filepath)
  if (!invalid) {
    return cache.get(filepath)
  }
  
  // 处理 .json.ts 或 .json.js 文件
  if (/\.json\.[jt]s$/.test(filepath)) {
    const { mod } = await bundleRequire({
      filepath,
      cwd: ctx.configService.options.cwd,
      preserveTemporaryFile: true,
      require: customRequire,
      rolldownOptions: {
        input: {
          define: ctx.configService.defineImportMetaEnv,
        },
        output: {
          exports: 'named',
        },
      },
    })
    resultJson = typeof mod.default === 'function'
      ? await mod.default(ctx)
      : mod.default
  }
  else {
    // 处理标准 JSON 或 jsonc 文件
    resultJson = parseCommentJson(await fs.readFile(filepath, 'utf8'))
  }
  
  // 缓存结果
  cache.set(filepath, resultJson)
  return resultJson
}
```

### 类型检查与验证

weapp-vite 通过 TypeScript 配置实现 JSON 文件的类型检查。在 `tsconfig.app.json` 中，`resolveJsonModule` 选项被设置为 `true`，允许直接导入 JSON 文件：

```json
{
  "compilerOptions": {
    "resolveJsonModule": true,
    "types": ["miniprogram-api-typings"]
  }
}
```

此外，系统支持 `jsonc` 格式，允许在 JSON 文件中使用注释，提高了配置文件的可读性和可维护性。

**Section sources**
- [jsonPlugin.ts](file://packages/weapp-vite/src/runtime/jsonPlugin.ts#L13-L112)
- [constants.ts](file://packages/weapp-vite/src/constants.ts#L16-L21)
- [tsconfig.app.json](file://@weapp-core/init/templates/default/tsconfig.app.json#L52-L55)

## 文件类型配置与自定义

weapp-vite 提供了灵活的配置机制，允许开发者自定义不同文件类型的处理方式。通过配置文件和插件系统，可以实现编译、转换、优化等高级功能。

### 支持的文件类型

weapp-vite 支持多种文件类型，每种类型都有对应的处理机制：

| 文件类型 | 支持的扩展名 | 处理方式 |
|---------|------------|--------|
| JS/TS | .js, .ts | 标准编译和转换 |
| JSON | .json, .jsonc | 智能解析和缓存 |
| CSS | .css, .wxss, .scss, .less | 预处理和转换 |
| 模板 | .wxml, .html | 编译和优化 |

这些配置在 `constants.ts` 文件中定义：

```typescript
export const jsExtensions = ['ts', 'js']
export const configExtensions = ['jsonc', 'json', ...jsExtensions.map(x => `json.${x}`)]
export const supportedCssLangs = ['wxss', 'css', 'scss', 'less', 'sass', 'styl']
export const templateExtensions = ['wxml', 'html']
```

### 自定义处理配置

开发者可以通过 `vite.config.ts` 文件自定义文件处理配置。例如，可以配置别名、路径映射和自定义解析器：

```typescript
// 示例配置
export default defineConfig({
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
    }
  },
  plugins: [
    // 自定义插件
  ]
})
```

此外，weapp-vite 还支持通过 `tsconfig.json` 文件配置 TypeScript 编译选项，实现更精细的类型检查和编译控制。

**Section sources**
- [constants.ts](file://packages/weapp-vite/src/constants.ts#L7-L30)
- [tsconfig.node.json](file://templates/weapp-vite-template/tsconfig.node.json#L1-L33)

## 常见问题与解决方案

在使用 weapp-vite 处理文件类型时，开发者可能会遇到一些常见问题。以下是这些问题的解决方案：

### 语法错误

当 JSON 文件包含语法错误时，weapp-vite 会记录错误日志但不会中断构建过程：

```typescript
catch (error) {
  logger.error(`残破的JSON文件: ${filepath}`)
  debug?.(error)
}
```

**解决方案**：检查 JSON 文件的语法，确保格式正确。对于复杂的配置，建议使用 JSON Schema 进行验证。

### 类型不匹配

当导入的 JSON 文件类型与预期不匹配时，TypeScript 编译器会报错。

**解决方案**：确保 `tsconfig.json` 中的 `resolveJsonModule` 选项已启用，并在需要时为 JSON 文件创建类型声明文件。

### 加载失败

当文件路径错误或文件不存在时，文件加载会失败。

**解决方案**：使用 `findJsonEntry` 和 `findJsEntry` 等工具函数来查找文件，确保路径正确。同时，检查文件是否存在并具有正确的扩展名。

**Section sources**
- [jsonPlugin.ts](file://packages/weapp-vite/src/runtime/jsonPlugin.ts#L95-L98)
- [file.ts](file://packages/weapp-vite/src/utils/file.ts#L64-L81)

## 最佳实践建议

为了最大化 weapp-vite 的性能和开发体验，建议遵循以下最佳实践：

### 使用标准文件扩展名

始终使用标准的文件扩展名（.js, .ts, .json），避免使用非标准扩展名，以确保工具链的兼容性。

### 合理使用动态JSON

虽然 weapp-vite 支持 `.json.ts` 和 `.json.js` 文件，但这些动态 JSON 文件会导致热更新变慢。建议仅在必要时使用，对于静态配置优先使用标准 JSON 或 jsonc 格式。

### 优化TypeScript配置

合理配置 `tsconfig.json` 文件，启用必要的编译选项，同时禁用不必要的检查以提高编译速度：

```json
{
  "compilerOptions": {
    "strict": true,
    "noEmit": true,
    "skipLibCheck": true
  }
}
```

### 利用缓存机制

weapp-vite 内置了文件缓存机制，确保重复读取的文件不会被重复解析。开发者应确保文件变更时正确触发缓存更新。

**Section sources**
- [jsonPlugin.ts](file://packages/weapp-vite/src/runtime/jsonPlugin.ts#L33-L36)
- [tsconfigJson.ts](file://@weapp-core/init/src/tsconfigJson.ts#L65-L69)