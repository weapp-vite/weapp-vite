# 配置选项

<cite>
**本文档中引用的文件**  
- [config.ts](file://packages/weapp-vite/src/runtime/autoImport/config.ts)
- [service.ts](file://packages/weapp-vite/src/runtime/autoImport/service.ts)
- [types.ts](file://packages/weapp-vite/src/auto-import-components/resolvers/types.ts)
- [vite.config.ts](file://apps/weapp-vite-web-demo/vite.config.ts)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
- [auto-import-components.md](file://website/config/auto-import-components.md)
- [auto-import-components.json](file://apps/weapp-vite-web-demo/auto-import-components.json)
- [typed-components.d.ts](file://apps/weapp-vite-web-demo/typed-components.d.ts)
- [mini-program.html-data.json](file://apps/weapp-vite-web-demo/mini-program.html-data.json)
</cite>

## 目录
1. [简介](#简介)
2. [核心配置项详解](#核心配置项详解)
3. [globs 配置](#globs-配置)
4. [resolvers 配置](#resolvers-配置)
5. [dts 与类型生成](#dts-与类型生成)
6. [output 配置](#output-配置)
7. [实际配置示例](#实际配置示例)
8. [构建性能与类型生成影响](#构建性能与类型生成影响)
9. [配置优先级与继承关系](#配置优先级与继承关系)
10. [最佳实践与高级用法](#最佳实践与高级用法)

## 简介

weapp-vite 提供了强大的自动组件注册功能，通过 `autoImportComponents` 配置项实现组件的自动发现和注册。该功能允许开发者在 WXML 中直接使用组件标签，而无需手动在 JSON 文件中声明 `usingComponents`。系统会自动扫描指定目录下的组件，并生成相应的清单文件和类型声明，极大地提升了开发效率和 IDE 体验。

此配置系统支持灵活的目录扫描、自定义解析逻辑以及与第三方 UI 库的集成，为不同项目结构提供了高度可定制的解决方案。

**Section sources**
- [auto-import-components.md](file://website/config/auto-import-components.md#L1-L54)

## 核心配置项详解

`autoImportComponents` 配置项是 weapp-vite 自动组件注册的核心，它包含多个子配置项，共同控制组件的扫描、解析和类型生成行为。主要配置项包括 `globs`、`resolvers`、`output`、`typedComponents` 和 `htmlCustomData`。

这些配置项协同工作，实现了从组件发现到类型生成的完整流程。系统首先根据 `globs` 模式扫描组件目录，然后通过 `resolvers` 解析第三方组件库，最后生成 `auto-import-components.json` 清单文件以及可选的类型声明文件。

**Section sources**
- [config.ts](file://packages/weapp-vite/src/runtime/autoImport/config.ts#L5-L302)
- [service.ts](file://packages/weapp-vite/src/runtime/autoImport/service.ts#L1-L684)

## globs 配置

`globs` 配置项用于指定需要自动扫描的组件目录模式。它接受一个字符串数组，每个字符串都是一个 glob 模式，用于匹配组件文件路径。

默认情况下，系统会自动扫描主包的 `components/**/*.wxml` 目录以及所有分包中的 `components/**/*.wxml` 目录。开发者可以通过自定义 `globs` 配置来扩展或修改扫描范围。

```typescript
autoImportComponents: {
  globs: [
    'components/**/*.wxml',
    'widgets/**/*.wxml',
    'custom-components/**/*.{wxml,html}'
  ]
}
```

此配置会扫描 `components`、`widgets` 和 `custom-components` 目录下的所有 WXML 和 HTML 文件作为潜在的组件。系统要求匹配的文件必须同时存在对应的 JS/TS、JSON 文件，并且 JSON 文件中的 `component` 字段为 `true` 才会被识别为有效组件。

**Section sources**
- [config.ts](file://packages/weapp-vite/src/runtime/autoImport/config.ts#L121-L143)
- [service.ts](file://packages/weapp-vite/src/runtime/autoImport/service.ts#L554-L575)

## resolvers 配置

`resolvers` 配置项支持自定义解析逻辑，用于集成第三方 UI 库如 TDesign、Vant 等。它接受一个解析器函数数组，每个解析器负责将组件名称映射到对应的导入路径。

```typescript
autoImportComponents: {
  resolvers: [
    TDesignResolver(),
    VantResolver(),
    CustomResolver()
  ]
}
```

解析器实现了 `Resolver` 接口，该接口定义了一个函数签名和可选的 `components` 映射表：

```typescript
interface Resolver {
  (componentName: string, baseName: string): ResolvedValue | void
  components?: Record<string, string>
}
```

当在 WXML 中使用一个组件标签时，系统会依次调用每个解析器，直到找到匹配的组件。如果解析器返回一个 `ResolvedValue` 对象（包含 `name` 和 `from` 属性），则表示找到了对应的组件。

这种机制使得 weapp-vite 能够无缝集成各种 UI 库，开发者无需手动配置每个组件的导入路径。

**Section sources**
- [types.ts](file://packages/weapp-vite/src/auto-import-components/resolvers/types.ts#L1-L28)
- [service.ts](file://packages/weapp-vite/src/runtime/autoImport/service.ts#L77-L95)

## dts 与类型生成

`typedComponents` 配置项控制是否生成类型声明文件（`.d.ts`），为 TypeScript 项目提供类型支持。它可以设置为布尔值或字符串：

- `true`：生成 `typed-components.d.ts` 文件到项目根目录
- `false`：不生成类型声明文件
- 字符串：指定类型声明文件的输出路径

```typescript
autoImportComponents: {
  typedComponents: 'src/types/typed-components.d.ts'
}
```

系统会根据注册的所有组件（包括本地组件和通过 resolvers 解析的第三方组件）生成相应的类型声明。这些类型声明包含了组件的属性类型信息，使得在 TypeScript 中使用这些组件时可以获得完整的类型检查和智能提示。

类型生成过程会从组件的 JSON 文件和 JS/TS 文件中提取属性定义，并合并成完整的类型信息。这对于大型项目尤其重要，可以有效避免属性使用错误。

**Section sources**
- [config.ts](file://packages/weapp-vite/src/runtime/autoImport/config.ts#L226-L263)
- [service.ts](file://packages/weapp-vite/src/runtime/autoImport/service.ts#L184-L220)

## output 配置

`output` 配置项控制 `auto-import-components.json` 清单文件的生成行为。它可以设置为：

- `undefined`：生成默认的 `auto-import-components.json` 文件
- `false`：不生成清单文件
- 字符串：指定清单文件的输出路径

```typescript
autoImportComponents: {
  output: 'dist/auto-import-components.json'
}
```

生成的 `auto-import-components.json` 文件包含了所有可自动导入组件的映射关系，格式如下：

```json
{
  "MyComponent": "/src/components/MyComponent",
  "VantButton": "vant-weapp/button/index"
}
```

这个清单文件被 weapp-vite 内部使用，用于在编译时自动注入 `usingComponents` 配置。同时，它也可以被 IDE 读取以提供代码补全功能。

`htmlCustomData` 配置项则控制是否生成 `mini-program.html-data.json` 文件，该文件为 VS Code 和微信开发者工具提供 WXML 标签和属性的智能提示。

**Section sources**
- [config.ts](file://packages/weapp-vite/src/runtime/autoImport/config.ts#L218-L216)
- [service.ts](file://packages/weapp-vite/src/runtime/autoImport/service.ts#L291-L323)

## 实际配置示例

以下是一些典型的 `autoImportComponents` 配置示例，展示了在不同项目结构下的最佳实践：

### 基础配置
```typescript
// vite.config.ts
import { defineConfig } from 'weapp-vite/config'

export default defineConfig({
  weapp: {
    autoImportComponents: {
      globs: ['components/**/*.wxml'],
      typedComponents: true,
      htmlCustomData: 'mini-program.html-data.json'
    }
  }
})
```

### 集成第三方 UI 库
```typescript
import { defineConfig } from 'weapp-vite/config'
import { TDesignResolver, VantResolver } from 'weapp-vite/auto-import-components/resolvers'

export default defineConfig({
  weapp: {
    autoImportComponents: {
      globs: ['components/**/*.wxml'],
      resolvers: [
        VantResolver(),
        TDesignResolver()
      ],
      output: 'dist/auto-import-components.json',
      typedComponents: 'src/types/typed-components.d.ts'
    }
  }
})
```

### 分包项目配置
```typescript
export default defineConfig({
  weapp: {
    autoImportComponents: {
      globs: ['components/**/*.wxml']
    },
    subPackages: {
      'packageA': {
        autoImportComponents: {
          globs: ['packageA/components/**/*.wxml']
        }
      },
      'packageB': {
        autoImportComponents: false // 禁用分包B的自动导入
      }
    }
  }
})
```

**Section sources**
- [vite.config.ts](file://apps/weapp-vite-web-demo/vite.config.ts#L1-L31)
- [vite.config.ts](file://apps/vite-native/vite.config.ts#L81-L88)

## 构建性能与类型生成影响

`autoImportComponents` 配置对构建性能有一定影响，主要体现在以下几个方面：

1. **组件扫描开销**：系统需要遍历 `globs` 指定的所有文件路径来发现组件，文件数量越多，扫描时间越长。
2. **类型提取开销**：当启用 `typedComponents` 时，系统需要解析每个组件的 JS/TS 文件来提取属性类型，这会增加构建时间。
3. **文件写入开销**：生成 `auto-import-components.json`、`typed-components.d.ts` 等文件需要磁盘 I/O 操作。

为了优化性能，建议：
- 精确设置 `globs` 模式，避免扫描不必要的目录
- 在开发环境中启用类型生成以获得更好的开发体验，在生产构建中可考虑禁用
- 使用分包配置，只在需要的分包中启用自动导入

系统采用了缓存机制来减少重复计算，只有当组件发生变化时才会重新生成相关文件。

**Section sources**
- [service.ts](file://packages/weapp-vite/src/runtime/autoImport/service.ts#L328-L355)
- [service.ts](file://packages/weapp-vite/src/runtime/autoImport/service.ts#L357-L392)

## 配置优先级与继承关系

`autoImportComponents` 配置支持分层继承和优先级控制。配置的优先级顺序如下：

1. 分包特定配置优先于全局配置
2. 显式配置优先于默认配置
3. `false` 值具有最高优先级，可以完全禁用功能

当配置 `subPackages` 时，分包可以继承全局的 `autoImportComponents` 配置，也可以通过 `autoImportComponents` 字段进行覆盖：

```typescript
weapp: {
  autoImportComponents: { // 全局配置
    globs: ['components/**/*.wxml']
  },
  subPackages: {
    'packageA': {
      autoImportComponents: { // 分包A覆盖配置
        globs: ['packageA/components/**/*.wxml', 'shared/components/**/*.wxml']
      }
    },
    'packageB': {
      autoImportComponents: false // 分包B完全禁用
    }
  }
}
```

这种继承机制使得大型项目可以灵活地为不同分包配置不同的组件扫描策略，同时保持配置的一致性。

**Section sources**
- [config.ts](file://packages/weapp-vite/src/runtime/autoImport/config.ts#L166-L188)

## 最佳实践与高级用法

### 配置最佳实践
1. **合理设置扫描范围**：避免使用过于宽泛的 glob 模式，如 `**/*.wxml`，这会导致性能下降
2. **按需启用类型生成**：在开发环境中启用 `typedComponents` 以获得类型检查，在 CI/CD 流水线中可考虑禁用以提高构建速度
3. **利用分包配置**：在大型项目中，为不同分包配置不同的组件扫描策略

### 高级用法
1. **自定义解析器**：可以创建自定义解析器来支持私有 UI 库或特殊组件映射
2. **动态配置**：根据环境变量动态调整配置，如在开发环境中启用更多调试功能
3. **与生成工具集成**：与 `weapp-vite` 的生成工具配合使用，确保新创建的组件能被自动扫描到

通过合理配置 `autoImportComponents`，开发者可以显著提升小程序开发效率，减少重复性工作，同时保持代码的类型安全和可维护性。

**Section sources**
- [auto-import-components.md](file://website/config/auto-import-components.md#L1-L54)
- [config.ts](file://packages/weapp-vite/src/runtime/autoImport/config.ts#L145-L190)