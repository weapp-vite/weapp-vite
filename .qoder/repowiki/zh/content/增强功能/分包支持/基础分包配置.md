# 基础分包配置

<cite>
**本文档引用的文件**  
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts)
- [app.json](file://apps/subpackage-shared-chunks/src/app.json)
- [docs/subpackages.md](file://docs/subpackages.md)
- [website/guide/subpackage.md](file://website/guide/subpackage.md)
- [website/config/subpackages.md](file://website/config/subpackages.md)
</cite>

## 目录
1. [简介](#简介)
2. [分包配置基础](#分包配置基础)
3. [分包目录结构与页面路径](#分包目录结构与页面路径)
4. [vite.config.ts中的分包配置](#viteconfigts中的分包配置)
5. [分包加载机制与路由跳转](#分包加载机制与路由跳转)
6. [分包样式与资源引用规则](#分包样式与资源引用规则)
7. [分包类型：普通分包与独立分包](#分包类型普通分包与独立分包)
8. [分包构建优化与共享策略](#分包构建优化与共享策略)
9. [常见错误排查指南](#常见错误排查指南)
10. [配置模板与最佳实践](#配置模板与最佳实践)

## 简介

微信小程序的分包机制是优化应用性能、控制包体大小的关键技术。通过将应用拆分为多个独立的分包，可以实现按需加载，显著提升首屏启动速度。`weapp-vite` 框架对微信小程序的分包能力提供了完整的支持，并在此基础上增加了构建时的高级优化功能，如依赖裁剪、样式共享和自动组件导入等。

本文档旨在为开发者提供关于 `weapp-vite` 基础分包配置的详细指南，涵盖从 `vite.config.ts` 配置语法、分包目录结构、资源引用规则到分包加载机制和最佳实践的全方位内容。无论您是初学者还是有经验的开发者，都能从中获得清晰的配置指导和深入的原理理解。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#L1-L151)
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L1-L244)

## 分包配置基础

在 `weapp-vite` 项目中，分包的定义主要依赖于两个核心文件：`app.json` 和 `vite.config.ts`。

`app.json` 是微信小程序的全局配置文件，其中的 `subpackages` 或 `subPackages` 字段用于声明应用的分包结构。`weapp-vite` 直接读取此配置，无需引入额外的 DSL（领域特定语言），保持了与微信官方文档的一致性。

```json
{
  "subpackages": [
    {
      "root": "packages/order",
      "name": "订单中心",
      "pages": ["index", "detail"]
    },
    {
      "root": "packages/profile",
      "name": "个人中心",
      "pages": ["index", "settings"]
    }
  ]
}
```

在 `app.json` 中，每个分包对象包含以下关键参数：
- **root**: 分包的根目录路径，相对于项目源码根目录（由 `weapp.srcRoot` 指定）。
- **name**: 分包的可读名称，用于在开发者工具中显示。
- **pages**: 分包内包含的页面路径列表，路径相对于 `root` 目录，无需写文件后缀。
- **independent**: 布尔值，指定该分包是否为独立分包。独立分包拥有独立的运行上下文，与主包隔离。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#L35-L54)
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L19-L27)
- [website/config/subpackages.md](file://website/config/subpackages.md#L25-L26)

## 分包目录结构与页面路径

合理的分包目录结构是项目可维护性的基础。`weapp-vite` 遵循微信小程序的目录规范，并建议采用业务边界清晰的命名方式。

典型的分包目录结构如下：
```
src/
├── pages/                    # 主包页面
│   └── index/
├── packages/                 # 分包根目录
│   ├── order/                # 订单分包
│   │   ├── pages/            # 分包内的页面
│   │   │   ├── index/
│   │   │   └── detail/
│   │   ├── components/       # 分包内的组件
│   │   └── utils/            # 分包内的工具函数
│   └── profile/              # 个人中心分包
│       ├── pages/
│       │   ├── index/
│       │   └── settings/
│       └── components/
├── app.json                  # 全局配置
└── app.ts                    # 全局逻辑
```

**页面路径配置**：
在 `app.json` 的 `pages` 和 `subpackages.pages` 字段中，路径的写法遵循以下规则：
1.  路径是相对于其所在分包的 `root` 目录。
2.  路径中不包含文件后缀（如 `.ts`, `.wxml`）。
3.  主包的页面路径直接写在 `pages` 数组中。
4.  分包的页面路径写在对应分包对象的 `pages` 数组中。

例如，`packages/order/pages/index/index` 页面在 `app.json` 中的配置为 `"pages": ["index"]`，因为 `packages/order` 是其 `root`。

**Section sources**
- [apps/subpackage-shared-chunks/src/app.json](file://apps/subpackage-shared-chunks/src/app.json#L6-L22)
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L42-L51)

## vite.config.ts中的分包配置

`vite.config.ts` 是 `weapp-vite` 的构建配置文件，通过 `weapp.subPackages` 选项，可以为每个分包提供精细化的构建能力。

```ts
import { defineConfig } from 'weapp-vite/config'

export default defineConfig({
  weapp: {
    srcRoot: 'src',
    subPackages: {
      'packages/order': {
        independent: true,
        dependencies: [/^@order\//, 'dayjs'],
        styles: [
          'styles/theme.scss',
          {
            source: '../shared/styles/components.scss',
            scope: 'components',
            include: ['components/**'],
          },
        ],
      },
      'packages/profile': {
        styles: {
          source: 'styles/index.scss',
          scope: 'pages',
        },
      },
    },
  },
})
```

`weapp.subPackages` 是一个以分包 `root` 为键名的对象，其值包含以下可选配置：

**字段说明**:
- **independent**: 强制将分包编译为独立上下文，即使 `app.json` 中未声明。
- **dependencies**: 数组，包含字符串或正则表达式。用于精确控制该分包打包到 `miniprogram_npm` 的依赖列表，实现依赖裁剪，防止主包依赖泄漏。
- **inlineConfig**: 为该分包注入额外的 Vite/Rolldown 构建配置，如 `define` 宏定义。
- **autoImportComponents**: 为分包单独配置组件自动导入规则，避免与主包冲突。
- **styles**: 配置共享样式文件，构建器会自动将这些样式注入到分包的页面或组件中。

**Section sources**
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L32-L58)
- [website/config/subpackages.md](file://website/config/subpackages.md#L82-L92)

## 分包加载机制与路由跳转

理解分包的加载机制对于优化用户体验至关重要。

**加载流程**：
1.  小程序启动时，首先加载主包（包含 `app.js`, `app.json`, `app.wxss` 和主包页面）。
2.  当用户访问某个分包内的页面时，小程序客户端会动态下载并加载该分包。
3.  对于独立分包，其加载过程完全独立，拥有自己的 `App` 实例和 `miniprogram_npm` 依赖。

**路由跳转**：
在代码中跳转到分包页面与跳转到主包页面的 API 完全相同。使用 `wx.navigateTo` 或 `wx.redirectTo` 等 API，直接指定目标页面的完整路径即可。

```js
// 跳转到主包页面
wx.navigateTo({
  url: '/pages/index/index'
})

// 跳转到分包页面
wx.navigateTo({
  url: '/packages/order/pages/detail/index'
})
```

**最佳实践**：
- **预下载分包 (Preload)**：利用 `app.json` 中的 `preloadRule` 字段，可以在主包加载后，立即预下载用户可能访问的分包，缩短后续跳转的等待时间。
- **分包异步化 (Async)**：通过在 `app.json` 中设置 `"lazyCodeLoading": "requiredComponents"`，可以延迟加载非首屏的自定义组件，进一步优化首屏性能。

**Section sources**
- [apps/subpackage-shared-chunks/src/app.json](file://apps/subpackage-shared-chunks/src/app.json#L24-L29)
- [docs/subpackages.md](file://docs/subpackages.md#L55-L62)

## 分包样式与资源引用规则

分包的样式和资源引用遵循严格的隔离规则，但也提供了共享机制。

**引用规则**：
- **普通分包**：可以引用主包的资源（JS、WXML、WXSS、自定义组件），但不能引用其他分包的资源。
- **独立分包**：完全隔离，不能引用主包或其他分包的资源（`app.wxss` 无效），也不能定义自己的 `App`。

**样式共享**：
`weapp-vite` 提供了强大的样式共享功能，通过 `weapp.subPackages[].styles` 配置，可以将公共的样式文件（如主题变量、基础布局）自动注入到指定的分包中。

```ts
styles: [
  'styles/tokens.css', // 共享设计令牌
  { 
    source: 'styles/layout.wxss', 
    scope: 'pages' // 仅注入到页面
  }
]
```
构建器会处理这些配置，为分包生成对应的 `@import` 语句，开发者无需手动维护。

**资源引用**：
- 分包内部的资源引用使用相对路径。
- 引用主包资源时，可以使用绝对路径（以 `/` 开头）。
- 独立分包应避免引用主包资源，应将公共资源上移到主包或公共目录。

**Section sources**
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L160-L198)
- [docs/subpackages.md](file://docs/subpackages.md#L88-L95)

## 分包类型：普通分包与独立分包

`weapp-vite` 支持两种分包类型，它们在构建和运行时有显著差异。

**普通分包 (Regular Subpackage)**：
- **构建上下文**：与主包共享同一个 Rolldown 构建上下文。
- **资源共享**：可以复用主包的代码和资源。
- **构建产物**：共享的模块（如公共工具函数、第三方依赖）的落盘位置由 `weapp.chunks.sharedStrategy` 策略决定（`duplicate` 或 `hoist`）。
- **适用场景**：业务模块拆分，需要与主包共享数据和逻辑。

**独立分包 (Independent Subpackage)**：
- **构建上下文**：拥有独立的 Rolldown 构建上下文，独立编译。
- **资源共享**：完全隔离，不能直接访问主包或其他分包的内容。
- **构建产物**：会生成独立的 `miniprogram_npm` 目录，依赖由 `subPackages[].dependencies` 精确控制。
- **适用场景**：高敏感业务（如支付）、需要自定义 TabBar、或作为独立交付单元。

```ts
// 在 vite.config.ts 中配置独立分包
subPackages: {
  'packages/payment': {
    independent: true, // 标记为独立分包
    dependencies: ['crypto-es', 'buffer'] // 精确声明所需依赖
  }
}
```

**Section sources**
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L151-L158)
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L33-L35)

## 分包构建优化与共享策略

`weapp-vite` 提供了高级的构建优化选项，以精细控制分包的产物。

**共享策略 (sharedStrategy)**：
通过 `weapp.chunks.sharedStrategy` 配置，可以控制跨分包共享模块的落盘策略。
- **'duplicate' (默认)**: 共享模块会被复制到各个使用它的分包的 `__shared__/common.js` 中。优点是分包首次打开时无需回主包拉取，冷启动快；缺点是可能增加总包体积。
- **'hoist'**: 共享模块会被提升到主包的 `common.js` 中。优点是减少重复代码，控制总包体积；缺点是分包首次打开需要先加载主包的共享模块。

```ts
chunks: {
  sharedStrategy: 'duplicate',
  duplicateWarningBytes: 256 * 1024, // 当复制的共享模块超过256KB时发出警告
}
```

**分析产物布局**：
可以通过 `weapp-vite analyze` 命令分析分包的构建产物，帮助定位共享模块和优化包体。

```json
{
  "scripts": {
    "analyze": "weapp-vite analyze"
  }
}
```
执行 `pnpm run analyze` 后，可以查看每个分包包含的代码块和共享情况。

**Section sources**
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L60-L63)
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L207-L237)

## 常见错误排查指南

在配置分包时，可能会遇到一些常见问题：

**1. 构建报错：路径超出 `srcRoot` 或无法解析**
- **原因**：文件路径配置错误，或引用了其他分包的资源。
- **解决**：检查 `app.json` 中的 `root` 和 `pages` 路径是否正确，确保引用路径在允许范围内。

**2. 分包样式缺失**
- **原因**：`styles` 配置的文件路径不存在，或 `include/exclude` 规则不匹配。
- **解决**：确认共享样式文件的路径正确，并检查 `include` glob 模式是否能匹配到目标文件。

**3. 独立分包无法运行**
- **原因**：独立分包错误地引用了主包的资源或组件。
- **解决**：检查独立分包内的代码，确保所有依赖都已通过 `dependencies` 声明，或已将公共模块上移到主包。

**4. 包体积过大**
- **原因**：未使用 `dependencies` 进行依赖裁剪，导致主包的 `node_modules` 被复制到分包。
- **解决**：为独立分包配置 `subPackages[].dependencies`，只保留必需的依赖。

**5. 分包首次加载慢**
- **原因**：共享模块策略为 `hoist`，导致分包需要回主包加载。
- **解决**：将 `sharedStrategy` 改为 `duplicate`，或将高频使用的共享模块显式复制到分包。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#L137-L142)
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L240-L243)

## 配置模板与最佳实践

以下是 `weapp-vite` 分包配置的推荐模板和最佳实践总结。

**配置模板**：
```ts
// vite.config.ts
import { defineConfig } from 'weapp-vite/config'

export default defineConfig({
  weapp: {
    srcRoot: 'src',
    subPackages: {
      // 普通业务分包
      'packages/profile': {
        styles: ['styles/theme.scss'], // 共享主题
      },
      // 独立分包（如支付）
      'packages/payment': {
        independent: true,
        dependencies: ['crypto-es'], // 精确依赖
        styles: ['styles/payment-theme.scss'],
      },
    },
    chunks: {
      sharedStrategy: 'duplicate', // 优化冷启动
    },
  },
})
```

**最佳实践**：
1.  **主包最小化**：只保留首屏必要页面和核心逻辑。
2.  **业务边界拆分**：按功能模块划分分包，目录命名清晰。
3.  **合理使用独立分包**：仅对需要完全隔离的模块使用。
4.  **规划共享资源**：将公共工具、样式、组件上移到主包或公共目录。
5.  **启用预下载**：对高频访问的分包配置 `preloadRule`。
6.  **利用分析工具**：定期使用 `analyze` 命令检查包体结构。

遵循这些原则，可以构建出高性能、易维护的微信小程序应用。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#L144-L150)
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L32-L58)
- [apps/subpackage-shared-chunks/src/app.json](file://apps/subpackage-shared-chunks/src/app.json#L6-L22)