# 高级分包策略

<cite>
**本文档中引用的文件**  
- [docs/subpackages.md](file://docs/subpackages.md)
- [website/guide/subpackage.md](file://website/guide/subpackage.md)
- [website/config/subpackages.md](file://website/config/subpackages.md)
- [apps/vite-native/vite.config.ts](file://apps/vite-native/vite.config.ts)
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts)
- [packages/weapp-vite/src/analyze/subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts)
- [packages/weapp-vite/test/subpackage-dayjs.test.ts](file://packages/weapp-vite/test/subpackage-dayjs.test.ts)
</cite>

## 目录
1. [引言](#引言)
2. [分包配置与工作原理](#分包配置与工作原理)
3. [独立分包机制](#独立分包机制)
4. [分包预下载与预加载](#分包预下载与预加载)
5. [分包间共享模块与公共资源提取](#分包间共享模块与公共资源提取)
6. [代码分割与按需加载优化](#代码分割与按需加载优化)
7. [分包依赖分析与公共模块识别](#分包依赖分析与公共模块识别)
8. [性能调优建议与架构设计指导](#性能调优建议与架构设计指导)
9. [常见问题与解决方案](#常见问题与解决方案)

## 引言

微信小程序的高级分包策略是提升应用性能和用户体验的关键手段。通过合理规划主包与分包的结构，可以有效控制首包体积，实现按需加载和资源预取。`weapp-vite` 构建工具为分包提供了强大的支持，包括独立分包、预下载规则、样式共享、组件自动导入等高级功能。本文将深入探讨这些特性的实现原理和配置方法，帮助开发者在复杂场景下设计最优的分包策略。

## 分包配置与工作原理

`weapp-vite` 的分包能力基于微信官方的分包机制，并通过 `weapp.subPackages` 配置项提供精细化的控制。开发者可以直接在 `vite.config.ts` 中定义每个分包的编译选项，如独立上下文、依赖裁剪、样式共享等。

分包的核心工作原理在于构建阶段的模块分析与产物分发。当多个分包引用了相同的模块（如公共工具类或第三方库），构建器会根据 `chunks.sharedStrategy` 策略决定这些模块的落盘位置。默认的 `duplicate` 策略会将共享模块复制到各个分包的 `__shared__/common.js` 中，避免分包首次打开时回主包拉取；而 `hoist` 策略则会将共享模块统一提升到主包的 `common.js` 中，以减少整体包体冗余。

**Section sources**
- [website/guide/subpackage.md](file://website/guide/subpackage.md#普通分包)
- [docs/subpackages.md](file://docs/subpackages.md#示例：app.json 与 Vite 配置)

## 独立分包机制

独立分包是一种特殊的分包类型，它运行在独立的上下文中，与主包和其他分包完全隔离。这种隔离性使得独立分包可以拥有自己的 `App` 实例、自定义 TabBar 和插件能力，适用于需要独立交付或高安全性的业务模块。

在 `weapp-vite` 中，通过设置 `weapp.subPackages.<root>.independent = true` 可以将分包编译为独立上下文。由于独立分包无法直接访问主包的全局数据和资源，因此需要通过 `weapp.subPackages.<root>.dependencies` 精确控制其所需的 `miniprogram_npm` 依赖，防止主包依赖泄漏。此外，还可以通过 `inlineConfig` 为独立分包注入自定义的构建配置，如环境变量或插件。

**Section sources**
- [website/guide/subpackage.md](file://website/guide/subpackage.md#独立分包)
- [docs/subpackages.md](file://docs/subpackages.md#独立分包)

## 分包预下载与预加载

分包预下载是提升用户体验的重要手段，它允许在特定页面加载时提前下载其他分包的代码，从而缩短后续页面的打开时间。`weapp-vite` 支持通过 `app.json` 中的 `preloadRule` 字段配置预下载规则。

预下载规则需要指定触发页面、目标分包、网络条件和超时时间。通常，首页会作为触发页面，将用户可能访问的高频次屏分包加入预下载列表，并设置 `network: "all"` 以确保在 Wi-Fi 和蜂窝网络下都能预下载。对于更精细的控制，可以在页面的 `onLoad` 生命周期中调用 `wx.preloadSubpackage` API 进行二次确认。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#分包预加载)

## 分包间共享模块与公共资源提取

在多分包架构中，共享模块和公共资源的管理至关重要。`weapp-vite` 提供了 `weapp.subPackages[].styles` 配置项，用于实现跨分包的样式共享。通过声明一次主题变量或基础样式文件，构建器会自动将其注入到指定分包的页面和组件中。

对于 JavaScript 模块的共享，除了依赖 `chunks.sharedStrategy` 策略外，还可以通过 `weapp.subPackages[].dependencies` 显式声明分包所需的公共依赖。此外，`weapp-vite` 支持在分包根目录下创建 `index.*`、`pages.*` 或 `components.*` 文件作为共享入口，实现零配置的样式复用。

**Section sources**
- [website/guide/subpackage.md](file://website/guide/subpackage.md#分包样式共享)
- [website/config/subpackages.md](file://website/config/subpackages.md#subpackages-styles)

## 代码分割与按需加载优化

代码分割和按需加载是优化小程序性能的核心技术。`weapp-vite` 支持启用 `lazyCodeLoading: "requiredComponents"`，这可以避免一次性加载所有自定义组件的代码，而是按需加载。对于长链路页面，可以结合动态组件和 `Component` 的 `lifetimes` 钩子，在适当的时机延迟加载非关键模块。

在构建过程中，使用 `import()` 动态引入的模块会被生成为独立的 chunk。通过合理配置 `chunks.sharedStrategy`，可以避免这些动态模块在多个分包中重复落地，从而优化包体结构。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#分包异步化)

## 分包依赖分析与公共模块识别

为了优化分包策略，开发者需要清晰地了解各分包的依赖关系和共享模块的分布。`weapp-vite` 提供了 `weapp-vite analyze` 命令，可以生成详细的分包报告。该报告包含每个分包的产物结构、跨包复用的模块列表以及 `app.json` 中声明的分包状态。

通过分析报告，开发者可以定位到重复的模块和潜在的包体膨胀问题。例如，当 `duplicateWarningBytes` 阈值被超过时，构建日志会发出警告，提示需要调整分包划分或重新评估共享策略。此外，`forceDuplicatePatterns` 配置项可以强制某些目录下的模块始终被视为可复制的共享库，避免因伪主包引用而导致模块被错误地提升到主包。

**Section sources**
- [packages/weapp-vite/src/analyze/subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts)
- [docs/subpackages.md](file://docs/subpackages.md#调试与排查清单)

## 性能调优建议与架构设计指导

1. **保持主包最小化**：主包应仅包含首屏必要的页面和基座逻辑，其余业务模块应放入分包。
2. **以业务边界拆分分包**：分包的根目录应与业务域名一致，便于团队协作和权限管理。
3. **评估独立性**：需要自定义 TabBar 或插件能力的模块优先考虑使用独立分包。
4. **同步规划代码共享**：公共工具、样式和国际化资源应放在主包或公共目录，由构建器负责复制或抽取。
5. **配合运营节奏预下载**：将用户可能访问的高频次屏分包通过 `preloadRule` 预加载，缩短首次访问耗时。
6. **利用异步化能力**：启用 `lazyCodeLoading` 和按需注册组件，确保非首屏模块按需拉取。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#规划分包的通用原则)

## 常见问题与解决方案

- **本地运行时报路径错误？** 检查页面是否引用了其他分包的资源，或在 `weapp.chunks` 中启用了与项目不符的策略。
- **产物体积过大？** 使用 `weapp.subPackages[].dependencies` 精确声明每个独立分包需要的 npm 依赖，剩余依赖保持在主包。
- **想在分包中调试 Worker？** 记得同时在 `weapp.worker` 中声明入口，并确保 Worker 文件位于对应分包目录。
- **分包样式缺失？** 确认 `styles` 定义的文件是否存在，以及 `include` / `exclude` 是否匹配实际路径。
- **构建日志中出现 `[subpackages]` 警告？** 这些警告通常意味着路径超出 `srcRoot`、格式不受支持或重复注册，需要及时排查。

**Section sources**
- [website/guide/subpackage.md](file://website/guide/subpackage.md#常见问题)
- [docs/subpackages.md](file://docs/subpackages.md#调试与排查清单)