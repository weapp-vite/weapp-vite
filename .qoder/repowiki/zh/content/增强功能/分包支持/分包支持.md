# 分包支持

<cite>
**本文档中引用的文件**   
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts)
- [app.json](file://apps/subpackage-shared-chunks/src/app.json)
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts)
- [subpackage-demos/cross-subpackage-shared.ts](file://apps/vite-native/subpackage-demos/cross-subpackage-shared.ts)
- [subpackage-demos/independent-subpackage.ts](file://apps/vite-native/subpackage-demos/independent-subpackage.ts)
- [analyze/subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts)
</cite>

## 目录
1. [引言](#引言)
2. [分包配置与高级策略](#分包配置与高级策略)
3. [代码分割与共享模块管理](#代码分割与共享模块管理)
4. [性能优化与加载策略](#性能优化与加载策略)
5. [依赖分析与构建优化](#依赖分析与构建优化)
6. [实际配置示例](#实际配置示例)
7. [总结](#总结)

## 引言

weapp-vite 提供了强大的分包支持功能，旨在优化小程序的加载性能并减少主包体积。通过合理的分包策略，开发者可以将业务模块拆分到不同的分包中，从而实现按需加载和预加载，提升用户体验。本文档将深入探讨 weapp-vite 的分包功能，涵盖代码分割、共享模块管理、性能优化等方面，并提供详细的配置指南和最佳实践。

## 分包配置与高级策略

weapp-vite 的分包能力基于微信小程序的官方分包机制，并在此基础上提供了更高级的配置选项。开发者可以通过 `vite.config.ts` 文件中的 `weapp.subPackages` 配置项为每个分包追加独立编译、依赖裁剪、样式共享、组件自动导入等高级能力。

### 分包配置示例

以下是一个典型的 `vite.config.ts` 配置示例，展示了如何配置主包和分包：

```ts
// vite.config.ts
import { defineConfig } from 'weapp-vite/config'

export default defineConfig({
  weapp: {
    srcRoot: 'src',
    autoRoutes: true,
    subPackages: {
      'packages/order': {
        independent: true,
        dependencies: [/^@order\//, 'dayjs'],
        inlineConfig: {
          define: { 'import.meta.env.ORDER_SCOPE': 'true' },
        },
        autoImportComponents: {
          globs: ['packages/order/components/**/*.wxml'],
        },
        styles: [
          'styles/theme.scss',
          {
            source: '../shared/styles/components.scss',
            scope: 'components',
            include: ['components/**'],
          },
        ],
      },
      'packages/profile': {
        styles: {
          source: 'styles/index.scss',
          scope: 'pages',
        },
      },
    },
    chunks: {
      sharedStrategy: 'duplicate',
      duplicateWarningBytes: 256 * 1024,
    },
  },
})
```

**Section sources**
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L1-L83)

### 独立分包

独立分包是一种特殊的分包类型，它运行在独立的上下文中，无法直接访问主包的全局数据。通过设置 `independent: true`，可以将某个分包配置为独立分包。独立分包适用于需要自定义 TabBar、插件能力或明显跨团队交付的模块。

**Section sources**
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L34-L35)
- [subpackage-demos/independent-subpackage.ts](file://apps/vite-native/subpackage-demos/independent-subpackage.ts#L1-L4)

### 分包预下载

分包预下载功能允许开发者在用户访问某个页面时，提前下载其他分包，从而减少后续页面的加载时间。通过在 `app.json` 中的 `preloadRule` 字段中声明触发页、目标分包、网络条件和超时时间，可以实现分包的预下载。

```json
{
  "preloadRule": {
    "pages/index/index": {
      "packages": ["packages/profile"],
      "network": "all",
      "timeout": 2000
    }
  }
}
```

**Section sources**
- [app.json](file://apps/subpackage-shared-chunks/src/app.json#L24-L30)

## 代码分割与共享模块管理

weapp-vite 通过 `chunks.sharedStrategy` 配置项控制跨包共享模块的输出策略，避免主包和分包体积异常。默认情况下，共享模块会被复制到相关分包的 `__shared__/common.js` 中，以避免分包首次打开时再去拉取主包。如果希望统一提炼到主包，可以设置 `weapp.chunks.sharedStrategy = 'hoist'`。

### 共享模块策略

- **duplicate 策略**：共享模块会被复制到每个引用它的分包中，避免分包首次打开时再去拉取主包。
- **hoist 策略**：共享模块会被统一提炼到主包的 `common.js` 中，减少整体包体大小。

```ts
// vite.config.ts
export default defineConfig({
  weapp: {
    chunks: {
      sharedStrategy: 'duplicate',
      duplicateWarningBytes: 256 * 1024,
    },
  },
})
```

**Section sources**
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L60-L63)
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts#L86-L140)

### 跨分包共享模块

当多个分包共享同一个模块时，weapp-vite 会根据配置策略决定该模块的落点。如果某个共享模块或 `node_modules` 依赖同样被主包引用，则它会被提炼到主包下的 `common.js`。将 `sharedStrategy` 切换为 `duplicate` 时，上述跨分包共享模块（包括 `dayjs` 等第三方依赖）会复制回各自分包的 `weapp-shared/common.js`，以换取更低的冷启动开销。

```ts
// cross-subpackage-shared.ts
import chunk from 'lodash-es/chunk'

const sharedPets = ['cat', 'dog', 'parrot', 'hamster', 'alpaca', 'panda']

export function getCrossSharedMessage(scope: string) {
  const groups = chunk(sharedPets, 2)
  return `${scope} 看到 ${groups.length} 组共享数据：${groups.map(group => group.join('+')).join(' / ')}`
}
```

**Section sources**
- [cross-subpackage-shared.ts](file://apps/vite-native/subpackage-demos/cross-subpackage-shared.ts#L1-L21)
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts#L147-L159)

## 性能优化与加载策略

weapp-vite 提供了多种性能优化和加载策略，帮助开发者提升小程序的加载速度和用户体验。

### 分包异步化

启用 `lazyCodeLoading: "requiredComponents"` 可以避免一次性加载所有自定义组件代码（包含分包组件），从而降低首包体积和首次渲染开销。对长链路页面可结合动态组件、`Component` 的 `lifetimes` 中延迟 `require` 的模式，确保同一分包内部也按需执行。

```json
{
  "lazyCodeLoading": "requiredComponents"
}
```

**Section sources**
- [app.json](file://apps/subpackage-shared-chunks/src/app.json#L31)

### 预加载高频次屏

在首页 `preloadRule` 指向用户个人页，可以缩短首次访问个人中心的耗时。通过 `network`、`packages` 精细控制预加载条件，确保在合适的网络环境下提前下载关键分包。

```json
{
  "preloadRule": {
    "pages/index/index": {
      "packages": ["packages/profile"],
      "network": "all",
      "timeout": 2000
    }
  }
}
```

**Section sources**
- [app.json](file://apps/subpackage-shared-chunks/src/app.json#L24-L30)

## 依赖分析与构建优化

weapp-vite 提供了强大的依赖分析和构建优化功能，帮助开发者定位共享依赖和重复模块，优化构建过程。

### 依赖分析

通过执行 `pnpm run analyze` 脚本，可以生成分包报告，定位共享依赖和重复模块。该报告可以帮助开发者识别哪些模块被多个分包引用，从而决定是否需要将其提炼到主包或公共目录。

```json
{
  "scripts": {
    "analyze": "weapp-vite analyze"
  }
}
```

**Section sources**
- [analyze/subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L539-L600)

### 构建优化

weapp-vite 通过 `weapp.chunks.duplicateWarningBytes` 配置项设定冗余体积的提醒阈值，默认约为 `512 KB`。当复制出的共享模块体积超过该阈值时，构建日志会给出告警，便于开发者提前关注包体膨胀。

```ts
// vite.config.ts
export default defineConfig({
  weapp: {
    chunks: {
      sharedStrategy: 'duplicate',
      duplicateWarningBytes: 256 * 1024,
    },
  },
})
```

**Section sources**
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L62-L63)
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts#L150-L158)

## 实际配置示例

以下是一个完整的 `vite.config.ts` 配置示例，展示了如何配置主包和分包，支持独立分包和预下载分包等高级特性：

```ts
// vite.config.ts
import { defineConfig } from 'weapp-vite/config'

export default defineConfig({
  weapp: {
    srcRoot: 'src',
    autoRoutes: true,
    autoImportComponents: {
      globs: [
        'components/**/*.wxml',
        'shared/**/*.wxml',
      ],
      typedComponents: 'typed-components.d.ts',
      htmlCustomData: 'mini-program.html-data.json',
    },
    generate: {
      extensions: {
        js: 'ts',
        wxss: 'scss',
      },
      dirs: {
        component: 'src/components',
        page: 'src/pages',
      },
    },
    jsFormat: 'esm',
    npm: {
      enable: false,
    },
    subPackages: {
      'packages/order': {
        independent: true,
        dependencies: ['crypto-es'],
        autoImportComponents: {
          globs: [
            'packages/order/components/**/*.wxml',
          ],
        },
        styles: [
          'styles/theme.scss',
          {
            source: '../shared/styles/components.scss',
            scope: 'components',
            include: ['components/**'],
          },
        ],
      },
      'packages/profile': {
        styles: {
          source: 'styles/index.scss',
          scope: 'pages',
        },
      },
      'packages/marketing': {
        watchSharedStyles: false,
      },
    },
    chunks: {
      sharedStrategy: 'duplicate',
      duplicateWarningBytes: 256 * 1024,
    },
  },
  build: {
    rolldownOptions: {
      output: {
        minify: false,
      },
    },
  },
  css: {
    preprocessorOptions: {
      scss: {
        silenceDeprecations: ['legacy-js-api', 'import'],
      },
    },
  },
})
```

**Section sources**
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L1-L83)

## 总结

weapp-vite 的分包支持功能为开发者提供了强大的工具，帮助优化小程序的加载性能和减少主包体积。通过合理的分包策略、代码分割、共享模块管理和性能优化，开发者可以构建出高效、可维护的小程序应用。建议开发者根据项目需求，结合 `app.json` 和 `vite.config.ts` 配置文件，灵活运用 weapp-vite 的分包功能，提升用户体验。