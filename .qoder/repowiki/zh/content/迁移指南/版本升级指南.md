# 版本升级指南

<cite>
**本文档中引用的文件**  
- [v3.md](file://website/migration/v3.md)
- [v4.md](file://website/migration/v4.md)
- [v5.md](file://website/migration/v5.md)
- [vite.config.ts](file://@weapp-core/init/templates/default/vite.config.ts)
- [project.config.json](file://@weapp-core/init/templates/default/project.config.json)
- [package.json](file://package.json)
- [weapp-vite/package.json](file://packages/weapp-vite/package.json)
</cite>

## 目录
1. [引言](#引言)
2. [版本变更概览](#版本变更概览)
3. [v3 到 v4 升级指南](#v3-到-v4-升级指南)
4. [v4 到 v5 升级指南](#v4-到-v5-升级指南)
5. [升级验证步骤](#升级验证步骤)
6. [回滚方案](#回滚方案)
7. [总结](#总结)

## 引言
本指南旨在为开发者提供从 weapp-vite v3 和 v4 版本升级到最新版本的详细路径说明。我们将深入分析各版本之间的重大变更（breaking changes）、主要功能更新，并提供具体的迁移步骤、代码示例和验证方法，确保升级过程平稳顺利。

**Section sources**
- [v3.md](file://website/migration/v3.md)
- [v4.md](file://website/migration/v4.md)
- [v5.md](file://website/migration/v5.md)

## 版本变更概览
weapp-vite 的版本迭代带来了显著的性能提升和架构改进。从 v3 到 v4 主要集中在构建系统重构和配置结构优化，而 v4 到 v5 则实现了底层构建工具的全面升级，带来了革命性的性能改善。

### 重大变更列表
| 版本 | 重大变更 | 主要影响 |
|------|----------|----------|
| v3 → v4 | 构建核心重构、autoImportComponents.globs 路径基准变更、worker 编译方式变更 | 配置迁移、第三方模块引用方式调整 |
| v4 → v5 | 从 vite 切换到 rolldown-vite、从 tsup 切换到 tsdown、从 bundle-require 切换到 rolldown-require | 构建性能显著提升、依赖工具链变更 |

**Section sources**
- [v4.md](file://website/migration/v4.md)
- [v5.md](file://website/migration/v5.md)

## v3 到 v4 升级指南
本节详细介绍从 v3 版本升级到 v4 版本的具体步骤，重点关注构建系统的改进和配置结构的变化。

### 配置文件更新
v4 版本对配置结构进行了重要调整，特别是 `autoImportComponents.globs` 的路径基准发生了变化。

#### autoImportComponents.globs 路径变更
在 v3 版本中，`globs` 选项以当前工作目录（cwd）为基准路径，而在 v4 版本中，改为以 `srcRoot` 为基准路径。

```diff
enhance: {
  autoImportComponents: {
-   globs: ['src/components/**/*'],
+   globs: ['components/**/*.wxml'],
  },
}
```

**Section sources**
- [v4.md](file://website/migration/v4.md)
- [vite.config.ts](file://@weapp-core/init/templates/default/vite.config.ts)

### API 调用变更
v4 版本完全重构了编译核心，虽然 API 表面保持兼容，但内部实现发生了根本性变化。

#### Worker 编译方式变更
v4 版本放弃了使用 `ts-morph` 编译 worker 的实现，转而直接使用 vite 进行编译，这带来了显著的性能提升。

**Section sources**
- [v4.md](file://website/migration/v4.md)

### 废弃功能替换方案
v4 版本中，对 CJS/UMD 模块的处理方式发生了变化，需要开发者手动调整。

#### 第三方 CJS/UMD 模块引用
当需要引用外部的 CJS/UMD 模块时（如 visactor 的 index-wx-simple.min.js），需要将文件扩展名从 `.js` 重命名为 `.cjs`。

```ts
import VChart, { vglobal } from './vchart/index-wx-simple.min.cjs'
```

**Section sources**
- [v4.md](file://website/migration/v4.md)

## v4 到 v5 升级指南
本节详细描述从 v4 版本升级到 v5 版本的过程，重点介绍性能优化、新功能引入和兼容性调整。

### 构建系统升级
v5 版本最重大的变更是从 vite 切换到 rolldown-vite，这一改变带来了显著的性能提升。

#### 性能对比数据
根据官方测试数据，rolldown-vite 相比传统 vite 实现了：
- 整体平均构建时间提升约 1.86 倍
- 热更新平均构建时间提升约 2.50 倍

```text
vite 构建时间: 4302.26 ms (整体), 2216.58 ms (热更新)
rolldown-vite 构建时间: 2317.75 ms (整体), 887.56 ms (热更新)
```

**Section sources**
- [v5.md](file://website/migration/v5.md)

### 工具链变更
v5 版本全面更新了相关的构建工具链。

#### 从 tsup 切换到 tsdown
为了与 rolldown 生态保持一致，v5 版本从 tsup 切换到了 tsdown 作为构建工具。

#### 从 bundle-require 切换到 rolldown-require
新的 `rolldown-require` 包是基于 rolldown 构建的，虽然 API 和配置与之前的 bundle-require 相似，但内部实现完全不同。

**Section sources**
- [v5.md](file://website/migration/v5.md)
- [package.json](file://package.json)

### 兼容性调整
尽管 v5 版本进行了底层重构，但官方保证配置项完全一致，基本可以平滑升级。

#### 迁移成本评估
根据官方文档，v5 版本的迁移成本极低：
- 所有测试用例均已通过
- 配置项完全兼容
- 基本不需要进行配置变更即可升级

**Section sources**
- [v5.md](file://website/migration/v5.md)

## 升级验证步骤
完成版本升级后，需要进行一系列验证以确保升级成功。

### 构建验证
执行构建命令，检查是否能够成功生成 dist 目录。

```bash
pnpm build
```

### 开发服务器验证
启动开发服务器，检查热更新功能是否正常工作。

```bash
pnpm dev
```

### 功能完整性验证
1. 检查所有页面是否能够正常加载
2. 验证组件自动导入功能是否正常
3. 测试 worker 功能是否正常运行
4. 确认第三方依赖是否正确打包

**Section sources**
- [vite.config.ts](file://@weapp-core/init/templates/default/vite.config.ts)

## 回滚方案
如果升级过程中出现问题，可以按照以下步骤进行回滚。

### 依赖版本回滚
将 package.json 中的 weapp-vite 版本号改回之前的版本。

```json
{
  "dependencies": {
    "weapp-vite": "^4.x.x"
  }
}
```

### 配置文件恢复
恢复 v3 或 v4 版本的配置文件，特别是 `autoImportComponents.globs` 的路径配置。

### 重新安装依赖
执行依赖重新安装以确保所有依赖版本一致。

```bash
pnpm install
```

**Section sources**
- [package.json](file://package.json)
- [vite.config.ts](file://@weapp-core/init/templates/default/vite.config.ts)

## 总结
weapp-vite 的版本升级带来了显著的性能提升和开发体验改善。从 v3 到 v4 的升级主要涉及配置结构的调整，而 v4 到 v5 的升级则实现了构建性能的革命性突破。通过遵循本指南中的步骤，开发者可以顺利完成版本升级，享受更高效的开发体验。

**Section sources**
- [v3.md](file://website/migration/v3.md)
- [v4.md](file://website/migration/v4.md)
- [v5.md](file://website/migration/v5.md)