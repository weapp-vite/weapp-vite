# 迁移指南

<cite>
**本文档中引用的文件**  
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
- [vite.config.ts](file://apps/vite-native-ts/vite.config.ts)
- [vite.config.ts](file://templates/weapp-vite-template/vite.config.ts)
- [manual-integration.md](file://website/guide/manual-integration.md)
- [directory-structure.md](file://website/guide/directory-structure.md)
- [v3.md](file://website/migration/v3.md)
- [v4.md](file://website/migration/v4.md)
- [v5.md](file://website/migration/v5.md)
- [troubleshoot/index.md](file://website/troubleshoot/index.md)
- [weappConfig.ts](file://packages/weapp-vite/src/utils/weappConfig.ts)
- [config.ts](file://packages/weapp-vite/src/config.ts)
</cite>

## 目录

1. [从原生小程序迁移](#从原生小程序迁移)
2. [从其他构建工具迁移](#从其他构建工具迁移)
3. [版本升级指南](#版本升级指南)
   - [从 v3 升级到 v4](#从-v3-升级到-v4)
   - [从 v4 升级到 v5](#从-v4-升级到-v5)
4. [兼容性问题与解决方案](#兼容性问题与解决方案)
5. [迁移检查清单](#迁移检查清单)

## 从原生小程序迁移

将现有的原生微信小程序项目迁移到 weapp-vite 开发环境，需要进行配置转换、代码结构调整和构建流程变更。以下是详细的迁移步骤：

### 配置文件迁移

首先需要在项目根目录创建 `vite.config.ts` 文件，这是 weapp-vite 的核心配置文件。配置文件的基本结构如下：

```ts
import { defineConfig } from 'weapp-vite/config'

export default defineConfig({
  weapp: {
    srcRoot: 'src', // 源码根目录
    autoRoutes: true, // 自动路由
    chunks: {
      sharedStrategy: 'duplicate',
    },
  },
})
```

**重要变更**：
- `srcRoot` 配置项指定了源码的根目录，建议将原有项目文件移动到 `src/` 目录下
- 需要调整 `project.config.json` 中的 `miniprogramRoot` 指向构建输出目录（默认为 `dist/`）

### 项目结构调整

weapp-vite 推荐使用以下目录结构：

```
.
├─ vite.config.ts
├─ project.config.json
├─ typed-router.d.ts
├─ public/
└─ src/
   ├─ app.ts / app.json / app.scss
   ├─ pages/
   ├─ packages/
   ├─ components/
   ├─ shared/
   ├─ utils/
   └─ workers/
```

迁移时需要将原有项目中的 `app.*`、`pages/`、`components/` 等文件移动到 `src/` 目录下。

### 构建脚本配置

在 `package.json` 中添加必要的构建脚本：

```json
{
  "scripts": {
    "dev": "weapp-vite dev",
    "build": "weapp-vite build",
    "open": "weapp-vite open",
    "analyze": "weapp-vite analyze"
  }
}
```

**Section sources**
- [manual-integration.md](file://website/guide/manual-integration.md#2-初始化必需文件)
- [directory-structure.md](file://website/guide/directory-structure.md)

## 从其他构建工具迁移

### 从原生构建系统迁移

如果之前使用微信开发者工具的原生构建系统，迁移时需要注意以下几点：

1. **安装依赖**：需要安装 weapp-vite 及相关依赖
2. **配置转换**：将原有的构建配置转换为 weapp-vite 的配置格式
3. **构建流程变更**：从 IDE 内置构建切换到命令行构建

```bash
pnpm add -D weapp-vite vite typescript @types/node sass
```

### 从其他 Vite 插件迁移

如果之前使用其他 Vite 插件构建小程序，迁移时需要：

1. 移除原有插件依赖
2. 安装 weapp-vite
3. 调整配置文件结构

**重要提示**：weapp-vite 的配置结构与其他 Vite 插件有所不同，需要特别注意 `weapp` 配置项的层级结构。

**Section sources**
- [manual-integration.md](file://website/guide/manual-integration.md#1-安装依赖)
- [vite.config.ts](file://templates/weapp-vite-template/vite.config.ts)

## 版本升级指南

### 从 v3 升级到 v4

#### 重大变更

1. **autoImportComponents.globs 路径基准变更**：
   - 从以 `cwd` 为基准路径变更为以 `srcRoot` 为基准路径
   - 鼓励将所有资源放在 `srcRoot` 内部

```diff
enhance: {
  autoImportComponents: {
-   globs: ['src/components/**/*'],
+   globs: ['components/**/*.wxml'],
  },
}
```

2. **编译核心重构**：完全重构了编译核心，带来了更高效的处理速度和更强的扩展性
3. **Worker 编译方式变更**：放弃了使用 `ts-morph` 编译 `worker` 的实现，转为直接使用 `vite` 进行编译
4. **CommonJS 处理方式变更**：使用 `vite-plugin-commonjs` 替代 `@rollup/plugin-commonjs` 来处理项目中的 `require` 问题

**特别注意**：如果需要引用外部的 `cjs`/`umd` 模块，需要手动将文件扩展名从 `.js` 重命名为 `.cjs`。

**Section sources**
- [v4.md](file://website/migration/v4.md)

### 从 v4 升级到 v5

#### 重大变更

1. **从 `vite` 切换到 `rolldown-vite`**：
   - 为了解决热更新慢的问题
   - 性能提升显著：
     - 整体平均构建时间提升约 1.86 倍
     - 热更新平均构建时间提升约 2.50 倍

2. **从 `tsup` 切换到 `tsdown`**：
   - 均基于 `rolldown` 生态

3. **从 `bundle-require` 切换到 `rolldown-require`**：
   - 基于 `rolldown` 的新包
   - API 和配置参考了 `bundle-require`，但代码完全不同

#### 迁移成本

- 测试用例全部通过
- 配置项完全一致
- 基本不需要做配置变更即可平滑升级

**Section sources**
- [v5.md](file://website/migration/v5.md)

## 兼容性问题与解决方案

### 构建产物缺失问题

**症状**：`dist/` 目录中只有 `.wxml` 文件，缺失 `.js`、`.wxss`、`.json` 文件。

**解决方案**：
1. 检查 `app.json` 是否包含该页面路径
2. 检查组件是否位于 `usingComponents` 中，以及是否具备同名 `.json` 文件
3. 使用 `weapp.debug.watchFiles` 输出监听列表确认扫描情况

### require() 错误

**症状**：目录结构正确但仍报 `require()` 错误。

**解决方案**：
1. 在开发者工具中临时开启「将 JS 编译成 ES5」，触发重新编译
2. 关闭该选项并重启工具
3. 删除 `miniprogram_npm` 和 `dist` 目录后重新执行 `pnpm build`

### UMD/CJS 模块引入问题

**症状**：引入 UMD/CJS 模块时报错。

**解决方案**：
- 将文件重命名为 `.cjs` 扩展名
- 或在源码中显式使用 `require()`
- 示例：将 `index-wx-simple.min.js` 重命名为 `index-wx-simple.min.cjs`

### custom-tab-bar 不生效

**解决方案**：
1. 确保 `custom-tab-bar` 目录结构正确
2. 检查 `app.json` 中是否正确配置了 `custom-tab-bar` 相关设置
3. 清除开发者工具缓存后重新构建

**Section sources**
- [troubleshoot/index.md](file://website/troubleshoot/index.md)

## 迁移检查清单

为确保迁移过程顺利，建议按照以下清单逐步完成迁移：

### 基础配置检查
- [ ] 已安装 `weapp-vite` 及相关依赖
- [ ] 已创建 `vite.config.ts` 配置文件
- [ ] 已配置正确的 `srcRoot` 路径
- [ ] 已更新 `project.config.json` 中的 `miniprogramRoot`

### 项目结构检查
- [ ] 已将源码移动到 `src/` 目录
- [ ] 已建立推荐的目录结构
- [ ] 已确认 `app.*`、`pages/`、`components/` 等文件位置正确

### 构建流程检查
- [ ] 已添加必要的 npm scripts
- [ ] 已验证 `dev` 命令能正常启动开发服务器
- [ ] 已验证 `build` 命令能正常生成构建产物
- [ ] 已验证构建产物能在微信开发者工具中正常运行

### 功能验证检查
- [ ] 已验证页面路由正常
- [ ] 已验证组件自动导入功能正常
- [ ] 已验证分包功能正常
- [ ] 已验证 NPM 依赖正常工作
- [ ] 已验证 Worker 功能正常

### 性能优化检查
- [ ] 已配置适当的代码分割策略
- [ ] 已验证构建性能满足要求
- [ ] 已验证热更新响应速度满足要求

通过系统性地完成以上检查清单，可以确保从其他开发环境到 weapp-vite 的迁移过程顺利完成。

**Section sources**
- [manual-integration.md](file://website/guide/manual-integration.md)
- [directory-structure.md](file://website/guide/directory-structure.md)
- [v3.md](file://website/migration/v3.md)
- [v4.md](file://website/migration/v4.md)
- [v5.md](file://website/migration/v5.md)
- [troubleshoot/index.md](file://website/troubleshoot/index.md)