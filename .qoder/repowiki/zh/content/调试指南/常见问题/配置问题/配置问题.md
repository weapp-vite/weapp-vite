# 配置问题

<cite>
**本文档引用的文件**  
- [vite.config.ts](file://vite.config.ts)
- [vite.config.mts](file://vite.config.mts)
- [weapp-vite/config](file://packages/weapp-vite/src/config.ts)
- [weapp-vite/src/runtime/config/internal/merge.ts](file://packages/weapp-vite/src/runtime/config/internal/merge.ts)
- [weapp-vite/src/runtime/packageAliases.ts](file://packages/weapp-vite/src/runtime/packageAliases.ts)
- [weapp-vite/src/types/external.ts](file://packages/weapp-vite/src/types/external.ts)
- [weapp-vite/src/runtime/config/types.ts](file://packages/weapp-vite/src/runtime/config/types.ts)
- [weapp-vite/src/types.ts](file://packages/weapp-vite/src/types.ts)
- [weapp-vite/src/config.ts](file://packages/weapp-vite/src/config.ts)
- [website/guide/alias.md](file://website/guide/alias.md)
- [website/troubleshoot/index.md](file://website/troubleshoot/index.md)
- [apps/vite-native/vite.config.ts](file://apps/vite-native/vite.config.ts)
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts)
- [templates/weapp-vite-template/vite.config.ts](file://templates/weapp-vite-template/vite.config.ts)
- [packages/weapp-vite/test/fixtures/subPackages/vite.config.ts](file://packages/weapp-vite/test/fixtures/subPackages/vite.config.ts)
- [apps/tdesign-miniprogram-starter-retail/vite.config.ts](file://apps/tdesign-miniprogram-starter-retail/vite.config.ts)
</cite>

## 目录
1. [简介](#简介)
2. [别名配置](#别名配置)
3. [路径映射](#路径映射)
4. [分包配置](#分包配置)
5. [插件配置](#插件配置)
6. [配置文件加载优先级与环境变量覆盖](#配置文件加载优先级与环境变量覆盖)
7. [配置验证与调试技巧](#配置验证与调试技巧)
8. [配置文件模板与最佳实践](#配置文件模板与最佳实践)
9. [常见错误配置示例](#常见错误配置示例)
10. [总结](#总结)

## 简介

本文档旨在深入解析 `weapp-vite` 项目中 `vite.config.ts` 配置文件的正确使用方法，重点解决因配置不当导致的各种问题。通过分析项目结构和多个配置示例，我们将详细阐述别名配置、路径映射、分包配置和插件配置的最佳实践。同时，文档将提供常见错误配置的识别与修复方法，帮助开发者快速定位并解决配置问题。

**Section sources**
- [vite.config.ts](file://vite.config.ts)
- [website/guide/alias.md](file://website/guide/alias.md)

## 别名配置

在 `weapp-vite` 项目中，别名配置是通过 `vite.config.ts` 文件中的 `weapp.jsonAlias.entries` 选项来实现的。该配置允许开发者在 JSON 配置文件中使用别名映射，从而更好地组织大型项目。别名配置的语法与 Vite 的 `resolve.alias` 完全一致。

例如，在 `vite.config.ts` 中可以这样配置别名：

```ts
weapp: {
  jsonAlias: {
    entries: [
      {
        find: '@',
        replacement: path.resolve(__dirname, 'components'),
      },
    ],
  },
}
```

这样配置后，就可以在代码中使用 `@` 符号来引用 `components` 目录下的文件，如 `import utils from '@/utils'`。

**Section sources**
- [apps/vite-native/vite.config.ts](file://apps/vite-native/vite.config.ts)
- [website/guide/alias.md](file://website/guide/alias.md)

## 路径映射

路径映射是 `weapp-vite` 项目中另一个重要的配置项，它允许开发者在 `tsconfig.json` 文件中定义路径别名。这些别名可以在代码中使用，以简化模块导入路径。

在 `tsconfig.json` 文件中，可以通过 `compilerOptions.paths` 选项来定义路径映射。例如：

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "./src/*"
      ]
    }
  }
}
```

这样配置后，就可以在代码中使用 `@` 符号来引用 `src` 目录下的文件，如 `import utils from '@/utils'`。

**Section sources**
- [weapp-vite/src/runtime/packageAliases.ts](file://packages/weapp-vite/src/runtime/packageAliases.ts)
- [website/guide/alias.md](file://website/guide/alias.md)

## 分包配置

分包配置是 `weapp-vite` 项目中用于管理小程序分包的重要功能。通过 `vite.config.ts` 文件中的 `weapp.subPackages` 选项，可以定义分包的根目录、独立性、依赖项等。

例如，在 `vite.config.ts` 中可以这样配置分包：

```ts
weapp: {
  subPackages: {
    'packages/order': {
      independent: true,
      dependencies: ['crypto-es'],
      autoImportComponents: {
        globs: [
          'packages/order/components/**/*.wxml',
        ],
      },
      styles: [
        'styles/theme.scss',
        {
          source: '../shared/styles/components.scss',
          scope: 'components',
          include: ['components/**'],
        },
      ],
    },
    'packages/profile': {
      styles: {
        source: 'styles/index.scss',
        scope: 'pages',
      },
    },
    'packages/marketing': {
      watchSharedStyles: false,
    },
  },
}
```

这种配置方式允许开发者为每个分包定义独立的样式、组件和依赖项，从而实现更灵活的项目结构。

**Section sources**
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts)
- [packages/weapp-vite/test/fixtures/subPackages/vite.config.ts](file://packages/weapp-vite/test/fixtures/subPackages/vite.config.ts)

## 插件配置

插件配置是 `weapp-vite` 项目中扩展功能的关键部分。通过 `vite.config.ts` 文件中的 `plugins` 选项，可以注册各种 Vite 插件，以增强项目的构建和开发体验。

例如，在 `vite.config.ts` 中可以这样配置插件：

```ts
plugins: [
  uvwt({
    rem2rpx: true,
    cssSelectorReplacement: {
      root: ['page', '.tw-page'],
    },
  }),
]
```

此外，插件的加载顺序也非常重要。根据 `weapp-vite` 的内部逻辑，插件会被重新排列，确保 `vitePluginWeapp` 在最前面，而 `vite-tsconfig-paths` 插件则被放置在最后。

```ts
function arrangePlugins(config: InlineConfig, subPackageMeta: SubPackageMetaValue | undefined) {
  const existing = normalizePluginOptions(config.plugins)
  const tsconfigPlugins: PluginOption[] = []
  const others: PluginOption[] = []
  for (const entry of existing) {
    if (!entry) {
      continue
    }
    if (isNamedPlugin(entry, 'vite-tsconfig-paths')) {
      tsconfigPlugins.push(entry)
      continue
    }
    if (isNamedPlugin(entry, WEAPP_VITE_CONTEXT_PLUGIN_NAME)) {
      continue
    }
    others.push(entry)
  }

  config.plugins = [
    vitePluginWeapp(ctx as any, subPackageMeta),
    ...others,
    ...tsconfigPlugins,
  ]
}
```

**Section sources**
- [apps/vite-native/vite.config.ts](file://apps/vite-native/vite.config.ts)
- [weapp-vite/src/runtime/config/internal/merge.ts](file://packages/weapp-vite/src/runtime/config/internal/merge.ts)

## 配置文件加载优先级与环境变量覆盖

`weapp-vite` 项目中的配置文件加载遵循一定的优先级规则。首先，项目会读取 `vite.config.ts` 文件中的配置，然后根据环境变量和命令行参数进行覆盖。

环境变量的覆盖机制允许开发者在不同的环境中使用不同的配置。例如，可以通过 `.env` 文件定义环境变量，这些变量会在构建时被注入到 `import.meta.env` 中。

```ts
envDir: 'envDir'
```

此外，`weapp-vite` 还支持通过 `define` 选项来定义环境变量，这些变量可以在代码中直接使用。

```ts
define: {
  'import.meta.env.VITE_SUB_PACKAGE_B': '"sub-package-b"'
}
```

**Section sources**
- [apps/vite-native/vite.config.ts](file://apps/vite-native/vite.config.ts)
- [packages/weapp-vite/test/fixtures/subPackages/vite.config.ts](file://packages/weapp-vite/test/fixtures/subPackages/vite.config.ts)

## 配置验证与调试技巧

为了确保 `vite.config.ts` 配置的正确性，开发者可以使用多种验证和调试技巧。首先，可以通过 `weapp.debug.watchFiles` 选项来输出监听列表，确认扫描情况。

```ts
debug: {
  async watchFiles(watchFiles) {
    fs.appendFile(
      path.resolve(__dirname, 'watchFiles.txt'),
      `${watchFiles.join('\n')}\n\n`,
    )
  },
}
```

此外，还可以使用 `weapp.debug.inspect` 选项来监控钩子执行情况，帮助定位性能瓶颈。

```ts
inspect: {
  threshold: 100,
  slient: true,
  onHookExecution({ hookName, pluginName, duration, args }) {
    consola.info(`[${pluginName}] ${hookName.padEnd(20)} ⏱ ${duration.toFixed(2).padStart(6)} ms`)
    if (hookName === 'transform') {
      consola.info(args[1])
    }
    else if (hookName === 'load') {
      consola.info(args[0])
    }
  },
}
```

**Section sources**
- [apps/vite-native/vite.config.ts](file://apps/vite-native/vite.config.ts)
- [website/troubleshoot/index.md](file://website/troubleshoot/index.md)

## 配置文件模板与最佳实践

为了帮助开发者快速上手 `weapp-vite` 项目，以下是一个推荐的 `vite.config.ts` 配置文件模板：

```ts
import { defineConfig } from 'weapp-vite/config'
import path from 'pathe'

export default defineConfig(
  ({ mode }) => {
    console.log('[mode]:', mode)
    return {
      weapp: {
        srcRoot: 'src',
        generate: {
          extensions: {
            js: 'ts',
            wxss: 'scss',
          },
          dirs: {
            component: 'src/components',
            page: 'src/pages',
          },
        },
        jsonAlias: {
          entries: [
            {
              find: '@',
              replacement: path.resolve(__dirname, 'components'),
            },
          ],
        },
        subPackages: {
          'packages/order': {
            independent: true,
            dependencies: ['crypto-es'],
          },
        },
      },
      css: {
        preprocessorOptions: {
          scss: {
            silenceDeprecations: ['legacy-js-api', 'import'],
          },
        },
      },
      plugins: [
        // 在这里注册 vite 插件
      ],
    }
  },
)
```

最佳实践包括：
- 使用 `jsonAlias` 配置别名，简化路径引用。
- 合理规划分包结构，避免过度拆分。
- 按照推荐顺序注册插件，确保构建流程的正确性。
- 利用环境变量和 `define` 选项，实现多环境配置。

**Section sources**
- [templates/weapp-vite-template/vite.config.ts](file://templates/weapp-vite-template/vite.config.ts)
- [apps/tdesign-miniprogram-starter-retail/vite.config.ts](file://apps/tdesign-miniprogram-starter-retail/vite.config.ts)

## 常见错误配置示例

### 路径别名格式错误

错误示例：
```ts
weapp: {
  jsonAlias: {
    entries: [
      {
        find: '@',
        replacement: 'components', // 错误：未使用绝对路径
      },
    ],
  },
}
```

正确做法应使用 `path.resolve` 生成绝对路径。

### 分包配置不完整

错误示例：
```ts
weapp: {
  subPackages: {
    'packages/order': {
      // 缺少 independent 或 dependencies 配置
    },
  },
}
```

正确做法应明确指定分包的独立性和依赖项。

### 插件顺序错误

错误示例：
```ts
plugins: [
  vitePluginWeapp(ctx as any, subPackageMeta),
  // 其他插件
  {
    name: 'vite-tsconfig-paths',
    // ...
  },
]
```

正确做法应确保 `vite-tsconfig-paths` 插件位于其他插件之后。

**Section sources**
- [apps/vite-native/vite.config.ts](file://apps/vite-native/vite.config.ts)
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts)

## 总结

本文档详细介绍了 `weapp-vite` 项目中 `vite.config.ts` 配置文件的各个方面，包括别名配置、路径映射、分包配置和插件配置。通过分析实际配置示例和常见错误，我们提供了完整的配置指南和最佳实践。希望这些信息能帮助开发者更高效地管理和优化 `weapp-vite` 项目的配置，提升开发体验。

**Section sources**
- [vite.config.ts](file://vite.config.ts)
- [website/troubleshoot/index.md](file://website/troubleshoot/index.md)