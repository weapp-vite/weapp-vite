# 分包配置

<cite>
**本文档引用的文件**   
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
- [app.json.ts](file://packages/weapp-vite/test/fixtures/subPackages/src/app.json.ts)
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts)
- [scanPlugin.ts](file://packages/weapp-vite/src/runtime/scanPlugin.ts)
- [subpackages.md](file://docs/subpackages.md)
- [subpackage.md](file://website/guide/subpackage.md)
- [independent-subpackage.test.ts](file://packages/weapp-vite/test/independent-subpackage.test.ts)
</cite>

## 目录
1. [引言](#引言)
2. [分包配置基础](#分包配置基础)
3. [主包与分包路径配置](#主包与分包路径配置)
4. [独立分包配置](#独立分包配置)
5. [分包预下载配置](#分包预下载配置)
6. [分包共享代码配置](#分包共享代码配置)
7. [常见错误配置示例](#常见错误配置示例)
8. [构建过程中的分包处理机制](#构建过程中的分包处理机制)
9. [分包配置验证与调试](#分包配置验证与调试)
10. [分包优化策略与性能监控](#分包优化策略与性能监控)
11. [结论](#结论)

## 引言

在大型微信小程序项目中，合理使用分包机制能够显著提升首屏加载速度并有效控制包体大小。`weapp-vite` 提供了强大的分包编译能力，通过 `weapp.subPackages` 配置项，开发者可以精细化管理每个分包的构建行为，包括独立分包、依赖裁剪、样式共享等高级功能。本文档旨在详细解释 `weapp-vite` 中分包配置的正确使用方法，帮助开发者避免常见的配置错误，并提供优化策略和调试技巧。

## 分包配置基础

分包配置的核心在于 `app.json` 文件中的 `subpackages` 或 `subPackages` 字段，以及 `vite.config.ts` 中的 `weapp.subPackages` 配置。`weapp-vite` 会直接读取 `app.json` 中的分包定义，并结合 `vite.config.ts` 中的高级配置进行构建。

### 分包类型

- **普通分包**：与主包共享同一个构建上下文，可以共享代码和资源。
- **独立分包**：拥有独立的构建上下文，不共享主包的代码和资源，适用于需要独立运行的模块。

### 配置入口

- **`app.json`**：定义分包的基本信息，如 `root`、`pages`、`independent` 等。
- **`vite.config.ts`**：通过 `weapp.subPackages` 配置项，为每个分包提供更精细的构建控制。

**Section sources**
- [app.json.ts](file://packages/weapp-vite/test/fixtures/subPackages/src/app.json.ts)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)

## 主包与分包路径配置

主包与分包的路径配置是分包机制的基础。`app.json` 中的 `pages` 字段定义主包的页面，而 `subpackages` 字段定义分包的路径和页面。

### 配置示例

```json
{
  "pages": [
    "pages/index/index"
  ],
  "subpackages": [
    {
      "root": "packages/order",
      "name": "订单中心",
      "pages": ["index", "detail"]
    },
    {
      "root": "packages/profile",
      "pages": ["index", "settings"]
    }
  ]
}
```

### 路径规则

- **`root`**：分包的根目录，相对于项目根目录。
- **`pages`**：分包内的页面路径，相对于 `root` 目录。
- **`entry`**：分包的入口文件，可选。

### 最佳实践

- **保持主包最小化**：主包只保留首屏必要的页面和逻辑，其余业务模块放入分包。
- **以业务边界拆分**：分包根目录与业务模块一致，便于团队协作和权限管理。

**Section sources**
- [app.json.ts](file://packages/weapp-vite/test/fixtures/subPackages/src/app.json.ts)

## 独立分包配置

独立分包拥有独立的构建上下文，不共享主包的代码和资源。这使得独立分包可以独立运行，适用于需要自定义 TabBar 或插件能力的模块。

### 配置示例

```json
{
  "subpackages": [
    {
      "root": "packages/order",
      "name": "订单中心",
      "pages": ["index", "detail"],
      "independent": true
    }
  ]
}
```

### 独立分包特性

- **独立上下文**：独立分包无法直接访问主包的全局数据。
- **独立依赖**：独立分包的 `miniprogram_npm` 依赖需要单独管理，避免主包依赖泄漏。
- **独立构建**：独立分包在不同的构建上下文中进行打包，不共享主包的代码。

### 配置优化

在 `vite.config.ts` 中，可以通过 `weapp.subPackages` 配置项进一步优化独立分包：

```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packages/order': {
        independent: true,
        dependencies: [/^@order\//, 'dayjs'],
        inlineConfig: {
          define: { 'import.meta.env.ORDER_SCOPE': 'true' },
        },
      },
    },
  },
})
```

- **`dependencies`**：精确控制分包需要的 `miniprogram_npm` 依赖。
- **`inlineConfig`**：为分包注入额外的构建配置，如 `define` 变量。

**Section sources**
- [app.json.ts](file://packages/weapp-vite/test/fixtures/subPackages/src/app.json.ts)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)

## 分包预下载配置

分包预下载机制允许在主包加载时提前下载分包，从而提升用户体验。通过 `app.json` 中的 `preloadRule` 字段，可以配置分包的预下载规则。

### 配置示例

```json
{
  "preloadRule": {
    "pages/index/index": {
      "packages": ["packages/profile"],
      "network": "all",
      "timeout": 2000
    }
  }
}
```

### 配置说明

- **`packages`**：需要预下载的分包列表。
- **`network`**：网络条件，`all` 表示所有网络条件下都预下载。
- **`timeout`**：预下载超时时间，单位为毫秒。

### 最佳实践

- **预加载高频次屏**：在首页预加载用户个人页等高频访问的分包。
- **结合运营节奏**：根据运营活动预加载相关分包，提升用户体验。

**Section sources**
- [app.json.ts](file://packages/weapp-vite/test/fixtures/subPackages/src/app.json.ts)

## 分包共享代码配置

分包共享代码配置允许在多个分包之间共享公共代码，避免代码重复。`weapp-vite` 提供了 `weapp.subPackages[].styles` 配置项，用于共享样式文件。

### 配置示例

```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packages/order': {
        styles: [
          'styles/theme.scss',
          {
            source: '../shared/styles/components.scss',
            scope: 'components',
            include: ['components/**'],
          },
        ],
      },
      'packages/profile': {
        styles: {
          source: 'styles/index.scss',
          scope: 'pages',
        },
      },
    },
  },
})
```

### 配置说明

- **`source`**：共享样式文件的路径。
- **`scope`**：注入范围，`all`、`pages` 或 `components`。
- **`include` / `exclude`**：包含或排除的文件路径。

### 共享策略

- **普通分包**：共享样式文件只生成一次，并在分包页面/组件头部自动注入 `@import`。
- **独立分包**：在专属上下文重新编译同一份源文件，保持样式同步。

**Section sources**
- [vite.config.ts](file://apps/vite-native/vite.config.ts)

## 常见错误配置示例

### 分包路径错误

**错误示例**：
```json
{
  "subpackages": [
    {
      "root": "packageA",
      "pages": ["pages/index"]
    }
  ]
}
```

**问题**：`pages` 路径应相对于 `root` 目录，不应包含 `pages` 前缀。

**正确配置**：
```json
{
  "subpackages": [
    {
      "root": "packageA",
      "pages": ["index"]
    }
  ]
}
```

### 分包依赖声明不完整

**错误示例**：
```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packages/order': {
        independent: true,
      },
    },
  },
})
```

**问题**：未声明独立分包所需的 `miniprogram_npm` 依赖，可能导致运行时错误。

**正确配置**：
```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packages/order': {
        independent: true,
        dependencies: ['dayjs', /^@order\//],
      },
    },
  },
})
```

### 独立分包配置错误

**错误示例**：
```json
{
  "subpackages": [
    {
      "root": "packages/order",
      "independent": false
    }
  ]
}
```

**问题**：`independent` 字段应为 `true`，以确保分包独立运行。

**正确配置**：
```json
{
  "subpackages": [
    {
      "root": "packages/order",
      "independent": true
    }
  ]
}
```

**Section sources**
- [app.json.ts](file://packages/weapp-vite/test/fixtures/subPackages/src/app.json.ts)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)

## 构建过程中的分包处理机制

`weapp-vite` 在构建过程中会对分包进行详细的依赖分析、资源分割和加载策略优化。

### 依赖分析

构建器会分析每个分包的依赖关系，确保独立分包不引用主包或其他分包的代码。如果发现跨分包引用，构建器会报错提示。

### 资源分割

根据引用规则，构建器会将共享代码分割到不同的产物中：
- **普通分包**：共享代码会被提炼到主包的 `common.js` 或分包的 `__shared__/common.js`。
- **独立分包**：共享代码会在独立上下文中重新编译。

### 加载策略

- **`duplicate` 策略**：共享代码复制到每个分包的 `__shared__/common.js`，避免分包首次打开时回主包拉取。
- **`hoist` 策略**：共享代码统一提炼到主包的 `common.js`，减少整体包体大小。

```ts
export default defineConfig({
  weapp: {
    chunks: {
      sharedStrategy: 'duplicate',
      duplicateWarningBytes: 256 * 1024,
    },
  },
})
```

**Section sources**
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)

## 分包配置验证与调试

### 验证配置

在 `package.json` 中添加 `analyze` 脚本，用于分析分包配置：

```json
{
  "scripts": {
    "analyze": "weapp-vite analyze"
  }
}
```

执行 `pnpm run analyze` 可生成分包报告，查看每个分包的产物结构和共享模块。

### 调试技巧

- **检查构建日志**：关注 `[subpackages]` 警告，它们通常意味着路径错误或格式不受支持。
- **使用 `weapp.debug.watchFiles`**：查看产物位置，确认独立分包是否生成独立的 `miniprogram_npm`。
- **分析产物布局**：通过 `analyze` 命令核对源码最终落点，确保配置正确。

**Section sources**
- [vite.config.ts](file://apps/vite-native/vite.config.ts)

## 分包优化策略与性能监控

### 优化策略

- **精确控制依赖**：使用 `weapp.subPackages[].dependencies` 精确声明每个分包需要的 `miniprogram_npm` 依赖。
- **共享样式文件**：通过 `weapp.subPackages[].styles` 共享公共样式，减少重复代码。
- **预加载关键分包**：在 `app.json` 的 `preloadRule` 中声明高频访问的分包，提升用户体验。

### 性能监控

- **包体检查**：确保主包 < 2MB、单个分包 < 2MB，所有分包合计 < 20MB。
- **冗余体积告警**：通过 `weapp.chunks.duplicateWarningBytes` 设定冗余体积的提醒阈值，及时关注包体膨胀。

```ts
export default defineConfig({
  weapp: {
    chunks: {
      sharedStrategy: 'duplicate',
      forceDuplicatePatterns: ['action/**'],
      duplicateWarningBytes: 768 * 1024,
    },
  },
})
```

**Section sources**
- [vite.config.ts](file://apps/vite-native/vite.config.ts)

## 结论

合理规划分包并结合 `weapp-vite` 的构建能力，可以在保证首屏体验的同时降低维护成本。通过 `weapp.subPackages` 配置项，开发者可以精细化管理每个分包的构建行为，避免常见的配置错误。利用 `analyze` 命令和构建日志，可以快速识别和修复分包配置问题。遵循最佳实践，结合性能监控，能够有效优化小程序的包体和加载性能。