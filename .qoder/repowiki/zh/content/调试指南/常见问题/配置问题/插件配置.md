# 插件配置

<cite>
**本文档引用的文件**  
- [wxPlugin.ts](file://packages/weapp-vite/src/plugins/wxPlugin.ts)
- [viteConfig.ts](file://@weapp-core/init/src/viteConfig.ts)
- [config.ts](file://packages/weapp-vite/src/config.ts)
- [index.ts](file://packages/weapp-vite/src/plugins/index.ts)
- [merge.ts](file://packages/weapp-vite/src/runtime/config/internal/merge.ts)
- [wrapPlugin.ts](file://packages/vite-plugin-performance/src/wrapPlugin.ts)
- [preflight.ts](file://packages/weapp-vite/src/plugins/preflight.ts)
- [builtin.ts](file://scripts/builtin.ts)
- [plugin.md](file://website/guide/plugin.md)
</cite>

## 目录
1. [引言](#引言)
2. [插件配置基础](#插件配置基础)
3. [内置插件管理](#内置插件管理)
4. [插件参数配置](#插件参数配置)
5. [插件执行顺序](#插件执行顺序)
6. [插件依赖关系](#插件依赖关系)
7. [常见错误配置示例](#常见错误配置示例)
8. [构建生命周期中的插件执行](#构建生命周期中的插件执行)
9. [插件间通信机制](#插件间通信机制)
10. [插件配置验证与调试](#插件配置验证与调试)
11. [最佳实践与性能优化](#最佳实践与性能优化)

## 引言
weapp-vite 是一个用于微信小程序开发的构建工具，它基于 Vite 构建系统，提供了丰富的插件机制来扩展和定制构建流程。本文档旨在详细解释 weapp-vite 中插件配置项的正确使用方法，重点解决因插件配置顺序和参数不当导致的构建流程问题。通过本文档，开发者将能够理解如何正确启用和禁用内置插件、配置插件参数、管理插件执行顺序以及处理插件间的依赖关系。

**Section sources**
- [plugin.md](file://website/guide/plugin.md#L133-L141)

## 插件配置基础
在 weapp-vite 中，插件配置是通过 `vite.config.ts` 文件中的 `weapp` 选项进行的。该配置允许开发者自定义构建行为，包括源码根目录、插件根目录等。基本的配置结构如下所示：

```ts
import { defineConfig } from 'weapp-vite/config'

export default defineConfig({
  weapp: {
    // weapp-vite options
    srcRoot: 'miniprogram',
    pluginRoot: 'plugin',
  },
})
```

此配置定义了项目的源码根目录为 `miniprogram`，插件根目录为 `plugin`。这些设置对于正确解析项目结构和资源路径至关重要。

**Section sources**
- [viteConfig.ts](file://@weapp-core/init/src/viteConfig.ts#L1-L11)
- [config.ts](file://packages/weapp-vite/src/config.ts#L1-L29)

## 内置插件管理
weapp-vite 提供了一系列内置插件，以支持小程序开发的各种需求。这些插件包括但不限于自动导入组件、路由生成、样式处理等。开发者可以通过配置文件来启用或禁用这些插件。

例如，`autoImport` 插件可以自动导入项目中使用的组件，减少手动导入的工作量。要启用此功能，可以在配置文件中添加相应的选项：

```ts
export default defineConfig({
  weapp: {
    autoImport: true,
  },
})
```

同样，如果需要禁用某个插件，可以将其设置为 `false` 或从配置中移除。

**Section sources**
- [index.ts](file://packages/weapp-vite/src/plugins/index.ts#L5-L12)

## 插件参数配置
每个插件都可能有一组特定的参数，用于控制其行为。这些参数通常在 `weapp` 配置对象中指定。例如，`css` 插件可能需要配置预处理器选项，如 `sass` 或 `less` 的编译选项。

```ts
export default defineConfig({
  weapp: {
    css: {
      preprocessorOptions: {
        scss: {
          additionalData: `@import "src/styles/variables.scss";`,
        },
      },
    },
  },
})
```

上述配置会在每个 SCSS 文件的开头自动引入 `variables.scss` 文件，从而实现全局变量的共享。

**Section sources**
- [config.ts](file://packages/weapp-vite/src/types/config.ts#L1-L200)

## 插件执行顺序
插件的执行顺序对构建结果有重要影响。weapp-vite 通过 `enforce` 属性来控制插件的执行时机。`enforce` 可以设置为 `'pre'` 或 `'post'`，分别表示在其他插件之前或之后执行。

例如，`preflight` 插件被设置为 `enforce: 'pre'`，确保它在其他插件之前运行，用于清理和同步环境变量：

```ts
function createEnvSynchronizer({ configService }: CompilerContext): Plugin {
  return {
    name: 'weapp-vite:set-env',
    enforce: 'pre',
    configResolved(config) {
      if (!isObject(config.env)) {
        return
      }

      for (const [key, value] of Object.entries(config.env)) {
        configService.setDefineEnv(key, value)
      }
    },
  }
}
```

**Section sources**
- [preflight.ts](file://packages/weapp-vite/src/plugins/preflight.ts#L29-L47)

## 插件依赖关系
某些插件之间存在依赖关系，必须按照正确的顺序加载。例如，`vite-tsconfig-paths` 插件需要在其他插件之前加载，以便正确解析路径别名。weapp-vite 通过 `arrangePlugins` 函数来管理插件的加载顺序：

```ts
function arrangePlugins(config: InlineConfig, subPackageMeta: SubPackageMetaValue | undefined) {
  const existing = normalizePluginOptions(config.plugins)
  const tsconfigPlugins: PluginOption[] = []
  const others: PluginOption[] = []

  for (const entry of existing) {
    if (!entry) {
      continue
    }
    if (isNamedPlugin(entry, 'vite-tsconfig-paths')) {
      tsconfigPlugins.push(entry)
      continue
    }
    if (isNamedPlugin(entry, WEAPP_VITE_CONTEXT_PLUGIN_NAME)) {
      continue
    }
    others.push(entry)
  }

  config.plugins = [
    vitePluginWeapp(ctx as any, subPackageMeta),
    ...others,
    ...tsconfigPlugins,
  ]
}
```

此函数确保 `vite-tsconfig-paths` 插件在最后加载，而 `weapp-vite` 插件在最前面加载。

**Section sources**
- [merge.ts](file://packages/weapp-vite/src/runtime/config/internal/merge.ts#L108-L132)

## 常见错误配置示例
### 插件顺序错误
错误地配置插件顺序可能导致构建失败或产生意外的结果。例如，如果 `vite-tsconfig-paths` 插件没有在其他插件之前加载，路径别名可能无法正确解析。

### 插件参数格式错误
插件参数的格式错误也会导致构建失败。例如，`css` 插件的 `preprocessorOptions` 必须是一个对象，包含正确的预处理器名称和选项。

### 插件冲突
多个插件可能试图修改同一文件或资源，导致冲突。例如，两个插件同时尝试修改 `app.json` 文件，可能会导致文件内容不一致。

**Section sources**
- [plugin.md](file://website/guide/plugin.md#L133-L141)

## 构建生命周期中的插件执行
weapp-vite 的构建生命周期包括多个阶段，每个阶段都有特定的插件负责处理。这些阶段包括初始化、解析配置、编译、打包和输出。插件在这些阶段中按需执行，确保构建过程的顺利进行。

例如，`preflight` 插件在配置解析阶段执行，用于清理和同步环境变量；`css` 插件在编译阶段执行，用于处理样式文件。

**Section sources**
- [merge.ts](file://packages/weapp-vite/src/runtime/config/internal/merge.ts#L134-L299)

## 插件间通信机制
插件之间可以通过共享上下文对象进行通信。weapp-vite 使用 `CompilerContext` 对象来传递构建过程中的各种信息。插件可以通过访问这个上下文对象来获取和修改构建状态。

例如，`createContextPlugin` 函数创建了一个包含 `ctx` 的插件，其他插件可以通过 `api.ctx` 访问这个上下文：

```ts
function createContextPlugin(ctx: CompilerContext): Plugin<WeappVitePluginApi> {
  return {
    name: WEAPP_VITE_CONTEXT_PLUGIN_NAME,
    enforce: 'pre',
    api: {
      ctx,
    },
  }
}
```

**Section sources**
- [index.ts](file://packages/weapp-vite/src/plugins/index.ts#L17-L25)

## 插件配置验证与调试
为了帮助开发者快速识别和修复插件配置错误，weapp-vite 提供了多种验证和调试工具。例如，`vite-plugin-performance` 插件可以包裹其他插件，统计生命周期钩子的执行时间，帮助定位性能瓶颈。

```ts
import { defineConfig } from 'vite'
import Inspect from 'vite-plugin-inspect'
import { wrapPlugin } from 'vite-plugin-performance'

export default defineConfig({
  plugins: [
    wrapPlugin(Inspect(), {
      threshold: 50,
      onHookExecution({ pluginName, hookName, duration }) {
        reportToAPM({ pluginName, hookName, duration })
      },
    }),
  ],
})
```

此配置会记录所有超过 50 毫秒的钩子执行时间，并通过 `onHookExecution` 回调上报。

**Section sources**
- [wrapPlugin.ts](file://packages/vite-plugin-performance/src/wrapPlugin.ts#L1-L27)
- [index.ts](file://packages/weapp-vite/src/plugins/index.ts#L36-L44)

## 最佳实践与性能优化
### 启用必要的插件
只启用项目实际需要的插件，避免不必要的开销。例如，如果项目不使用 TypeScript，可以禁用 `vite-tsconfig-paths` 插件。

### 优化插件参数
合理配置插件参数，以提高构建效率。例如，为 `css` 插件配置合适的预处理器选项，可以减少编译时间。

### 使用性能监控
利用 `vite-plugin-performance` 等工具监控构建性能，及时发现和解决性能瓶颈。

### 定期更新依赖
定期更新项目依赖，确保使用最新的插件版本，以获得更好的性能和功能支持。

**Section sources**
- [builtin.ts](file://scripts/builtin.ts#L1-L49)
- [wrapPlugin.ts](file://packages/vite-plugin-performance/src/wrapPlugin.ts#L1-L27)