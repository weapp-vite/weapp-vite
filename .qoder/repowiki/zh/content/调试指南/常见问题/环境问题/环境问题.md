# 环境问题

<cite>
**本文档引用的文件**  
- [package.json](file://package.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)
- [turbo.json](file://turbo.json)
- [@weapp-core/init/templates/default/project.config.json](file://@weapp-core/init/templates/default/project.config.json)
- [@weapp-core/init/templates/default/tsconfig.json](file://@weapp-core/init/templates/default/tsconfig.json)
- [apps/vite-native/.env](file://apps/vite-native/.env)
- [apps/vite-native/.env.development](file://apps/vite-native/.env.development)
- [apps/vite-native/envDir/.env.prod](file://apps/vite-native/envDir/.env.prod)
- [@weapp-core/init/src/enums.ts](file://@weapp-core/init/src/enums.ts)
- [@weapp-core/init/src/state.ts](file://@weapp-core/init/src/state.ts)
- [packages/weapp-vite/src/utils/version.ts](file://packages/weapp-vite/src/utils/version.ts)
- [packages/weapp-ide-cli/src/runtime/platform.ts](file://packages/weapp-ide-cli/src/runtime/platform.ts)
- [apps/subpackage-shared-chunks/src/config/index.ts](file://apps/subpackage-shared-chunks/src/config/index.ts)
- [docs/wevu/compatibility.md](file://docs/wevu/compatibility.md)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心环境问题分析](#核心环境问题分析)
4. [Node.js版本兼容性](#nodejs版本兼容性)
5. [操作系统差异](#操作系统差异)
6. [微信开发者工具版本匹配](#微信开发者工具版本匹配)
7. [依赖包版本冲突](#依赖包版本冲突)
8. [环境变量配置指南](#环境变量配置指南)
9. [多环境管理策略](#多环境管理策略)
10. [环境检查清单](#环境检查清单)
11. [结论](#结论)

## 引言
本项目是一个基于Vite的微信小程序开发框架，旨在提供现代化的开发体验。然而，在实际开发过程中，由于开发环境与运行环境之间的不兼容性，可能会导致各种问题。本文档将深入分析这些环境问题，包括Node.js版本兼容性、操作系统差异、微信开发者工具版本匹配以及依赖包版本冲突等，并提供相应的解决方案和最佳实践。

## 项目结构
该项目采用Monorepo架构，使用PNPM作为包管理器，Turbo作为构建工具。主要目录包括：
- `@weapp-core/`: 核心初始化逻辑
- `apps/`: 示例应用
- `packages/`: 可复用的包
- `templates/`: 项目模板
- `website/`: 官方网站

```mermaid
graph TD
A[根目录] --> B[@weapp-core]
A --> C[apps]
A --> D[packages]
A --> E[templates]
A --> F[website]
B --> G[init]
B --> H[logger]
C --> I[vite-native]
C --> J[plugin-demo]
D --> K[weapp-vite]
D --> L[weapp-ide-cli]
```

**图示来源**
- [package.json](file://package.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)

**本节来源**
- [package.json](file://package.json#L1-L165)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml#L1-L17)

## 核心环境问题分析
在开发微信小程序时，环境配置的正确性至关重要。常见的环境问题主要包括Node.js版本不兼容、不同操作系统下的行为差异、微信开发者工具版本不匹配以及依赖包版本冲突等。这些问题可能导致构建失败、运行时错误或性能下降。

## Node.js版本兼容性
根据`package.json`中的`engines`字段，本项目要求Node.js版本不低于20.0.0。这是为了确保能够使用最新的ES特性以及依赖包所要求的Node.js API。

```json
"engines": {
  "node": ">=20.0.0"
}
```

此外，在`packages/weapp-vite/src/utils/version.ts`中实现了运行时版本检查功能，可以检测当前Node.js版本是否满足最低要求：

```typescript
export function checkRuntime(minVersions: MinVersions): void {
  const { runtime, version } = getRuntime()
  const required = minVersions[runtime]

  if (!required) {
    logger.warn(`No minimum version specified for ${runtime}, skipping check.`)
    return
  }

  if (!semverGte(version, required)) {
    logger.warn(`当前 ${runtime} 版本为 ${version} 无法满足 \`weapp-vite\` 最低要求的版本(>= ${required})`)
  }
}
```

**本节来源**
- [package.json](file://package.json#L15-L17)
- [packages/weapp-vite/src/utils/version.ts](file://packages/weapp-vite/src/utils/version.ts#L1-L63)

## 操作系统差异
不同的操作系统（Windows、macOS、Linux）在文件路径分隔符、编码格式、时区设置等方面存在差异，这些差异可能影响开发工具的行为。

在`packages/weapp-ide-cli/src/runtime/platform.ts`中，可以看到针对不同操作系统的CLI路径解析逻辑：

```typescript
const cliPathResolvers: Record<SupportedPlatform, CliPathResolver> = {
  [SupportedPlatformsMap.Windows_NT]: async () => WINDOWS_DEFAULT_CLI,
  [SupportedPlatformsMap.Darwin]: async () => DARWIN_DEFAULT_CLI,
  [SupportedPlatformsMap.Linux]: linuxCliResolver,
}
```

同时，在`apps/subpackage-shared-chunks/src/config/index.ts`中，通过`wx.getSystemInfoSync()`获取系统信息，以判断当前运行平台：

```typescript
const { AppPlatform, platform: platformValue, model } = wx.getSystemInfoSync() || {}
export const isWx = AppPlatform !== 'qq' && AppPlatform !== 'tim'
export const isWindows = platformValue === 'windows'
export const isMac = platformValue === 'mac'
export const isQQ = AppPlatform == 'qq' || AppPlatform === 'tim'
export const isIpad = platformValue === 'ios' && /ipad/i.test(model)
export const isPC = platformValue === 'windows' || platformValue === 'mac' || isIpad
export const isIos = platformValue === 'ios'
export const isDevTools = platformValue === 'devtools'
```

**本节来源**
- [packages/weapp-ide-cli/src/runtime/platform.ts](file://packages/weapp-ide-cli/src/runtime/platform.ts#L33-L82)
- [apps/subpackage-shared-chunks/src/config/index.ts](file://apps/subpackage-shared-chunks/src/config/index.ts#L1-L9)

## 微信开发者工具版本匹配
微信开发者工具的不同版本可能支持不同的功能和API。在`@weapp-core/init/templates/default/project.config.json`中，可以看到项目配置文件中指定了基础库版本：

```json
"libVersion": "2.32.3"
```

此外，在`docs/wevu/compatibility.md`中提到了运行环境的要求：

> - 基础库：建议最低基础库版本 ≥ 3.0.0（可在项目中设置最低基础库版本，提示用户升级）。

这表明开发者需要根据目标用户的微信版本来选择合适的最低基础库版本，以确保小程序的兼容性。

**本节来源**
- [@weapp-core/init/templates/default/project.config.json](file://@weapp-core/init/templates/default/project.config.json#L36)
- [docs/wevu/compatibility.md](file://docs/wevu/compatibility.md#L3-L9)

## 依赖包版本冲突
在复杂的Monorepo项目中，依赖包版本冲突是一个常见问题。本项目通过PNPM的`shamefullyHoist: true`配置来提升依赖包，减少重复安装：

```yaml
shamefullyHoist: true
```

同时，使用Turbo进行任务编排，确保构建和测试任务的一致性：

```json
{
  "$schema": "https://turborepo.com/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "lint": {
      "dependsOn": ["^lint"],
      "outputs": []
    }
  }
}
```

**本节来源**
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml#L16)
- [turbo.json](file://turbo.json#L1-L35)

## 环境变量配置指南
环境变量是实现多环境配置的关键。在`apps/vite-native`目录下，可以看到`.env`、`.env.development`和`.env.prod`等环境变量文件：

```bash
# .env
VITE_ENV=.env

# .env.development
VITE_XXX=development

# .env.prod
VITE_XXX=PROD
```

这些文件分别对应不同的环境配置，Vite会根据当前模式自动加载相应的环境变量文件。

**本节来源**
- [apps/vite-native/.env](file://apps/vite-native/.env#L1)
- [apps/vite-native/.env.development](file://apps/vite-native/.env.development#L1)
- [apps/vite-native/envDir/.env.prod](file://apps/vite-native/envDir/.env.prod#L1)

## 多环境管理策略
为了确保开发、测试和生产环境的一致性，建议采用以下多环境管理策略：
1. 使用`.env`文件定义环境变量
2. 在`vite.config.ts`中根据`process.env.NODE_ENV`进行条件配置
3. 使用CI/CD工具自动化部署流程
4. 定期同步各环境的依赖版本

## 环境检查清单
为帮助开发者确认开发环境配置是否正确，提供以下检查清单：

| 检查项 | 验证方法 | 预期结果 |
|-------|--------|--------|
| Node.js版本 | `node --version` | ≥ v20.0.0 |
| PNPM版本 | `pnpm --version` | 与`.npmrc`一致 |
| 微信开发者工具路径 | `which wechat-devtools-cli` | 存在且可执行 |
| 环境变量文件 | 检查`.env*`文件 | 存在且配置正确 |
| 依赖包安装 | `pnpm install` | 成功无报错 |
| 构建命令 | `pnpm run build` | 成功生成dist目录 |

**本节来源**
- [package.json](file://package.json#L15-L17)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml#L16)
- [apps/vite-native/.env](file://apps/vite-native/.env#L1)

## 结论
通过本文档的分析，我们可以看到环境配置在微信小程序开发中的重要性。正确的Node.js版本、操作系统适配、微信开发者工具版本匹配以及依赖包管理是确保项目顺利开发和运行的基础。建议开发者严格按照环境检查清单进行配置，并定期更新依赖包以获得最新的功能和安全修复。