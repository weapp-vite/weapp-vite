# 性能分析

<cite>
**本文档中引用的文件**  
- [index.ts](file://packages/vite-plugin-performance/src/index.ts)
- [options.ts](file://packages/vite-plugin-performance/src/options.ts)
- [types.ts](file://packages/vite-plugin-performance/src/types.ts)
- [constants.ts](file://packages/vite-plugin-performance/src/constants.ts)
- [wrapPlugin.ts](file://packages/vite-plugin-performance/src/wrapPlugin.ts)
- [main.ts](file://packages/weapp-vite/analyze-dashboard/main.ts)
- [App.vue](file://packages/weapp-vite/analyze-dashboard/App.vue)
- [useTreemapData.ts](file://packages/weapp-vite/analyze-dashboard/useTreemapData.ts)
- [mock-data.ts](file://packages/weapp-vite/analyze-dashboard/mock-data.ts)
- [vite.config.ts](file://packages/weapp-vite/analyze-dashboard/vite.config.ts)
</cite>

## 目录
1. [介绍](#介绍)
2. [构建性能监控工具](#构建性能监控工具)
3. [运行时性能分析](#运行时性能分析)
4. [分析仪表板](#分析仪表板)
5. [性能优化建议与最佳实践](#性能优化建议与最佳实践)
6. [实际示例](#实际示例)

## 介绍

weapp-vite 提供了一套完整的性能分析工具，帮助开发者监控和优化小程序应用的构建性能和运行时性能。本文档将详细介绍如何使用这些工具来识别性能瓶颈、解读性能报告，并通过分析仪表板可视化应用的包体结构。

**本节不分析具体源码文件，因此无节源信息**

## 构建性能监控工具

weapp-vite 的构建性能监控工具基于 `vite-plugin-performance` 插件，该插件可以包装一个或多个 Vite 插件，测量每个生命周期钩子的执行时间。它保持原有行为不变，同时提供可操作的性能洞察。

### 启用性能分析

要启用构建性能分析，需要在 `vite.config.ts` 中引入 `vite-plugin-performance` 并包装目标插件：

```ts
import { wrapPlugin } from 'vite-plugin-performance'
import somePlugin from 'some-vite-plugin'

export default defineConfig({
  plugins: [
    wrapPlugin(somePlugin(), {
      threshold: 50,
      onHookExecution({ pluginName, hookName, duration }) {
        // 可以将性能数据上报到 APM 系统
        reportToAPM({ pluginName, hookName, duration })
      }
    })
  ]
})
```

### 性能报告解读

当某个钩子的执行时间超过阈值时，会输出类似以下格式的性能报告：

```
[some-plugin] transform            ⏱   78.42 ms
```

报告包含插件名称、钩子名称和执行时间（毫秒）。

### 识别性能瓶颈

通过分析性能报告，可以识别出构建过程中的性能瓶颈。重点关注执行时间较长的钩子，特别是 `transform`、`load` 和 `buildStart` 等常见耗时钩子。

**节源信息**
- [index.ts](file://packages/vite-plugin-performance/src/index.ts#L1-L5)
- [options.ts](file://packages/vite-plugin-performance/src/options.ts#L1-L40)
- [types.ts](file://packages/vite-plugin-performance/src/types.ts#L1-L44)
- [constants.ts](file://packages/vite-plugin-performance/src/constants.ts#L1-L30)
- [wrapPlugin.ts](file://packages/vite-plugin-performance/src/wrapPlugin.ts#L1-L86)

## 运行时性能分析

weapp-vite 还提供了运行时性能分析功能，主要关注小程序的加载时间和渲染性能等关键指标。

### 加载时间监控

通过分析构建产物的大小和结构，可以间接评估小程序的加载时间。较大的包体通常意味着更长的下载和解析时间。

### 渲染性能监控

渲染性能主要受代码复杂度和资源大小影响。通过分析模块的复用情况和包体结构，可以优化渲染性能。

**节源信息**
- [index.ts](file://packages/vite-plugin-performance/src/index.ts#L1-L5)
- [wrapPlugin.ts](file://packages/vite-plugin-performance/src/wrapPlugin.ts#L1-L86)

## 分析仪表板

weapp-vite 提供了一个可视化分析仪表板，用于展示构建结果的详细信息。

### 启动分析仪表板

分析仪表板是一个基于 Vue 的应用，位于 `packages/weapp-vite/analyze-dashboard` 目录。它使用 ECharts 的 Treemap 图表来可视化包体结构。

### 配置分析仪表板

仪表板的配置在 `vite.config.ts` 中定义，主要配置包括：

- 使用 Vue 插件
- 使用 Tailwind CSS
- 构建输出目录配置
- 代码分割策略

### 解读可视化数据

分析仪表板提供以下关键信息：

- **包体数量**：显示主包和分包的总数
- **源码模块**：显示源码模块的总数
- **跨包复用**：显示跨包复用的模块数量
- **总产物**：显示所有产物的总大小

Treemap 图表使用不同颜色区分不同类型的包：
- 主包：蓝色
- 分包：绿色
- 独立分包：橙色
- 虚拟包：紫色

**节源信息**
- [main.ts](file://packages/weapp-vite/analyze-dashboard/main.ts#L1-L36)
- [App.vue](file://packages/weapp-vite/analyze-dashboard/App.vue#L1-L147)
- [useTreemapData.ts](file://packages/weapp-vite/analyze-dashboard/useTreemapData.ts#L1-L360)
- [mock-data.ts](file://packages/weapp-vite/analyze-dashboard/mock-data.ts#L1-L294)
- [vite.config.ts](file://packages/weapp-vite/analyze-dashboard/vite.config.ts#L1-L53)

## 性能优化建议与最佳实践

### 减少跨包复用

过多的跨包复用会增加主包大小。建议将频繁复用的模块提取到独立的共享包中。

### 优化包体结构

合理规划主包和分包的结构，将核心功能放在主包，非核心功能放在分包。

### 使用虚拟包

对于跨多个包复用的大型库，可以使用虚拟包来优化加载性能。

### 监控构建时间

定期监控关键构建钩子的执行时间，及时发现性能退化。

**本节不分析具体源码文件，因此无节源信息**

## 实际示例

以下是一个完整的性能分析工具使用流程示例：

1. 在 `vite.config.ts` 中启用 `vite-plugin-performance` 插件
2. 构建应用，观察性能报告
3. 使用分析仪表板查看包体结构
4. 根据分析结果优化代码结构
5. 重新构建并验证优化效果

通过这个流程，开发者可以持续监控和优化应用性能。

**本节不分析具体源码文件，因此无节源信息**