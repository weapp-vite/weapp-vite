# 项目初始化工具

<cite>
**本文档中引用的文件**  
- [cli.ts](file://packages/create-weapp-vite/src/cli.ts)
- [createProject.ts](file://@weapp-core/init/src/createProject.ts)
- [enums.ts](file://@weapp-core/init/src/enums.ts)
- [projectConfig.ts](file://@weapp-core/init/src/projectConfig.ts)
- [packageJson.ts](file://@weapp-core/init/src/packageJson.ts)
- [gitignore.ts](file://@weapp-core/init/src/gitignore.ts)
- [updateGitignore.ts](file://@weapp-core/init/src/updateGitignore.ts)
- [viteConfig.ts](file://@weapp-core/init/src/viteConfig.ts)
- [context.ts](file://@weapp-core/init/src/context.ts)
- [state.ts](file://@weapp-core/init/src/state.ts)
</cite>

## 目录
1. [简介](#简介)
2. [命令行接口](#命令行接口)
3. [模板系统](#模板系统)
4. [初始化流程](#初始化流程)
5. [配置文件生成](#配置文件生成)
6. [使用示例](#使用示例)
7. [高级用法](#高级用法)
8. [结论](#结论)

## 简介
`create-weapp-vite` 是一个用于快速创建小程序项目的命令行工具。该工具通过集成 `@weapp-core/init` 模块，提供了交互式和非交互式两种项目创建方式，支持多种技术栈模板，包括默认模板、Tailwind CSS、Vant 和 TDesign。工具能够自动处理项目初始化过程中的文件写入、依赖安装和 Git 初始化等操作，为开发者提供了一站式的小程序项目搭建解决方案。

**Section sources**
- [cli.ts](file://packages/create-weapp-vite/src/cli.ts#L1-L58)
- [createProject.ts](file://@weapp-core/init/src/createProject.ts#L1-L91)

## 命令行接口
`create-weapp-vite` 提供了灵活的命令行接口，支持交互式和非交互式两种使用模式。

### 交互式模式
在交互式模式下，用户运行命令后，工具会通过一系列提示引导用户完成项目创建：
1. **目录输入**：提示用户输入项目目录名称，默认为 `my-app`
2. **覆盖确认**：如果目标目录已存在，询问是否覆盖
3. **模板选择**：提供模板选择菜单，包括默认模板、Tailwind CSS 模板、Vant 模板和 TDesign 模板

### 非交互式模式
工具也支持非交互式使用，通过命令行参数直接指定项目目录和模板名称：
```bash
node cli.mjs <targetDir> <templateName>
```
例如：
```bash
node dist/cli.js my-app default
```

工具通过解析 `process.argv` 参数来判断使用模式，当提供了命令行参数时进入非交互式模式，否则进入交互式模式。

**Section sources**
- [cli.ts](file://packages/create-weapp-vite/src/cli.ts#L9-L50)

## 模板系统
项目初始化工具的核心是其灵活的模板系统，该系统基于 `@weapp-core/init` 模块实现。

### 模板类型
工具支持四种预定义模板，通过 `TemplateName` 枚举定义：
- **default**：默认模板，包含基础的小程序项目结构
- **tailwindcss**：集成 Tailwind CSS 的模板
- **vant**：集成 Vant 组件库和 Tailwind CSS 的模板
- **tdesign**：集成 TDesign 组件库和 Tailwind CSS 的模板

### 模板加载机制
模板文件存储在 `@weapp-core/init/templates` 目录下，每个模板对应一个子目录。当用户选择模板后，工具会：
1. 构建目标模板目录路径
2. 验证模板目录是否存在
3. 将模板目录内容复制到目标项目目录

模板复制使用 `fs-extra` 库的 `copy` 方法实现，确保文件和目录结构的完整复制。

### 技术栈集成
不同模板集成了相应的技术栈：
- **Tailwind CSS**：包含 `postcss.config.js` 和 `tailwind.config.ts` 配置文件
- **Vant**：在 `package.json` 中预置 Vant 组件库依赖
- **TDesign**：在 `package.json` 中预置 TDesign 组件库依赖

所有模板都包含基础的小程序项目结构，包括 `app.json`、`app.ts`、`project.config.json` 等核心配置文件。

**Section sources**
- [enums.ts](file://@weapp-core/init/src/enums.ts#L1-L7)
- [createProject.ts](file://@weapp-core/init/src/createProject.ts#L54-L62)

## 初始化流程
项目初始化流程是一个多步骤的过程，涉及模板复制、配置文件生成和依赖管理。

### 主要步骤
1. **目录处理**：确定目标目录，处理已存在目录的覆盖问题
2. **模板复制**：根据用户选择的模板，复制相应的模板文件
3. **配置文件生成**：生成或更新 `package.json`、`project.config.json` 等配置文件
4. **Git 忽略文件处理**：合并默认的 `.gitignore` 规则
5. **依赖版本管理**：确保关键依赖使用最新或兼容版本

### 错误处理
工具在初始化过程中实现了完善的错误处理机制：
- 模板不存在时显示警告信息
- 文件操作失败时捕获并报告错误
- 配置文件写入失败时提供详细的错误信息

**Section sources**
- [createProject.ts](file://@weapp-core/init/src/createProject.ts#L54-L85)
- [projectConfig.ts](file://@weapp-core/init/src/projectConfig.ts#L79-L127)

## 配置文件生成
工具在项目初始化过程中会生成和更新多种配置文件，确保项目开箱即用。

### package.json 生成
`package.json` 文件的生成和更新由 `createOrUpdatePackageJson` 函数处理：
- 设置默认的脚本命令（dev、build 等）
- 添加 `weapp-vite` 作为开发依赖
- 确保关键依赖（如 `miniprogram-api-typings` 和 `typescript`）的版本是最新的
- 支持通过回调函数自定义 package.json 内容

### project.config.json 生成
`project.config.json` 是小程序项目的核心配置文件，工具会：
- 设置默认的小程序根目录为 `dist/`
- 启用 npm 手动打包功能
- 配置合理的编译和打包选项
- 确保 `packNpmRelationList` 包含正确的 npm 打包关系

### .gitignore 处理
工具通过 `mergeGitignore` 函数智能处理 `.gitignore` 文件：
- 读取现有 `.gitignore` 内容（如果存在）
- 合并默认的忽略规则
- 避免重复的忽略规则
- 确保文件格式的规范性（如行尾和空白行）

### 其他配置文件
工具还支持生成其他配置文件：
- **vite.config.ts**：Vite 构建配置文件，包含 `weapp-vite` 的特定配置
- **tsconfig.json**：TypeScript 配置文件
- **tailwind.config.ts**：Tailwind CSS 配置文件（特定模板）

**Section sources**
- [packageJson.ts](file://@weapp-core/init/src/packageJson.ts#L48-L103)
- [projectConfig.ts](file://@weapp-core/init/src/projectConfig.ts#L79-L127)
- [gitignore.ts](file://@weapp-core/init/src/gitignore.ts#L58-L94)
- [updateGitignore.ts](file://@weapp-core/init/src/updateGitignore.ts#L8-L22)
- [viteConfig.ts](file://@weapp-core/init/src/viteConfig.ts#L1-L11)

## 使用示例
以下是 `create-weapp-vite` 工具的实际使用示例。

### 基础使用
```bash
# 交互式创建项目
npx create-weapp-vite

# 非交互式创建项目
npx create-weapp-vite my-app default
```

### 创建不同技术栈的项目
```bash
# 创建集成 Tailwind CSS 的项目
npx create-weapp-vite my-tailwind-app tailwindcss

# 创建使用 Vant 组件库的项目
npx create-weapp-vite my-vant-app vant

# 创建使用 TDesign 组件库的项目
npx create-weapp-vite my-tdesign-app tdesign
```

### 项目创建后的操作
项目创建完成后，可以立即进行开发：
```bash
cd my-app
npm run dev
```

这将启动开发服务器，开发者可以开始编写小程序代码。

**Section sources**
- [cli.ts](file://packages/create-weapp-vite/src/cli.ts#L9-L50)
- [createProject.ts](file://@weapp-core/init/src/createProject.ts#L54-L85)

## 高级用法
对于高级用户，工具提供了扩展和自定义的可能性。

### 自定义模板
虽然工具提供了预定义模板，但开发者可以通过以下方式实现自定义：
1. 创建自己的模板目录结构
2. 参考现有模板的配置文件格式
3. 使用 `createProject` API 直接调用初始化逻辑

### 集成到工作流
工具可以轻松集成到自动化工作流中：
- 在 CI/CD 流程中自动创建项目
- 作为脚本的一部分批量创建多个项目
- 与其他工具链集成，实现完整的开发环境搭建

### API 使用
`@weapp-core/init` 模块提供了丰富的 API，允许开发者在自己的工具中复用初始化逻辑：
- `createProject`：创建项目的核心函数
- `initConfig`：初始化配置文件
- `createOrUpdatePackageJson`：管理 package.json
- `createOrUpdateProjectConfig`：管理 project.config.json

**Section sources**
- [createProject.ts](file://@weapp-core/init/src/createProject.ts#L54-L85)
- [index.ts](file://@weapp-core/init/src/index.ts#L22-L36)

## 结论
`create-weapp-vite` 是一个功能强大且灵活的小程序项目初始化工具。通过其直观的命令行接口、丰富的模板系统和完善的配置文件生成机制，开发者可以快速搭建现代化的小程序开发环境。工具不仅支持多种技术栈，还提供了良好的扩展性，满足从初学者到高级用户的不同需求。其与 `@weapp-core/init` 模块的紧密集成确保了项目初始化过程的可靠性和一致性，为小程序开发提供了坚实的基础。