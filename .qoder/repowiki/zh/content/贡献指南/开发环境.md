# 开发环境

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [package.json](file://package.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)
- [turbo.json](file://turbo.json)
- [monorepo.config.ts](file://monorepo.config.ts)
- [vitest.config.ts](file://vitest.config.ts)
- [eslint.config.js](file://eslint.config.js)
- [tsconfig.json](file://tsconfig.json)
- [scripts/builtin.ts](file://scripts/builtin.ts)
- [scripts/update-auto-import-components.ts](file://scripts/update-auto-import-components.ts)
- [scripts/vite-patch.ts](file://scripts/vite-patch.ts)
- [packages/weapp-vite/package.json](file://packages/weapp-vite/package.json)
- [packages/weapp-vite/src/index.ts](file://packages/weapp-vite/src/index.ts)
- [packages/weapp-vite/bin/weapp-vite.js](file://packages/weapp-vite/bin/weapp-vite.js)
- [apps/plugin-demo/package.json](file://apps/plugin-demo/package.json)
- [apps/plugin-demo/vite.config.mts](file://apps/plugin-demo/vite.config.mts)
- [apps/vite-native-ts/package.json](file://apps/vite-native-ts/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [开发环境准备](#开发环境准备)
4. [依赖管理与Monorepo架构](#依赖管理与monorepo架构)
5. [开发服务器启动与调试](#开发服务器启动与调试)
6. [测试环境配置与Vitest使用](#测试环境配置与vitest使用)
7. [环境变量与多场景配置](#环境变量与多场景配置)
8. [根目录配置文件详解](#根目录配置文件详解)
9. [常见问题解决方案](#常见问题解决方案)
10. [新贡献者环境搭建流程](#新贡献者环境搭建流程)

## 简介
weapp-vite是一个现代化的小程序打包工具，旨在为小程序开发提供现代化的开发体验。本指南将详细介绍如何配置weapp-vite的开发环境，包括依赖安装、开发服务器启动、测试配置、环境变量设置等关键步骤，帮助贡献者快速搭建可复制的开发环境。

## 项目结构
weapp-vite采用Monorepo架构，项目结构清晰，主要包含以下几个部分：
- `@weapp-core/`：核心工具包，包含初始化、日志、示意图等核心功能
- `apps/`：应用示例，包含多个不同配置的示例项目
- `packages/`：主要功能包，包含weapp-vite核心功能
- `templates/`：项目模板，用于快速创建新项目
- `website/`：项目文档网站
- `scripts/`：构建和维护脚本

```mermaid
graph TD
A[项目根目录] --> B[@weapp-core/]
A --> C[apps/]
A --> D[packages/]
A --> E[templates/]
A --> F[website/]
A --> G[scripts/]
B --> B1[init]
B --> B2[logger]
B --> B3[schematics]
B --> B4[shared]
C --> C1[plugin-demo]
C --> C2[vite-native-ts]
D --> D1[weapp-vite]
D --> D2[create-weapp-vite]
E --> E1[weapp-vite-template]
F --> F1[guide]
F --> F2[config]
G --> G1[builtin.ts]
G --> G2[update-auto-import-components.ts]
G --> G3[vite-patch.ts]
```

**图源**
- [package.json](file://package.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)

**本节来源**
- [package.json](file://package.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)

## 开发环境准备
### 系统要求
- Node.js版本：>=20.0.0
- 包管理器：pnpm@10.26.1
- 操作系统：macOS、Linux或Windows

### 环境搭建步骤
1. 克隆项目仓库
2. 安装pnpm包管理器
3. 安装项目依赖
4. 验证环境配置

```bash
# 克隆项目
git clone https://github.com/weapp-vite/weapp-vite.git
cd weapp-vite

# 安装pnpm（如果尚未安装）
npm install -g pnpm@10.26.1

# 安装项目依赖
pnpm install
```

**本节来源**
- [package.json](file://package.json#L6)
- [README.md](file://README.md#L1)

## 依赖管理与Monorepo架构
### Monorepo架构概述
weapp-vite采用Monorepo架构，通过pnpm-workspace.yaml文件定义工作区包，实现多个包的统一管理和依赖共享。

### 依赖安装策略
项目使用pnpm作为包管理器，通过package.json中的packageManager字段指定版本，确保所有开发者使用相同的包管理器版本。

```yaml
# pnpm-workspace.yaml
packages:
  - apps/*
  - templates/*
  - packages/*
  - '@weapp-core/*'
  - website
  - '!**/test/**'

onlyBuiltDependencies:
  - '@swc/core'
  - '@weapp-tailwindcss/merge'
  - oxc-resolver
  - rolldown
  - weapp-tailwindcss

shamefullyHoist: true
```

### 依赖管理最佳实践
- 使用`shamefullyHoist: true`将依赖提升到根节点，避免深层依赖问题
- 通过`onlyBuiltDependencies`指定仅构建依赖
- 利用workspace:*协议实现包间依赖

**本节来源**
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)
- [package.json](file://package.json#L6)

## 开发服务器启动与调试
### 开发服务器启动
通过weapp-vite CLI启动开发服务器，支持热重载和实时预览。

```bash
# 启动开发服务器
pnpm dev

# 启动并自动打开开发者工具
pnpm dev:open
```

### 调试技巧
- 使用`--debug`参数启用调试模式
- 利用Vite的热模块替换(HMR)功能
- 通过浏览器开发者工具进行前端调试
- 使用Node.js调试器进行后端调试

### 示例项目配置
以plugin-demo为例，其package.json中定义了开发脚本：

```json
{
  "scripts": {
    "dev": "weapp-vite dev",
    "dev:open": "weapp-vite dev -o",
    "build": "weapp-vite build",
    "open": "weapp-vite open",
    "g": "weapp-vite generate"
  }
}
```

**本节来源**
- [apps/plugin-demo/package.json](file://apps/plugin-demo/package.json#L12-L16)
- [packages/weapp-vite/package.json](file://packages/weapp-vite/package.json#L87)

## 测试环境配置与Vitest使用
### Vitest配置
项目使用Vitest作为测试框架，通过vitest.config.ts文件进行全局配置，自动发现和运行所有包的测试。

```typescript
// vitest.config.ts
export default defineConfig(() => {
  return {
    test: {
      projects,
      coverage: {
        enabled: true,
        skipFull: true,
        exclude: [
          '**/dist/**',
        ],
      },
      forceRerunTriggers: [
        '**/{vitest,vite}.config.*/**',
      ],
    },
  }
})
```

### 测试命令
```bash
# 运行所有测试
pnpm test

# 启动测试开发服务器
pnpm test:dev

# 运行端到端测试
pnpm e2e
```

### 测试最佳实践
- 为每个包编写单元测试
- 使用vitest的覆盖率功能
- 编写端到端测试验证整体功能
- 利用测试快照确保UI一致性

**本节来源**
- [vitest.config.ts](file://vitest.config.ts)
- [package.json](file://package.json#L26-L28)

## 环境变量与多场景配置
### 环境变量配置
项目支持通过.env文件配置环境变量，不同环境使用不同的配置文件。

```bash
# 根目录下的环境变量文件
.env          # 所有环境通用
.env.local    # 所有环境通用，本地覆盖
.env.development  # 开发环境
.env.production   # 生产环境
```

### 多场景配置
通过vite.config.mts文件进行项目特定配置，支持插件开发等特殊场景。

```typescript
// apps/plugin-demo/vite.config.mts
export default defineConfig({
  weapp: {
    srcRoot: 'miniprogram',
    pluginRoot: 'plugin',
  },
})
```

### 配置继承与覆盖
- 根目录配置为默认配置
- 项目级配置可覆盖默认配置
- 环境变量优先级高于配置文件

**本节来源**
- [apps/plugin-demo/vite.config.mts](file://apps/plugin-demo/vite.config.mts)
- [apps/vite-native-ts/package.json](file://apps/vite-native-ts/package.json)

## 根目录配置文件详解
### package.json
项目根目录的package.json定义了全局脚本、依赖和配置。

```json
{
  "scripts": {
    "build:all": "turbo run build --filter=!./apps/* --filter=!./templates/*",
    "dev": "turbo run dev --filter=!./apps/* --filter=!./templates/* --filter=!./website",
    "test": "vitest run --coverage.enabled",
    "lint": "turbo run lint"
  },
  "devDependencies": {
    "@types/node": "^25.0.3",
    "typescript": "^5.9.3",
    "vite": "^7.3.0",
    "vitest": "~4.0.16"
  }
}
```

### turbo.json
Turbo构建系统配置，定义任务依赖和缓存策略。

```json
{
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "dev": {
      "cache": false
    }
  }
}
```

### 其他关键配置
- tsconfig.json：TypeScript编译配置
- eslint.config.js：代码风格检查配置
- monorepo.config.ts：Monorepo管理配置

**本节来源**
- [package.json](file://package.json)
- [turbo.json](file://turbo.json)
- [tsconfig.json](file://tsconfig.json)
- [eslint.config.js](file://eslint.config.js)
- [monorepo.config.ts](file://monorepo.config.ts)

## 常见问题解决方案
### 依赖冲突
**问题**：pnpm安装依赖时出现冲突
**解决方案**：
1. 清理pnpm缓存：`pnpm store prune`
2. 重新安装依赖：`pnpm install --force`
3. 检查packageManager版本是否匹配

### 构建失败
**问题**：构建过程中出现错误
**解决方案**：
1. 检查Node.js版本是否符合要求
2. 验证pnpm版本是否正确
3. 查看具体错误信息，定位问题模块
4. 清理构建缓存：`pnpm run build:clean`

### 开发服务器无法启动
**问题**：开发服务器启动失败
**解决方案**：
1. 检查端口是否被占用
2. 验证配置文件语法正确性
3. 查看控制台错误日志
4. 尝试重启开发服务器

### 环境变量不生效
**问题**：环境变量未正确加载
**解决方案**：
1. 检查.env文件命名是否正确
2. 验证环境变量名称拼写
3. 确认环境变量加载顺序
4. 重启开发服务器使更改生效

**本节来源**
- [package.json](file://package.json)
- [scripts/vite-patch.ts](file://scripts/vite-patch.ts)
- [packages/weapp-vite/package.json](file://packages/weapp-vite/package.json)

## 新贡献者环境搭建流程
### 完整搭建流程
1. **环境准备**
   - 安装Node.js >= 20.0.0
   - 安装pnpm@10.26.1

2. **项目克隆与依赖安装**
   ```bash
   git clone https://github.com/weapp-vite/weapp-vite.git
   cd weapp-vite
   pnpm install
   ```

3. **验证环境**
   ```bash
   pnpm dev
   pnpm test
   ```

4. **配置IDE**
   - 安装TypeScript支持
   - 配置ESLint和Prettier
   - 设置调试配置

5. **运行示例项目**
   ```bash
   cd apps/plugin-demo
   pnpm dev
   ```

### 贡献指南
- 遵循代码风格规范
- 编写单元测试
- 提交前运行lint检查
- 使用Conventional Commits规范提交信息

### 调试与测试
- 使用`pnpm test:dev`进行交互式测试
- 利用Vite的热重载功能快速验证修改
- 通过`pnpm build`验证构建结果

**本节来源**
- [README.md](file://README.md)
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [package.json](file://package.json)
- [apps/plugin-demo/package.json](file://apps/plugin-demo/package.json)