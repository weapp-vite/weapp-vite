# 代码规范

<cite>
**本文档中引用的文件**  
- [eslint.config.js](file://eslint.config.js)
- [stylelint.config.js](file://stylelint.config.js)
- [commitlint.config.ts](file://commitlint.config.ts)
- [lint-staged.config.js](file://lint-staged.config.js)
- [tsconfig.json](file://tsconfig.json)
- [package.json](file://package.json)
- [apps/vite-native-ts/miniprogram/app.ts](file://apps/vite-native-ts/miniprogram/app.ts)
- [apps/vite-native-ts/miniprogram/app.json](file://apps/vite-native-ts/miniprogram/app.json)
- [packages/weapp-vite/src/index.ts](file://packages/weapp-vite/src/index.ts)
- [@weapp-core/init/src/index.ts](file://@weapp-core/init/src/index.ts)
</cite>

## 目录
1. [引言](#引言)
2. [ESLint配置与代码质量控制](#eslint配置与代码质量控制)
3. [TypeScript类型检查最佳实践](#typescript类型检查最佳实践)
4. [Prettier和Stylelint在代码格式化中的应用](#prettier和stylelint在代码格式化中的应用)
5. [commitlint提交信息规范](#commitlint提交信息规范)
6. [lint-staged预提交钩子工作流程](#lint-staged预提交钩子工作流程)
7. [代码示例对比](#代码示例对比)
8. [总结](#总结)

## 引言
本规范文档旨在为weapp-vite项目的贡献者提供清晰的代码质量标准。文档全面介绍了项目中使用的ESLint、TypeScript、Prettier、Stylelint、commitlint和lint-staged等工具的配置和使用方法，帮助开发者遵循统一的代码风格，确保代码质量和团队协作效率。

## ESLint配置与代码质量控制
weapp-vite项目使用ESLint进行JavaScript/TypeScript代码的静态分析和质量控制。项目通过`eslint.config.js`文件定义了ESLint的配置规则。

项目采用了`@icebreakers/eslint-config`作为基础配置，并根据项目需求进行了扩展。配置中包含了对Vue文件的支持，并定义了全局变量如`wx`、`Page`、`App`、`Component`等微信小程序特有的全局对象，确保在小程序环境中代码不会因使用这些全局变量而报错。

配置中还针对特定目录设置了不同的规则。例如，在`packages/rolldown-require`目录下的TypeScript文件中，关闭了部分严格规则，以适应底层构建工具的特殊需求。这种分层配置方式使得项目可以在保持整体代码风格一致的同时，灵活应对不同模块的特殊需求。

**Section sources**
- [eslint.config.js](file://eslint.config.js#L1-L49)
- [package.json](file://package.json#L101-L102)

## TypeScript类型检查最佳实践
weapp-vite项目使用TypeScript进行类型检查，通过`tsconfig.json`文件配置编译选项。项目采用了严格的类型检查模式，确保代码的类型安全。

配置中启用了`strict`模式，这包括了`noImplicitAny`、`strictNullChecks`、`strictFunctionTypes`等严格的类型检查选项。同时，项目设置了`target`和`module`为`ESNext`，充分利用现代JavaScript的特性。`moduleResolution`设置为`Bundler`，适应现代打包工具的模块解析方式。

项目还配置了`resolveJsonModule: true`，允许直接导入JSON文件。`types`数组中包含了`node`和`vitest/globals`，为Node.js环境和测试环境提供类型定义。`noEmit: true`的设置表明TypeScript仅用于类型检查，不生成编译后的JavaScript文件，这通常与其他构建工具（如Vite）配合使用。

为了确保整个项目的类型一致性，`include`字段包含了所有主要目录，如`apps`、`packages`、`templates`等，而`exclude`字段则排除了`node_modules`、`dist`等不需要检查的目录。

**Section sources**
- [tsconfig.json](file://tsconfig.json#L1-L48)
- [package.json](file://package.json#L151)

## Prettier和Stylelint在代码格式化中的应用
weapp-vite项目使用Prettier和Stylelint进行代码格式化。Prettier负责JavaScript、TypeScript、JSON、Markdown等文件的格式化，而Stylelint则专门负责CSS、SCSS等样式文件的格式化。

项目通过`stylelint.config.js`文件配置Stylelint，同样采用了`@icebreakers/stylelint-config`作为基础配置。这种集中式的配置管理确保了样式代码的一致性。

在`lint-staged.config.js`中，虽然Prettier的格式化命令被注释掉了，但配置结构显示了项目原本计划使用Prettier进行多类型文件的格式化。当前配置主要依赖ESLint进行代码修复，这可能是由于项目采用了ESLint的格式化功能来统一代码风格。

**Section sources**
- [stylelint.config.js](file://stylelint.config.js#L1-L4)
- [lint-staged.config.js](file://lint-staged.config.js#L5-L8)

## commitlint提交信息规范
weapp-vite项目使用commitlint来规范Git提交信息的格式。项目通过`commitlint.config.ts`文件配置了提交信息的规则。

配置中使用了`@icebreakers/commitlint-config`作为基础配置，这是一种集中管理的提交信息规范。这种配置确保了所有贡献者的提交信息都遵循统一的格式，便于生成变更日志和进行版本管理。

虽然具体规则未在配置文件中展开，但基于`@icebreakers/commitlint-config`的命名约定，可以推断项目采用了类似Conventional Commits的规范，包括提交类型（如feat、fix、docs等）、作用范围和描述信息。

**Section sources**
- [commitlint.config.ts](file://commitlint.config.ts#L1-L4)
- [package.json](file://package.json#L62-L63)

## lint-staged预提交钩子工作流程
weapp-vite项目使用lint-staged和Husky来实现预提交钩子，确保提交的代码符合质量标准。

`lint-staged.config.js`文件定义了在Git暂存区文件提交前要执行的任务。配置中，对于JavaScript、TypeScript等脚本文件，执行`eslint --fix`命令，自动修复可修复的代码问题。对于JSON、Markdown、CSS等文件，也执行相同的ESLint修复命令，尽管这些文件类型通常不被ESLint处理，这可能是为了确保配置的一致性或未来扩展。

预提交钩子通过`package.json`中的`prepare`脚本自动安装Husky，确保开发者在克隆项目后无需手动配置Git钩子。当开发者执行`git commit`时，lint-staged会自动运行，对暂存区的文件执行配置的任务，只有所有任务成功完成后，提交才会被创建。

**Section sources**
- [lint-staged.config.js](file://lint-staged.config.js#L1-L12)
- [package.json](file://package.json#L118)

## 代码示例对比
以下代码示例展示了weapp-vite项目中正确的代码风格：

```typescript
// 正确：遵循TypeScript严格模式和ESLint规则
App({
  globalData: {},
  onLaunch() {
    const logs = wx.getStorageSync('logs') || []
    logs.unshift(Date.now())
    wx.setStorageSync('logs', logs)

    wx.login({
      success: (res) => {
        console.log(res.code)
      },
    })
  },
})
```

```typescript
// 正确：模块导出遵循项目约定
export * from './config'
export * from './createContext'
export * from './types/external'
```

```typescript
// 正确：函数定义和异步操作
export async function initConfig(options: { root?: string, command?: 'weapp-vite' }) {
  const { root = process.cwd(), command } = options

  await createOrUpdateProjectConfig({ root })
  await createOrUpdatePackageJson({ root, command })
  await updateGitIgnore({ root })

  if (command === 'weapp-vite') {
    await initViteConfigFile({ root })
    await initTsDtsFile({ root })
    await initTsJsonFiles({ root })
  }

  return ctx
}
```

错误的写法可能包括：使用var声明变量、不使用类型注解、不遵循命名约定、不处理异步操作的错误等。这些都会被ESLint和TypeScript编译器捕获并报错。

**Section sources**
- [apps/vite-native-ts/miniprogram/app.ts](file://apps/vite-native-ts/miniprogram/app.ts#L1-L19)
- [packages/weapp-vite/src/index.ts](file://packages/weapp-vite/src/index.ts#L1-L4)
- [@weapp-core/init/src/index.ts](file://@weapp-core/init/src/index.ts#L1-L37)

## 总结
weapp-vite项目建立了一套完整的代码质量保障体系，通过ESLint、TypeScript、Prettier、Stylelint、commitlint和lint-staged等工具的协同工作，确保了代码的一致性、可维护性和高质量。贡献者应遵循本规范，在开发过程中充分利用这些工具提供的反馈，共同维护项目的代码质量。