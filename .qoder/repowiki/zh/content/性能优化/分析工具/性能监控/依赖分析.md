# 依赖分析

<cite>
**本文档引用的文件**
- [analyze.ts](file://packages/weapp-vite/src/cli/commands/analyze.ts)
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts)
- [dashboard.ts](file://packages/weapp-vite/src/cli/analyze/dashboard.ts)
- [packagePaths.ts](file://packages/weapp-vite/src/packagePaths.ts)
- [types.ts](file://packages/weapp-vite/src/cli/types.ts)
- [analyze-dashboard/main.ts](file://packages/weapp-vite/analyze-dashboard/main.ts)
- [analyze-dashboard/useTreemapData.ts](file://packages/weapp-vite/analyze-dashboard/useTreemapData.ts)
</cite>

## 目录
1. [功能概述](#功能概述)
2. [依赖分析机制](#依赖分析机制)
3. [配置与使用](#配置与使用)
4. [结果解读与优化](#结果解读与优化)
5. [可视化仪表盘](#可视化仪表盘)
6. [最佳实践](#最佳实践)

## 功能概述

依赖分析功能用于分析小程序项目的分包结构和依赖关系，帮助开发者识别直接依赖、间接依赖和重复依赖。该功能通过扫描项目构建产物，生成详细的依赖关系报告，支持命令行输出和可视化仪表盘两种展示方式。

**本文档引用的文件**
- [analyze.ts](file://packages/weapp-vite/src/cli/commands/analyze.ts)
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts)

## 依赖分析机制

依赖分析功能通过以下步骤实现依赖关系的识别和分析：

1. **扫描服务初始化**：加载应用入口文件和分包配置
2. **构建产物分析**：解析主包和独立分包的构建输出
3. **依赖分类**：将依赖分为主包、分包、独立分包和虚拟包四种类型
4. **模块映射**：建立源码模块与打包产物的映射关系

分析过程中，系统会识别以下依赖类型：
- **直接依赖**：被单个分包直接引用的模块
- **间接依赖**：通过其他依赖间接引入的模块
- **重复依赖**：被多个分包共同引用的模块

```mermaid
graph TD
A[开始分析] --> B[加载应用配置]
B --> C[扫描分包结构]
C --> D[分析构建产物]
D --> E[分类依赖类型]
E --> F[生成映射关系]
F --> G[输出分析结果]
```

**图表来源**
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L539-L601)

**本节来源**
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L539-L601)

## 配置与使用

### CLI命令配置

通过`weapp-vite analyze`命令启动依赖分析，支持以下选项：

```mermaid
flowchart TD
Start([weapp-vite analyze]) --> Option1["--json: 输出JSON结果"]
Start --> Option2["--output <file>: 将结果写入指定文件"]
Start --> Option3["-p, --platform <platform>: 指定目标平台"]
Option1 --> End
Option2 --> End
Option3 --> End
```

**图表来源**
- [analyze.ts](file://packages/weapp-vite/src/cli/commands/analyze.ts#L76-L136)

### 运行时配置

在开发服务器中启用实时分析：

```mermaid
sequenceDiagram
participant CLI as 命令行
participant Server as 开发服务器
participant Analyzer as 分析器
CLI->>Server : 启动服务 --analyze
Server->>Analyzer : 初始化分析上下文
Analyzer->>Analyzer : 加载应用配置
Analyzer->>Analyzer : 扫描分包结构
Analyzer->>Server : 返回分析结果
Server->>CLI : 启动仪表盘并显示URL
```

**图表来源**
- [dashboard.ts](file://packages/weapp-vite/src/cli/analyze/dashboard.ts#L1-L172)
- [serve.ts](file://packages/weapp-vite/src/cli/commands/serve.ts#L15-L47)

**本节来源**
- [analyze.ts](file://packages/weapp-vite/src/cli/commands/analyze.ts#L76-L136)
- [dashboard.ts](file://packages/weapp-vite/src/cli/analyze/dashboard.ts#L1-L172)

## 结果解读与优化

### 分析结果结构

分析结果包含三个主要部分：
- **packages**：分包信息，包括主包、分包和独立分包
- **modules**：模块使用情况，记录每个模块在哪些分包中被使用
- **subPackages**：分包配置描述

```mermaid
erDiagram
PACKAGE {
string id PK
string label
string type
array files FK
}
MODULE {
string id PK
string source
string sourceType
array packages FK
}
FILE {
string file PK
string type
string from
number size
array modules FK
}
PACKAGE ||--o{ FILE : 包含
MODULE ||--o{ FILE : 使用
```

**图表来源**
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L32-L56)

### 优化建议

根据分析结果，可以采取以下优化措施：

1. **依赖升级**：识别过时的依赖版本并进行升级
2. **替代方案选择**：用更轻量的库替代大型依赖
3. **依赖树精简**：移除未使用的依赖和重复依赖

```mermaid
flowchart TD
A[分析结果] --> B{存在重复依赖?}
B --> |是| C[提取公共依赖到主包]
B --> |否| D[检查未使用依赖]
D --> E[移除未使用依赖]
C --> F[重新构建验证]
E --> F
F --> G[性能提升]
```

**图表来源**
- [useTreemapData.ts](file://packages/weapp-vite/analyze-dashboard/useTreemapData.ts#L164-L226)

**本节来源**
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L32-L56)
- [useTreemapData.ts](file://packages/weapp-vite/analyze-dashboard/useTreemapData.ts#L164-L226)

## 可视化仪表盘

### 仪表盘架构

可视化仪表盘采用Vue 3构建，通过WebSocket实现实时更新：

```mermaid
graph LR
A[分析器] --> |WebSocket| B[前端界面]
B --> C[树图可视化]
B --> D[统计摘要]
B --> E[重复依赖列表]
C --> F[交互式探索]
D --> G[关键指标]
E --> H[优化建议]
```

**图表来源**
- [main.ts](file://packages/weapp-vite/analyze-dashboard/main.ts#L1-L35)
- [dashboard.ts](file://packages/weapp-vite/src/cli/analyze/dashboard.ts#L1-L172)

### 启动流程

```mermaid
sequenceDiagram
participant User as 用户
participant CLI as 命令行工具
participant Server as Vite服务器
participant Dashboard as 仪表盘
User->>CLI : 执行 analyze 命令
CLI->>Server : 创建分析上下文
Server->>Server : 执行依赖分析
Server->>Dashboard : 启动仪表盘服务器
Dashboard->>User : 返回访问URL
User->>Dashboard : 浏览分析结果
Dashboard->>Server : 监听更新事件
```

**图表来源**
- [dashboard.ts](file://packages/weapp-vite/src/cli/analyze/dashboard.ts#L1-L172)

**本节来源**
- [main.ts](file://packages/weapp-vite/analyze-dashboard/main.ts#L1-L35)
- [dashboard.ts](file://packages/weapp-vite/src/cli/analyze/dashboard.ts#L1-L172)

## 最佳实践

### 依赖管理流程

建立规范的依赖审查流程：

```mermaid
flowchart TD
A[引入新依赖] --> B[评估必要性]
B --> C[检查许可证]
C --> D[分析包大小]
D --> E[测试兼容性]
E --> F[代码审查]
F --> G[合并到主干]
G --> H[定期审计]
```

### 健康度指标

建立依赖健康度评估体系：

| 指标 | 计算方法 | 健康阈值 |
|------|--------|---------|
| 重复依赖率 | 重复模块数/总模块数 | < 15% |
| 未使用依赖率 | 未使用依赖数/总依赖数 | < 5% |
| 平均包大小 | 总大小/分包数 | < 2MB |
| 主包占比 | 主包大小/总大小 | < 40% |

**本节来源**
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L164-L226)
- [analyze.ts](file://packages/weapp-vite/src/cli/commands/analyze.ts#L14-L74)