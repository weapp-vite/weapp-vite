# 构建时间分析

<cite>
**本文档引用的文件**
- [vite-plugin-performance/README.zh-CN.md](file://packages/vite-plugin-performance/README.zh-CN.md)
- [vite-plugin-performance/src/index.ts](file://packages/vite-plugin-performance/src/index.ts)
- [vite-plugin-performance/src/wrapPlugin.ts](file://packages/vite-plugin-performance/src/wrapPlugin.ts)
- [vite-plugin-performance/src/options.ts](file://packages/vite-plugin-performance/src/options.ts)
- [vite-plugin-performance/src/constants.ts](file://packages/vite-plugin-performance/src/constants.ts)
- [vite-plugin-performance/src/types.ts](file://packages/vite-plugin-performance/src/types.ts)
- [weapp-vite/src/plugins/index.ts](file://packages/weapp-vite/src/plugins/index.ts)
</cite>

## 目录
1. [简介](#简介)
2. [功能原理](#功能原理)
3. [配置选项](#配置选项)
4. [数据收集机制](#数据收集机制)
5. [报告解读与性能瓶颈识别](#报告解读与性能瓶颈识别)
6. [优化建议](#优化建议)
7. [高级使用场景](#高级使用场景)
8. [结论](#结论)

## 简介

构建时间分析功能是通过 `vite-plugin-performance` 插件实现的，该插件专门用于监控和记录 Vite 构建过程中的各个阶段耗时。通过包裹 Vite 插件并测量其生命周期钩子的执行时间，开发者可以快速定位构建链路中的性能瓶颈。该插件保持了原有插件的行为不变，仅在钩子执行完成后采集数据并按需输出或上报。

**Section sources**
- [vite-plugin-performance/README.zh-CN.md](file://packages/vite-plugin-performance/README.zh-CN.md#L5-L14)

## 功能原理

`vite-plugin-performance` 通过包裹 Vite 插件来监控其生命周期钩子的执行时间。当构建过程中的某个钩子耗时超过预设阈值时，插件会记录该事件并输出相关信息。这种机制允许开发者在不影响构建流程的情况下，收集详细的性能数据。

插件支持同时包裹单个插件或插件数组，并内置了常用的钩子列表。开发者可以选择使用 `hooks: 'all'` 来包裹所有函数钩子，从而获得更全面的性能数据。此外，插件还兼容异步钩子，即使在发生异常的情况下也能正确统计耗时。

**Section sources**
- [vite-plugin-performance/README.zh-CN.md](file://packages/vite-plugin-performance/README.zh-CN.md#L9-L13)

## 配置选项

### 基本配置

要启用时间分析功能，首先需要安装 `vite-plugin-performance` 插件：

```bash
pnpm add -D vite-plugin-performance
```

然后在 Vite 配置文件中引入并使用 `wrapPlugin` 函数来包裹目标插件：

```ts
import { defineConfig } from 'vite'
import Inspect from 'vite-plugin-inspect'
import { wrapPlugin } from 'vite-plugin-performance'

export default defineConfig({
  plugins: [
    wrapPlugin(Inspect(), {
      threshold: 50,
      onHookExecution({ pluginName, hookName, duration }) {
        reportToAPM({ pluginName, hookName, duration })
      },
    }),
  ],
})
```

### 详细选项说明

| 选项 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `hooks` | `PluginHookName[] \| 'all'` | `DEFAULT_PLUGIN_HOOKS` | 指定需要包裹的钩子；传 `all` 包裹所有函数钩子 |
| `threshold` | `number` | `0` | 只有耗时大于等于该值的钩子才会被记录 |
| `silent` | `boolean` | `false` | 关闭内置日志输出 |
| `logger` | `(message, context) => void` | `console.log` | 自定义日志输出函数 |
| `formatter` | `(context) => string` | `[plugin] transform ⏱  12.34 ms` | 自定义日志内容格式 |
| `onHookExecution` | `(context) => void` | `undefined` | 钩子执行完毕后触发，可用于上报 |
| `clock` | `() => number` | `performance.now` 或 `Date.now` | 高精度计时器，便于测试或自定义时间源 |

> 兼容早期误拼写的 `slient` 选项，会自动映射为 `silent`。

**Section sources**
- [vite-plugin-performance/README.zh-CN.md](file://packages/vite-plugin-performance/README.zh-CN.md#L49-L59)
- [vite-plugin-performance/src/options.ts](file://packages/vite-plugin-performance/src/options.ts#L15-L35)

## 数据收集机制

### 默认钩子列表

`vite-plugin-performance` 内置了一个默认的钩子列表，涵盖了构建过程中最常见的生命周期钩子：

```ts
import { DEFAULT_PLUGIN_HOOKS } from 'vite-plugin-performance'
// [
//   'options',
//   'config',
//   'configResolved',
//   'configureServer',
//   'buildStart',
//   'resolveId',
//   'load',
//   'transform',
//   'buildEnd',
//   'generateBundle',
//   'renderChunk',
//   'writeBundle',
// ]
```

这些钩子覆盖了从配置解析到最终打包输出的整个构建流程，确保能够捕捉到关键环节的耗时情况。

### 执行时间统计

插件通过在每个钩子的开始和结束处插入计时代码来统计执行时间。具体实现如下：

1. 在钩子执行前记录开始时间
2. 执行原始钩子逻辑
3. 在钩子执行后计算耗时
4. 如果耗时超过阈值，则触发日志输出或回调函数

对于异步钩子，插件会等待 Promise 完成后再计算最终耗时，确保统计结果的准确性。

**Section sources**
- [vite-plugin-performance/src/wrapPlugin.ts](file://packages/vite-plugin-performance/src/wrapPlugin.ts#L26-L48)
- [vite-plugin-performance/src/constants.ts](file://packages/vite-plugin-performance/src/constants.ts#L3-L16)

## 报告解读与性能瓶颈识别

当某个钩子耗时超过设置的阈值（默认 0 ms）时，控制台会输出类似以下的信息：

```
[inspect] transform            ⏱   78.42 ms
```

这条信息包含了插件名称、钩子名称和执行耗时，帮助开发者快速定位耗时较长的操作。通过分析这些报告，可以识别出构建过程中的性能热点，例如：

- **解析阶段**：`resolveId` 和 `load` 钩子耗时过长可能表明依赖解析存在问题
- **编译阶段**：`transform` 钩子耗时过长可能表明代码转换逻辑过于复杂
- **打包阶段**：`generateBundle` 和 `renderChunk` 钩子耗时过长可能表明模块依赖关系复杂或代码量过大

**Section sources**
- [vite-plugin-performance/README.zh-CN.md](file://packages/vite-plugin-performance/README.zh-CN.md#L41-L45)

## 优化建议

### 代码分割

通过合理的代码分割策略，可以减少单个模块的大小，从而降低 `transform` 和 `renderChunk` 钩子的耗时。建议使用动态导入（`import()`）来实现按需加载，避免一次性加载过多代码。

### 缓存策略

利用 Vite 的缓存机制，可以显著提升重复构建的速度。确保 `buildStart` 和 `buildEnd` 钩子的耗时尽可能短，可以通过启用持久化缓存来实现。

### 依赖优化

检查项目中的第三方依赖，移除不必要的库或替换为更轻量级的替代品。对于大型依赖，考虑使用 CDN 引入或按需加载，以减少构建时的处理负担。

**Section sources**
- [vite-plugin-performance/README.zh-CN.md](file://packages/vite-plugin-performance/README.zh-CN.md#L11-L12)

## 高级使用场景

### 持续集成环境中的性能基准比较

在持续集成（CI）环境中，可以将 `vite-plugin-performance` 的输出结果保存为性能基准数据。每次构建时，将当前的性能数据与历史基准进行比较，及时发现性能退化问题。

### 回归检测

通过设置严格的阈值，可以在每次构建时自动检测是否存在性能回归。如果某个钩子的耗时突然增加，可以立即发出警报，提醒开发者检查最近的代码变更是否引入了性能问题。

**Section sources**
- [vite-plugin-performance/README.zh-CN.md](file://packages/vite-plugin-performance/README.zh-CN.md#L12-L13)

## 结论

`vite-plugin-performance` 提供了一种简单而有效的方式来监控和优化 Vite 构建过程的性能。通过合理配置和使用该插件，开发者可以深入了解构建流程中的各个阶段耗时，识别并解决性能瓶颈，最终提升开发效率和用户体验。