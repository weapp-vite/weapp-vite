# 分包优化

<cite>
**本文档中引用的文件**   
- [app.json](file://apps/subpackage-shared-chunks/src/app.json)
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts)
- [docs/subpackages.md](file://docs/subpackages.md)
- [website/guide/subpackage.md](file://website/guide/subpackage.md)
- [website/config/subpackages.md](file://website/config/subpackages.md)
</cite>

## 目录
1. [引言](#引言)
2. [分包配置基础](#分包配置基础)
3. [独立分包实现机制](#独立分包实现机制)
4. [预下载分包策略](#预下载分包策略)
5. [主包优化与共享策略](#主包优化与共享策略)
6. [分包依赖与资源复用](#分包依赖与资源复用)
7. [分包大小优化建议](#分包大小优化建议)
8. [常见问题与解决方案](#常见问题与解决方案)
9. [性能影响分析](#性能影响分析)

## 引言

微信小程序的分包机制在 `weapp-vite` 中得到完整支持。通过合理拆分分包，可以显著提升首屏加载速度并有效控制包体大小。本文档深入探讨独立分包、预下载分包和主包优化的实现机制，详细说明如何通过配置 `subpackages` 实现最优的分包策略。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#L1-L151)
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L1-L244)

## 分包配置基础

在 `weapp-vite` 中，分包配置直接读取 `app.json` 文件，无需额外的 DSL。开发者可以通过 `weapp.subPackages` 为每个分包追加独立编译、依赖裁剪、样式共享和组件自动导入等高级能力。

```jsonc
// src/app.json
{
  "pages": [
    "pages/index/index"
  ],
  "subpackages": [
    {
      "root": "packages/order",
      "name": "订单中心",
      "pages": ["index", "detail"],
      "independent": true
    },
    {
      "root": "packages/profile",
      "pages": ["index", "settings"]
    }
  ],
  "preloadRule": {
    "pages/index/index": {
      "packages": ["packages/profile"],
      "network": "all",
      "timeout": 2000
    }
  },
  "lazyCodeLoading": "requiredComponents"
}
```

**Section sources**
- [apps/subpackage-shared-chunks/src/app.json](file://apps/subpackage-shared-chunks/src/app.json#L1-L40)

## 独立分包实现机制

独立分包运行在独立的上下文中，无法直接访问主包的全局数据。通过 `weapp.subPackages.<root>.dependencies` 可以精确控制 `miniprogram_npm` 产物，防止主包依赖泄漏到独立分包。

```ts
// vite.config.ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packages/order': {
        independent: true,
        dependencies: ['crypto-es'],
        styles: [
          'styles/theme.scss',
          {
            source: '../shared/styles/components.scss',
            scope: 'components',
            include: ['components/**']
          }
        ]
      }
    }
  }
})
```

**Section sources**
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L1-L83)
- [website/config/subpackages.md](file://website/config/subpackages.md#L7-L112)

## 预下载分包策略

分包预下载通过 `preloadRule` 提前拉取关键分包，提升用户体验。在 `app.json` 中声明触发页、目标分包、网络条件和超时时间。

```jsonc
"preloadRule": {
  "pages/index/index": {
    "packages": ["packages/profile"],
    "network": "all",
    "timeout": 2000
  }
}
```

开发者可以在页面 `onLoad` 中结合 `wx.preloadSubpackage` 做二次确认，实现更细粒度的控制。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#L125-L129)
- [apps/subpackage-shared-chunks/src/app.json](file://apps/subpackage-shared-chunks/src/app.json#L24-L29)

## 主包优化与共享策略

主包应保持最小化，只保留首屏必要的页面和基座逻辑。通过 `chunks.sharedStrategy` 控制跨包共享模块的输出策略，避免主包/分包体积异常。

```ts
export default defineConfig({
  weapp: {
    chunks: {
      sharedStrategy: 'duplicate',
      duplicateWarningBytes: 256 * 1024
    }
  }
})
```

当 `sharedStrategy` 设置为 `duplicate` 时，跨分包共享模块会复制到各自分包的 `weapp-shared/common.js`，以换取更低的冷启动开销。

**Section sources**
- [apps/subpackage-shared-chunks/vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts#L60-L63)
- [docs/subpackages.md](file://docs/subpackages.md#L15-L16)

## 分包依赖与资源复用

`weapp.subPackages[].styles` 能把重复的 `@import` 交还给构建器处理，声明一次主题、设计令牌或基础布局，普通分包与独立分包都会在生成样式时自动插入对应的共享入口。

```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packages/member': {
        styles: [
          'styles/tokens.css',
          { source: 'styles/layout.wxss', scope: 'pages' }
        ]
      },
      'packages/offline': {
        independent: true,
        styles: [
          {
            source: 'styles/offline-theme.scss',
            include: ['pages/**/*.wxss', 'components/**/*.wxss']
          }
        ]
      }
    }
  }
})
```

**Section sources**
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L160-L198)
- [website/config/subpackages.md](file://website/config/subpackages.md#L81-L112)

## 分包大小优化建议

1. **保持主包最小化**：首屏只保留必要页面与基座逻辑，其余业务模块放入分包。
2. **以业务边界拆分**：分包根目录与域名一致，方便团队协作与权限划分。
3. **评估独立性**：需要自定义 TabBar、插件能力或明显跨团队交付的模块优先考虑 `independent: true`。
4. **同步规划代码共享**：公共工具、样式、国际化资源放在主包或公共目录，由构建器负责复制或抽取。
5. **配合运营节奏预下载**：首屏后立即可能访问的分包通过 `preloadRule` 预加载。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#L18-L24)

## 常见问题与解决方案

- **本地运行时报路径错误？** 检查页面是否引用了其他分包的资源，或在 `weapp.chunks` 中启用了与项目不符的策略。
- **产物体积过大？** 使用 `weapp.subPackages[].dependencies` 精确声明每个独立分包需要的 npm 依赖，剩余依赖保持在主包。
- **想在分包中调试 Worker？** 记得同时在 `weapp.worker` 中声明入口，并确保 Worker 文件位于对应分包目录。

**Section sources**
- [website/guide/subpackage.md](file://website/guide/subpackage.md#L240-L244)

## 性能影响分析

合理规划分包并结合 `weapp-vite` 的构建能力，可以在保证首屏体验的同时降低维护成本。执行 `pnpm run analyze` 可生成分包报告，定位共享依赖和重复模块。

- 若分包样式缺失，确认 `styles` 定义的文件是否存在，以及 `include` / `exclude` 是否匹配实际路径。
- 关注构建日志中的 `[subpackages]` 警告：它们通常意味着路径超出 `srcRoot`、格式不受支持或重复注册。
- 检查微信开发者工具的包体积面板，确保主包 < 2MB、单个分包 < 2MB，所有分包合计 < 20MB。

**Section sources**
- [docs/subpackages.md](file://docs/subpackages.md#L137-L142)