# 加载策略

<cite>
**本文档中引用的文件**  
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts)
- [core.ts](file://packages/weapp-vite/src/plugins/core.ts)
- [sharedBuildConfig.ts](file://packages/weapp-vite/src/runtime/sharedBuildConfig.ts)
- [advancedChunks.ts](file://packages/weapp-vite/src/runtime/advancedChunks.ts)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
- [subpackage.md](file://website/guide/subpackage.md)
</cite>

## 目录
1. [引言](#引言)
2. [核心加载机制](#核心加载机制)
3. [配置优化资源加载](#配置优化资源加载)
4. [代码分割与资源优化协同](#代码分割与资源优化协同)
5. [具体配置选项与使用示例](#具体配置选项与使用示例)
6. [性能收益分析](#性能收益分析)
7. [高级加载策略技巧](#高级加载策略技巧)
8. [结论](#结论)

## 引言

weapp-vite 是一个专为微信小程序优化的构建工具，其加载策略在提升小程序启动速度和用户体验方面起着至关重要的作用。本文档将深入探讨 weapp-vite 的预加载、懒加载和优先级加载等运行时加载机制，详细说明如何通过配置优化资源加载顺序和时机，并阐述这些策略如何与代码分割和资源优化协同工作以最大化运行时性能。

## 核心加载机制

weapp-vite 的加载策略主要围绕预加载、懒加载和优先级加载展开。这些机制共同作用，确保小程序在启动时能够快速响应用户操作，同时在运行过程中按需加载必要的资源，避免一次性加载过多不必要的代码。

### 预加载

预加载是指在小程序启动初期，提前加载一些关键资源，如主包中的公共模块、常用组件和基础库。weapp-vite 通过分析依赖关系，自动识别并预加载这些资源，从而减少用户首次打开小程序时的等待时间。

### 懒加载

懒加载则是指在需要时才加载特定资源。对于不常用或非关键路径上的资源，weapp-vite 采用懒加载策略，只有当用户触发相关操作时才会加载相应的代码块。这种方式可以显著减少初始加载时间，提高用户体验。

### 优先级加载

优先级加载是根据资源的重要性和使用频率来决定加载顺序的一种策略。weapp-vite 允许开发者通过配置指定某些资源的加载优先级，确保高优先级的资源能够优先加载，从而保证核心功能的快速响应。

## 配置优化资源加载

为了进一步优化资源加载，weapp-vite 提供了丰富的配置选项，允许开发者根据具体需求调整加载策略。

### sharedStrategy 配置

`sharedStrategy` 是 weapp-vite 中用于控制共享模块加载策略的核心配置项。它支持两种主要策略：`hoist` 和 `duplicate`。

- **hoist**：将共享模块提升到主包中，所有分包都可以引用该模块。这种方式减少了重复代码，但可能会增加主包的体积。
- **duplicate**：在每个分包中复制共享模块，确保每个分包都能独立运行。这种方式增加了代码冗余，但可以减少主包的负担，加快分包的加载速度。

### forceDuplicatePatterns 配置

`forceDuplicatePatterns` 允许开发者指定某些模块必须在每个分包中复制，即使它们位于主包目录中。这可以通过正则表达式或字符串模式来定义，适用于那些需要在多个分包中独立运行的模块。

## 代码分割与资源优化协同

weapp-vite 的加载策略与代码分割和资源优化紧密结合，共同实现最佳的性能表现。

### 代码分割

weapp-vite 利用 Rollup 的代码分割功能，将应用程序拆分为多个小的代码块。每个代码块可以根据需要独立加载，从而减少初始加载时间。通过 `advancedChunks` 配置，开发者可以自定义代码块的命名规则和分组策略，进一步优化资源组织。

### 资源优化

除了代码分割，weapp-vite 还提供了多种资源优化手段，如压缩、去重和缓存。这些优化措施与加载策略相结合，确保每个资源都能以最高效的方式被加载和使用。

## 具体配置选项与使用示例

### 配置示例

以下是一个典型的 weapp-vite 配置示例，展示了如何设置 `sharedStrategy` 和 `forceDuplicatePatterns`：

```typescript
// vite.config.ts
import { defineConfig } from 'weapp-vite'

export default defineConfig({
  chunks: {
    sharedStrategy: 'duplicate', // 或 'hoist'
    forceDuplicatePatterns: [
      /node_modules\/some-library/,
      'src/utils/special-util.ts'
    ],
    logOptimization: true,
    duplicateWarningBytes: 10240 // 10KB
  }
})
```

### 使用示例

假设有一个名为 `utils.ts` 的公共工具模块，被多个分包引用。通过配置 `sharedStrategy` 为 `duplicate`，weapp-vite 会将 `utils.ts` 复制到每个分包的 `weapp-shared/common.js` 文件中，确保每个分包都能独立运行。

```typescript
// src/utils.ts
export function doSomething() {
  // 实现具体逻辑
}

// packageA/index.ts
import { doSomething } from '@/utils'
doSomething()

// packageB/index.ts
import { doSomething } from '@/utils'
doSomething()
```

## 性能收益分析

通过合理配置加载策略，weapp-vite 可以显著提升小程序的性能表现。

### 启动速度

预加载和优先级加载机制确保了关键资源的快速加载，减少了用户等待时间，提高了小程序的启动速度。

### 用户体验

懒加载和代码分割使得小程序在运行过程中能够按需加载资源，避免了不必要的资源浪费，提升了整体用户体验。

### 资源利用率

通过 `sharedStrategy` 和 `forceDuplicatePatterns` 的灵活配置，weapp-vite 能够在减少代码冗余和减轻主包负担之间找到平衡点，最大化资源利用率。

## 高级加载策略技巧

### 使用 `take:` 前缀

weapp-vite 支持使用 `take:` 前缀强制将某个模块复制到指定分包中。这对于少量公共逻辑随分包打包非常有用。

```typescript
// 位于 packageA 的页面
import { doSomething } from 'take:@/utils/shared'
```

### TypeScript 配置

为了让 TypeScript 正确识别 `take:` 写法，需要在 `tsconfig.json` 中添加相应的路径映射：

```json
{
  "compilerOptions": {
    "paths": {
      "@/*": ["src/*"],
      "take:@/*": ["src/*"]
    }
  }
}
```

### 分析工具

weapp-vite 提供了 `analyze` 命令，可以帮助开发者分析构建产物，定位潜在的性能瓶颈。通过运行 `weapp-vite analyze`，可以查看各个代码块的大小和引用情况，进而优化加载策略。

## 结论

weapp-vite 的加载策略通过预加载、懒加载和优先级加载等多种机制，结合代码分割和资源优化，实现了小程序性能的最大化。通过合理配置 `sharedStrategy` 和 `forceDuplicatePatterns`，开发者可以根据具体需求调整加载策略，提升小程序的启动速度和用户体验。此外，利用 `take:` 前缀和分析工具，还可以进一步优化资源加载，确保小程序在各种场景下都能表现出色。

**Section sources**
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts)
- [core.ts](file://packages/weapp-vite/src/plugins/core.ts)
- [sharedBuildConfig.ts](file://packages/weapp-vite/src/runtime/sharedBuildConfig.ts)
- [advancedChunks.ts](file://packages/weapp-vite/src/runtime/advancedChunks.ts)
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
- [subpackage.md](file://website/guide/subpackage.md)