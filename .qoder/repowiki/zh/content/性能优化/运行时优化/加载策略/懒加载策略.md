# 懒加载策略

<cite>
**本文档引用的文件**   
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts)
- [core.ts](file://packages/weapp-vite/src/plugins/core.ts)
- [app.json.ts](file://apps/vite-native/app.json.ts)
- [detail.ts](file://apps/subpackage-shared-chunks/src/packages/order/detail.ts)
- [index.ts](file://apps/wevu-runtime-demo/src/subpackages/perf/pages/chunk/index.ts)
- [type.auto.ts](file://@weapp-core/schematics/src/type.auto.ts)
- [app.json](file://apps/subpackage-shared-chunks/src/app.json)
</cite>

## 目录
1. [引言](#引言)
2. [懒加载机制实现原理](#懒加载机制实现原理)
3. [懒加载配置方法](#懒加载配置方法)
4. [实际应用案例](#实际应用案例)
5. [性能影响与优化建议](#性能影响与优化建议)
6. [代码分割集成](#代码分割集成)
7. [错误处理与降级方案](#错误处理与降级方案)

## 引言
weapp-vite框架提供了一套完整的懒加载策略，旨在优化小程序的启动速度和内存占用。该策略通过条件加载、按需加载和动态导入等技术手段，实现了资源的高效管理。本文档将深入探讨weapp-vite中懒加载机制的实现原理、配置方法、实际应用案例以及性能优化建议。

## 懒加载机制实现原理

weapp-vite的懒加载机制基于Vite和Rollup的构建能力，通过插件系统实现了对模块的智能分割和按需加载。核心机制包括：

1. **动态导入分析**：通过AST（抽象语法树）分析，识别代码中的`import()`表达式，将其转换为小程序支持的异步加载方式。
2. **分包策略**：利用小程序的分包功能，将应用拆分为多个独立的包，每个包可以独立加载。
3. **共享模块处理**：对于跨分包共享的模块，采用特定策略进行复制或提升，确保各分包能够正确引用。

在`packages/weapp-vite/src/runtime/chunkStrategy.ts`文件中，定义了共享模块的处理策略，包括`SHARED_CHUNK_VIRTUAL_PREFIX`和`SUB_PACKAGE_SHARED_DIR`等常量，用于标识和管理共享模块。

**Section sources**
- [chunkStrategy.ts](file://packages/weapp-vite/src/runtime/chunkStrategy.ts#L7-L9)

## 懒加载配置方法

### 页面懒加载配置
在`app.json`文件中，通过`subpackages`字段配置分包信息，实现页面级别的懒加载。例如：

```json
{
  "subpackages": [
    {
      "root": "packages/order",
      "name": "订单中心",
      "pages": ["index", "detail"]
    }
  ]
}
```

### 组件懒加载配置
组件懒加载通过`usingComponents`字段配置，指定需要懒加载的自定义组件路径。

### 资源懒加载配置
资源懒加载主要通过`preloadRule`字段配置预加载规则，以及`lazyCodeLoading`字段控制代码的懒加载行为。

在`apps/vite-native/app.json.ts`文件中，可以看到`lazyCodeLoading`配置为`requiredComponents`，表示仅加载必需的组件代码。

```typescript
export default <App>{
  // ...
  lazyCodeLoading: 'requiredComponents',
  // ...
}
```

**Section sources**
- [app.json.ts](file://apps/vite-native/app.json.ts#L60)
- [app.json](file://apps/subpackage-shared-chunks/src/app.json#L24-L31)

## 实际应用案例

### 按需加载业务逻辑
在`apps/subpackage-shared-chunks/src/packages/order/detail.ts`文件中，展示了如何通过`import()`动态加载业务逻辑模块：

```typescript
Page({
  async onLoad() {
    const { test3 } = await import('@/action/test3')
    test3()
  },
  onRefund() {
    wx.showModal({
      success: (res) => {
        if (res.confirm) {
          import('@/action/test4').then(({ test4 }) => {
            test4()
          })
        }
      },
    })
  },
})
```

### 分包与动态导入协同
在`apps/wevu-runtime-demo/src/subpackages/perf/pages/chunk/index.ts`文件中，展示了分包与动态导入的协同工作：

```typescript
definePage({
  setup() {
    async function run() {
      const { compute } = await import('../../../../utils/heavy')
      const out = compute(20000)
    }
    return { run }
  },
})
```

**Section sources**
- [detail.ts](file://apps/subpackage-shared-chunks/src/packages/order/detail.ts#L10-L40)
- [index.ts](file://apps/wevu-runtime-demo/src/subpackages/perf/pages/chunk/index.ts#L9-L12)

## 性能影响与优化建议

### 内存占用优化
通过懒加载策略，可以显著减少小程序启动时的内存占用。只有在需要时才加载相应的代码和资源，避免了一次性加载大量不必要的内容。

### 启动速度提升
懒加载能够有效提升小程序的启动速度，特别是对于包含大量页面和组件的复杂应用。通过分包和预加载规则的合理配置，可以在保证用户体验的同时，最大限度地缩短启动时间。

### 优化建议
1. **合理划分分包**：根据业务模块的使用频率和关联性，合理划分分包，避免过度拆分导致管理复杂。
2. **配置预加载规则**：利用`preloadRule`字段，对高频使用的页面或组件进行预加载，提升用户体验。
3. **监控冗余体积**：通过`duplicateWarningBytes`配置，监控因复制共享模块产生的冗余体积，及时调整分包策略。

在`packages/weapp-vite/src/plugins/core.ts`文件中，提供了详细的日志输出和警告机制，帮助开发者监控和优化懒加载效果。

**Section sources**
- [core.ts](file://packages/weapp-vite/src/plugins/core.ts#L316-L320)

## 代码分割集成

weapp-vite的懒加载策略与代码分割紧密集成，通过`applySharedChunkStrategy`函数实现共享模块的智能处理。该函数根据配置的策略（`hoist`或`duplicate`），决定如何处理跨分包共享的模块。

当策略为`duplicate`时，共享模块会被复制到各个分包中；当策略为`hoist`时，共享模块会被提升到主包中。这种灵活的策略选择，使得开发者可以根据具体需求进行优化。

```typescript
applySharedChunkStrategy.call(this, bundle, {
  strategy: sharedStrategy,
  subPackageRoots,
  onDuplicate: handleDuplicate,
  onFallback: shouldLogChunks
    ? ({ reason, importers, sharedFileName, finalFileName }) => {
        // 日志输出逻辑
      }
    : undefined,
})
```

**Section sources**
- [core.ts](file://packages/weapp-vite/src/plugins/core.ts#L414-L450)

## 错误处理与降级方案

### 错误处理
在懒加载过程中，可能会遇到模块加载失败的情况。weapp-vite通过`onDuplicate`和`onFallback`回调函数，提供了详细的错误处理机制。开发者可以在这些回调中添加自定义的错误处理逻辑，如重试加载、显示错误提示等。

### 降级方案
当某些高级特性不被支持时，weapp-vite提供了降级方案。例如，当`lazyCodeLoading`配置不被支持时，系统会自动退回到传统的全量加载模式，确保应用的基本功能不受影响。

在`type.auto.ts`文件中，定义了`App`接口的`lazyCodeLoading`字段，为开发者提供了类型安全的配置支持。

```typescript
export interface App {
  // ...
  lazyCodeLoading?: string;
  // ...
}
```

**Section sources**
- [type.auto.ts](file://@weapp-core/schematics/src/type.auto.ts#L212)