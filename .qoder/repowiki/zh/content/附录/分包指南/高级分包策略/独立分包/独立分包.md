# 独立分包

<cite>
**本文档引用的文件**   
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
- [independent-subpackage.ts](file://apps/vite-native/subpackage-demos/independent-subpackage.ts)
- [subpackages.md](file://docs/subpackages.md)
- [subpackage.md](file://website/guide/subpackage.md)
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts)
- [buildPlugin.ts](file://packages/weapp-vite/src/runtime/buildPlugin.ts)
</cite>

## 目录
1. [引言](#引言)
2. [独立分包配置方法](#独立分包配置方法)
3. [依赖关系处理机制](#依赖关系处理机制)
4. [资源重复打包避免策略](#资源重复打包避免策略)
5. [路由配置最佳实践](#路由配置最佳实践)
6. [构建与发布流程](#构建与发布流程)
7. [微信开发者工具调试技巧](#微信开发者工具调试技巧)
8. [总结](#总结)

## 引言
独立分包是微信小程序中一种特殊的分包类型，它拥有独立的运行环境和依赖体系，能够实现业务模块的完全隔离。通过合理配置独立分包，可以有效降低主包体积，提升小程序启动速度，并实现团队间的并行开发。本文档将详细介绍如何在 `weapp-vite` 构建体系下配置和使用独立分包。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L1-L151)

## 独立分包配置方法
在 `vite.config.ts` 文件中，通过 `weapp.subPackages` 配置项来定义独立分包。需要为特定分包设置 `independent: true` 来启用独立分包模式。例如，在 `apps/vite-native/vite.config.ts` 中，`packageB` 被配置为独立分包：

```ts
weapp: {
  subPackages: {
    packageB: {
      dependencies: [
        'tdesign-miniprogram',
        'miniprogram-computed',
      ],
      independent: true,
    },
  },
}
```

此配置确保 `packageB` 在独立的 Rolldown 上下文中进行打包，不与主包共享依赖。同时，可以通过 `dependencies` 字段精确声明该分包所需的 npm 依赖，避免主包依赖泄漏到独立分包中。

**Section sources**
- [vite.config.ts](file://apps/vite-native/vite.config.ts#L89-L100)
- [subpackage.md](file://website/guide/subpackage.md#L151-L158)

## 依赖关系处理机制
独立分包与主包之间是完全隔离的，这意味着独立分包不能直接依赖主包或其他分包中的内容，包括 JS 文件、模板、样式、自定义组件和插件等。这种隔离性通过在不同的 Rolldown 上下文中进行打包来实现。

在构建过程中，每个独立分包都会生成独立的 `miniprogram_npm` 目录，只包含其自身声明的依赖。主包中的全局样式（如 `app.wxss`）对独立分包无效，因此独立分包需要自行管理其样式依赖。`App` 对象只能在主包内定义，独立分包中不能定义 `App`，否则会导致不可预期的行为。

**Section sources**
- [subpackage.md](file://website/guide/subpackage.md#L153-L158)
- [buildPlugin.ts](file://packages/weapp-vite/src/runtime/buildPlugin.ts#L59-L105)

## 资源重复打包避免策略
为了避免资源重复打包，`weapp-vite` 提供了 `weapp.chunks.sharedStrategy` 配置项来控制共享模块的输出策略。默认策略为 `duplicate`，即跨分包共享的模块会被复制到各个分包的 `__shared__/common.js` 中，以避免分包首次打开时回主包拉取共享模块。

如果更关注整体包体控制，可以将策略设置为 `hoist`，这样跨分包共享的模块会被统一提炼到主包的 `common.js` 中。此外，还可以通过 `weapp.subPackages[].styles` 配置项来共享样式文件，声明一次主题、设计令牌或基础布局，普通分包与独立分包都会在生成样式时自动插入对应的共享入口，从而避免样式代码的重复。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L15-L16)
- [subpackage.md](file://website/guide/subpackage.md#L32-L38)

## 路由配置最佳实践
为了确保分包间跳转的顺畅性，需要在 `app.json` 中正确配置分包的 `root` 和 `pages` 字段。独立分包的页面路径应相对于其根目录，且不能直接引用其他分包的页面。

在进行分包间跳转时，应使用完整的页面路径。例如，从主包跳转到 `packageB` 的 `index` 页面，应使用路径 `/packageB/pages/index/index`。建议使用 `weapp-vite` 的自动路由功能（`autoRoutes: true`），它可以自动生成路由配置，减少手动配置的错误。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L36-L54)
- [subpackage.md](file://website/guide/subpackage.md#L19-L27)

## 构建与发布流程
独立分包的构建流程与普通分包类似，但在构建时会为每个独立分包创建独立的 Rolldown 上下文。构建命令会先处理主包，然后依次处理各个独立分包。

在发布流程中，独立分包会作为独立的包体上传到微信服务器。由于独立分包可以独立运行，因此即使主包更新失败，已发布的独立分包仍然可以正常访问。建议在 CI/CD 流程中为独立分包设置独立的构建和发布任务，以便更好地控制发布节奏。

**Section sources**
- [buildPlugin.ts](file://packages/weapp-vite/src/runtime/buildPlugin.ts#L63-L105)
- [subpackages.ts](file://packages/weapp-vite/src/analyze/subpackages.ts#L523-L537)

## 微信开发者工具调试技巧
在微信开发者工具中调试独立分包时，需要注意以下几点：
1. 确认 `app.json` 中的 `independent: true` 是否与 `vite.config.ts` 中的 `weapp.subPackages` 配置保持一致。
2. 利用 `weapp.debug.watchFiles` 查看产物位置，确认独立分包是否生成了独立的 `miniprogram_npm` 目录。
3. 如果分包引用到了主包路径，构建会报错提示，需要及时调整引用方式或拆分公共模块。
4. 使用 `pnpm run analyze` 命令分析产物布局，可以快速核对哪些源码最终落到了主包、分包或共享 chunk 中。

**Section sources**
- [subpackage.md](file://website/guide/subpackage.md#L203-L205)
- [subpackages.md](file://docs/subpackages.md#L139-L142)

## 总结
通过合理配置独立分包，可以实现小程序业务模块的完全隔离，提升开发效率和用户体验。关键在于正确使用 `vite.config.ts` 中的 `weapp.subPackages` 配置项，精确控制独立分包的依赖和构建行为。同时，利用 `weapp-vite` 提供的分析工具，可以有效避免资源重复打包，优化整体包体结构。

**Section sources**
- [subpackages.md](file://docs/subpackages.md#L144-L151)
- [subpackage.md](file://website/guide/subpackage.md#L237-L238)