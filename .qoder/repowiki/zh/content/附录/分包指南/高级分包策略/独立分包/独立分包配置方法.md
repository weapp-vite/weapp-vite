# 独立分包配置方法

<cite>
**本文档引用文件**  
- [vite.config.ts](file://apps/vite-native/vite.config.ts)
- [vite.config.ts](file://apps/subpackage-shared-chunks/vite.config.ts)
- [subpackages.md](file://docs/subpackages.md)
- [subpackage.md](file://website/guide/subpackage.md)
- [subpackages.config.md](file://website/config/subpackages.md)
- [app.json.ts](file://packages/weapp-vite/test/fixtures/watch/src/app.json.ts)
- [app.json.ts](file://packages/weapp-vite/test/fixtures/subPackages/src/app.json.ts)
- [scanPlugin.ts](file://packages/weapp-vite/src/runtime/scanPlugin.ts)
- [buildPlugin.ts](file://packages/weapp-vite/src/runtime/buildPlugin.ts)
</cite>

## 目录
1. [引言](#引言)
2. [独立分包配置基础](#独立分包配置基础)
3. [vite.config.ts中subpackages配置详解](#viteconfigts中subpackages配置详解)
4. [independent字段的作用与设置](#independent字段的作用与设置)
5. [root配置与分包根路径](#root配置与分包根路径)
6. [常见配置错误与解决方案](#常见配置错误与解决方案)
7. [配置最佳实践](#配置最佳实践)
8. [总结](#总结)

## 引言

微信小程序的独立分包机制允许开发者将应用拆分为多个独立的模块，每个模块可以独立运行，从而优化首屏加载速度和包体大小。`weapp-vite` 工具通过 `vite.config.ts` 文件中的 `subPackages` 配置项，提供了灵活的分包编译选项，支持独立分包、依赖裁剪、样式共享等高级功能。本文将详细介绍如何在 `vite.config.ts` 中配置独立分包，包括定义分包的根目录、入口文件和资源路径，以及如何通过 `independent` 字段和 `root` 配置来实现分包的独立性。

**本节内容不涉及具体源文件分析，因此无需添加源文件引用。**

## 独立分包配置基础

独立分包是微信小程序中的一种特殊分包类型，它与主包和其他分包完全隔离，拥有独立的运行上下文。这意味着独立分包不能直接访问主包或其他分包中的内容，包括 JS 文件、模板、样式、自定义组件和插件等。这种隔离性使得独立分包可以独立开发、测试和部署，非常适合大型项目中的模块化开发。

在 `weapp-vite` 中，独立分包的配置主要通过 `vite.config.ts` 文件中的 `weapp.subPackages` 选项来实现。该选项允许开发者为每个分包指定独立的编译配置，包括是否为独立分包、需要的 npm 依赖、构建配置、自动导入组件策略以及共享样式等。

**本节内容不涉及具体源文件分析，因此无需添加源文件引用。**

## vite.config.ts中subpackages配置详解

在 `vite.config.ts` 文件中，`weapp.subPackages` 是一个对象，其键名为分包在 `app.json` 中的 `root` 路径，值为该分包的配置对象。配置对象包含多个字段，用于控制分包的编译行为。

### 配置示例

```ts
import { defineConfig } from 'weapp-vite/config'

export default defineConfig({
  weapp: {
    subPackages: {
      'packages/order': {
        independent: true,
        dependencies: ['crypto-es'],
        autoImportComponents: {
          globs: ['packages/order/components/**/*.wxml'],
        },
        styles: [
          'styles/theme.scss',
          {
            source: '../shared/styles/components.scss',
            scope: 'components',
            include: ['components/**'],
          },
        ],
      },
      'packages/profile': {
        styles: {
          source: 'styles/index.scss',
          scope: 'pages',
        },
      },
    },
  },
})
```

### 字段说明

- **independent**: 布尔值，表示该分包是否为独立分包。如果设置为 `true`，则该分包将在独立的上下文中进行编译，不与主包或其他分包共享依赖。
- **dependencies**: 数组，指定该分包需要的 npm 依赖。这些依赖将被包含在分包的 `miniprogram_npm` 目录中，避免主包依赖泄漏到独立分包。
- **autoImportComponents**: 对象，用于配置自动导入组件的策略。可以通过 `globs` 字段指定需要自动导入的组件路径。
- **styles**: 字符串或对象数组，用于指定分包需要的共享样式文件。可以是相对路径或对象形式，对象形式支持 `source`、`scope`、`include` 和 `exclude` 字段，以精确控制样式的注入范围。

**本节内容不涉及具体源文件分析，因此无需添加源文件引用。**

## independent字段的作用与设置

`independent` 字段是 `weapp.subPackages` 配置中的关键字段之一，用于指定分包是否为独立分包。当 `independent` 设置为 `true` 时，该分包将在独立的上下文中进行编译，不与主包或其他分包共享依赖。这有助于减少主包的体积，并提高分包的独立性和可维护性。

### 作用

- **独立上下文**: 独立分包拥有独立的运行上下文，不能直接访问主包或其他分包中的内容。
- **依赖隔离**: 独立分包的依赖被隔离在自己的 `miniprogram_npm` 目录中，避免主包依赖泄漏到独立分包。
- **独立构建**: 独立分包的构建过程与其他分包分离，可以在不同的 Rolldown 上下文中进行编译。

### 设置方法

在 `vite.config.ts` 文件中，通过 `weapp.subPackages` 配置对象的 `independent` 字段来设置分包的独立性。例如：

```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packageB': {
        independent: true,
        dependencies: ['buffer', /gm-crypto/],
        inlineConfig: {
          define: {
            'import.meta.env.PACKAGE_B': JSON.stringify(true),
          },
        },
      },
    },
  },
})
```

在这个示例中，`packageB` 分包被设置为独立分包，其依赖 `buffer` 和 `gm-crypto` 将被包含在 `packageB` 的 `miniprogram_npm` 目录中，而不会影响主包或其他分包。

**本节内容不涉及具体源文件分析，因此无需添加源文件引用。**

## root配置与分包根路径

`root` 配置是 `app.json` 文件中 `subPackages` 数组中的一个字段，用于指定分包的根目录。在 `vite.config.ts` 文件中，`weapp.subPackages` 的键名对应于 `app.json` 中的 `root` 路径。通过 `root` 配置，可以明确指定分包的根路径，确保分包的文件结构和资源路径正确无误。

### 作用

- **路径映射**: `root` 配置确保分包的文件路径与 `app.json` 中的定义一致，避免路径错误。
- **资源管理**: 通过 `root` 配置，可以更好地管理分包内的资源文件，如图片、样式和脚本等。

### 设置方法

在 `app.json` 文件中，`subPackages` 数组中的每个对象都包含一个 `root` 字段，用于指定分包的根路径。例如：

```json
{
  "subPackages": [
    {
      "root": "packages/order",
      "name": "订单中心",
      "pages": ["index", "detail"],
      "independent": true
    }
  ]
}
```

在 `vite.config.ts` 文件中，`weapp.subPackages` 的键名应与 `app.json` 中的 `root` 路径一致。例如：

```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packages/order': {
        independent: true,
        dependencies: ['crypto-es'],
        autoImportComponents: {
          globs: ['packages/order/components/**/*.wxml'],
        },
        styles: [
          'styles/theme.scss',
          {
            source: '../shared/styles/components.scss',
            scope: 'components',
            include: ['components/**'],
          },
        ],
      },
    },
  },
})
```

在这个示例中，`packages/order` 分包的根路径被设置为 `packages/order`，确保分包内的文件路径与 `app.json` 中的定义一致。

**本节内容不涉及具体源文件分析，因此无需添加源文件引用。**

## 常见配置错误与解决方案

在配置独立分包时，可能会遇到一些常见的错误，如路径错误、配置格式问题等。以下是一些常见错误及其解决方案。

### 路径错误

**问题**: 分包的 `root` 路径与实际文件路径不一致，导致构建失败或资源无法正确加载。

**解决方案**: 确保 `app.json` 中的 `root` 路径与实际文件路径一致。例如，如果分包的实际路径是 `src/packages/order`，则 `app.json` 中的 `root` 应设置为 `src/packages/order`。

### 配置格式问题

**问题**: `vite.config.ts` 文件中的配置格式不正确，导致构建工具无法解析配置。

**解决方案**: 确保 `vite.config.ts` 文件中的配置格式符合 `weapp-vite` 的要求。例如，`subPackages` 配置对象的键名应为字符串，值为对象，且对象中的字段类型应正确。

### 依赖冲突

**问题**: 主包和独立分包之间存在依赖冲突，导致构建失败或运行时错误。

**解决方案**: 使用 `dependencies` 字段精确控制每个分包需要的 npm 依赖，避免主包依赖泄漏到独立分包。例如：

```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packageB': {
        independent: true,
        dependencies: ['buffer', /gm-crypto/],
      },
    },
  },
})
```

### 样式共享问题

**问题**: 分包的样式文件无法正确加载或应用。

**解决方案**: 使用 `styles` 字段指定分包需要的共享样式文件，并确保文件路径正确。例如：

```ts
export default defineConfig({
  weapp: {
    subPackages: {
      'packages/order': {
        styles: [
          'styles/theme.scss',
          {
            source: '../shared/styles/components.scss',
            scope: 'components',
            include: ['components/**'],
          },
        ],
      },
    },
  },
})
```

**本节内容不涉及具体源文件分析，因此无需添加源文件引用。**

## 配置最佳实践

为了确保独立分包配置的正确性和可维护性，以下是一些配置最佳实践。

### 保持主包最小化

- **原则**: 主包应仅包含必要的页面和基座逻辑，其余业务模块放入分包。
- **好处**: 减少主包体积，提高首屏加载速度。

### 以业务边界拆分

- **原则**: 分包根目录与域名一致，例如 `packages/order`、`packages/profile`，方便团队协作和权限划分。
- **好处**: 提高代码的可维护性和可读性。

### 评估独立性

- **原则**: 需要自定义 TabBar、插件能力或明显跨团队交付的模块优先考虑 `independent: true`。
- **好处**: 提高模块的独立性和可测试性。

### 同步规划代码共享

- **原则**: 公共工具、样式、国际化资源放在主包或公共目录，由构建器负责复制或抽取。
- **好处**: 避免代码重复，提高代码复用率。

### 配合运营节奏预下载

- **原则**: 首屏后立即可能访问的分包通过 `preloadRule` 预加载，结合 `network`、`packages` 精细控制。
- **好处**: 提高用户体验，减少用户等待时间。

### 利用异步化能力

- **原则**: 启用 `lazyCodeLoading` 与按需注册组件，让非首屏模块按需拉取。
- **好处**: 降低首包体积，提高首次渲染开销。

**本节内容不涉及具体源文件分析，因此无需添加源文件引用。**

## 总结

通过 `vite.config.ts` 文件中的 `subPackages` 配置项，`weapp-vite` 提供了灵活的独立分包配置能力。合理规划分包并结合 `weapp-vite` 的构建能力，可以在保证首屏体验的同时降低维护成本。遇到复杂场景时，优先使用 CLI 分析产物，再针对性调整 `app.json` 与 `vite.config.ts` 配置。

**本节内容不涉及具体源文件分析，因此无需添加源文件引用。**