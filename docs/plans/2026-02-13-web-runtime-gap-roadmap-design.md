# Web Runtime 缺口补齐路线图设计（2026-02-13）

## 背景

当前 `weapp-vite` 的 Web 端链路已经可用：`--platform h5` 可触发 Web 目标解析，`weapp.web` 可注入 `@weapp-vite/web` 插件并启动独立 dev/build 流程。但定位仍是预览/调试能力，尚未达到“高兼容、可交付”的目标。

从现状看，核心缺口集中在四类：

- API 兼容层偏窄（`wx` 仅覆盖路由与导航栏相关能力）。
- 组件选项与模板事件映射仍是最小实现。
- Web 端测试更偏编译产物校验，浏览器交互 E2E 覆盖不足。
- 文档存在能力漂移，容易误导使用者与贡献者。

目标不是一次性“重写成跨端大框架”，而是在保持当前实现成本可控的前提下，给出一条可连续交付、可验证回归的推进路线。

## 目标与非目标

### 目标

- 建立公开、可维护的 Web 兼容矩阵（模板语法、组件选项、`wx` API）。
- 将高频运行时能力从“可演示”提升到“可稳定使用”。
- 建立浏览器侧 E2E 基线，覆盖关键交互路径而非仅编译输出。
- 对齐文档、类型、示例，减少认知成本与误用。

### 非目标

- 不追求短期内 100% 小程序 API 全覆盖。
- 不在本阶段引入重量级新渲染内核替换 `lit` 与当前编译链。
- 不将 Web 端定位升级为“真机行为等价”。

## 推进方案对比

### 方案 A：API 先行

先扩 `wx` API，再补测试与文档。

优点：

- 业务感知最快。
- 可快速覆盖 demo/真实项目中的直观报错点。

缺点：

- 缺少统一矩阵与回归基线，后续易反复回归。
- 容易变成“哪里报错补哪里”的被动维护。

### 方案 B：基线先行（推荐）

先做“兼容矩阵 + 浏览器 E2E 基线 + 文档对齐”，再按频率扩 API 和组件能力。

优点：

- 需求边界与验收标准稳定，便于多人协作。
- 每次新增能力都能挂到矩阵和测试基线上，长期成本更低。

缺点：

- 首批交付不是新增 API 数量，而是基础设施与治理能力。

### 方案 C：全量重构

直接规划大版本，统一重构 runtime/compiler/API。

优点：

- 理论上可一次性解决历史包袱。

缺点：

- 迭代周期长，风险高，回归成本大，不符合当前节奏。

结论：采用方案 B，并在 B 内嵌入“小步 API 补齐”的节奏。

## 分阶段路线图（推荐）

### Phase 1：能力对齐与基线建立（1-2 周）

交付项：

- 新增 Web 兼容矩阵文档（模板语法、组件选项、`wx` API，标注 `supported/partial/unsupported`）。
- 对齐文档漂移：`README`、`website/config/web.md`、demo 说明保持一致。
- 建立浏览器 E2E 最小框架（建议基于 Playwright），先覆盖 `weapp-vite-web-demo` 的关键路径。

验收标准：

- 兼容矩阵在 CI 中可被链接校验（至少保证文档存在、格式稳定）。
- 文档示例字段与实际类型一致。
- E2E 至少覆盖：页面路由、组件事件、`setData` 驱动渲染、导航栏 API。

### Phase 2：高频能力补齐（2-3 周）

交付项：

- 扩展 `wx` API 的高频集合（优先级按 demo 与仓库真实调用频次排序）。
- 扩展组件选项最小闭环（先补常见且低风险项，避免一次性摊大）。
- 统一事件映射表，补齐高频手势/输入事件别名与 flags 行为。

验收标准：

- 每个新增 API 都有单测 + 浏览器 E2E 场景。
- 兼容矩阵同步更新；未支持项必须明确写出降级行为。
- `@weapp-vite/web` 测试保持全绿，且新增测试不依赖手工环境。

### Phase 3：执行模型与稳定性增强（2 周+）

交付项：

- 评估模板表达式/WXS 执行边界，提供 `strict` 或 `safe` 模式开关（可选）。
- 补充运行时告警分级与可观测信息（一次告警、上下文定位、可关闭策略）。
- 针对 HMR、热更新后的页面状态保留补强回归用例。

验收标准：

- 针对表达式异常、WXS 执行异常有稳定可预期的错误输出。
- 告警去重与上下文信息在开发体验上可用。

## 任务拆解（可直接转 Issue）

### P0（必须优先）

1. `web` 兼容矩阵文档落地与维护规则

- 产物：`docs/guide/web-compat-matrix.md`
- 验收：覆盖模板语法、组件选项、`wx` API 三个维度。

2. 文档与类型示例对齐

- 目标：清理 `website/config/web.md` 与 `WeappWebPluginOptions` 的示例偏差。
- 验收：文档示例字段可在代码中找到对应类型与行为。

3. 浏览器 E2E 基线（demo）

- 目标：新增针对 `apps/weapp-vite-web-demo` 的端到端交互回归。
- 验收：路由、事件、数据更新、导航栏四类场景稳定通过。

### P1（高价值）

4. 高频 `wx` API 补齐第一批

- 建议候选：`showToast`、`setClipboardData`、`getSystemInfoSync`（以实际调用频次为准）。
- 验收：兼容矩阵更新 + 单测 + E2E。

5. 组件选项兼容第一批

- 建议候选：`options` 中与 Web 行为强相关的条目、`pageLifetimes`（若实现成本可控）。
- 验收：明确支持边界，不支持项给出 warning 与降级策略。

6. 事件映射表升级

- 目标：从单一别名扩展为表驱动，并补充测试矩阵。
- 验收：常见 `bind/catch/capture` 组合行为可验证。

### P2（持续优化）

7. 表达式/WXS 安全执行策略设计与 PoC

- 目标：在不破坏现有能力的前提下降低动态执行风险。
- 验收：给出可选模式、兼容性影响、迁移建议。

8. Web 分析命令能力评估

- 目标：评估 `analyze` 对 Web 的最小支持范围（可先只做静态信息）。
- 验收：明确“支持什么/不支持什么”，避免误导。

## 测试策略

- 单元测试：继续放在 `packages/web/test` 与 `packages/weapp-vite/test`，新增能力必须有“正常路径 + 降级路径 + 警告路径”。
- 集成测试：保持现有 build 产物校验，补充对 Web 输出与入口注入的断言。
- 浏览器 E2E：以 `weapp-vite-web-demo` 作为金丝雀项目，覆盖用户真实交互链路。
- 回归门禁：`pnpm --filter @weapp-vite/web test` 与 Web 相关 vitest/e2e 套件纳入 CI 必跑集合。

## 风险与应对

- 风险：API 补齐速度快于测试建设，导致回归频繁。
- 应对：强制“矩阵更新 + 测试用例”与实现同 PR。

- 风险：文档再次漂移。
- 应对：将矩阵作为唯一能力声明源，README/website 均引用矩阵。

- 风险：执行模型安全改造影响兼容性。
- 应对：引入可选模式与灰度开关，不直接替换默认行为。

## 建议起步顺序

1. 先做 P0-1 和 P0-2（同一 PR 可完成）。
2. 紧接着做 P0-3（浏览器 E2E 基线）。
3. 在基线稳定后进入 P1（每次只推进一批能力，避免过大 PR）。
